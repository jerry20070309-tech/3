<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>V15 QUANT ENGINE</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#050505;color:#d4d4d8;font-family:'Courier New',monospace;font-size:13px}
.top-panel{padding:14px 18px;border-bottom:1px solid #1a1a1a;background:#0a0a0c;display:flex;flex-wrap:wrap;gap:12px;align-items:center}
.top-panel input{background:#111;border:1px solid #333;color:#d4d4d8;padding:6px 10px;border-radius:4px;width:200px}
.btn{padding:6px 14px;border:none;border-radius:4px;cursor:pointer;font-family:monospace;font-size:13px;font-weight:bold}
.btn-green{background:#16a34a;color:#fff}
.btn-red{background:#dc2626;color:#fff}
.btn-gray{background:#374151;color:#d4d4d8}
.btn-yellow{background:#92400e;color:#fcd34d}
.status-bar{padding:10px 18px;border-bottom:1px solid #1a1a1a;background:#0d0d10;display:flex;gap:20px;flex-wrap:wrap}
.stat{display:flex;flex-direction:column;gap:2px}
.stat-label{font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1px}
.stat-value{font-size:14px;font-weight:bold}
.score-bar{padding:8px 18px;border-bottom:1px solid #1a1a1a;background:#0a0a0c;display:flex;gap:20px;flex-wrap:wrap;align-items:center}
.score-bar span{font-size:13px}
.STRONG-txt{color:#22c55e}
.BREAK-txt{color:#3b82f6}
.BUILD-txt{color:#f59e0b}
.RADAR-txt{color:#a855f7}
.IDLE-txt{color:#444}
#cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;padding:14px}
.card{background:#0f0f11;border:1px solid #222;border-radius:6px;padding:12px;transition:border .2s}
.card.STRONG{border:2px solid #22c55e;background:#080e08}
.card.BREAK{border:2px solid #3b82f6;background:#080a10}
.card.BUILD{border:2px solid #f59e0b;background:#100d04}
.card.RADAR{border:2px solid #a855f7;background:#0c0810}
.card.IDLE{border:1px solid #1e1e1e}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.card-symbol{font-size:15px;font-weight:bold;letter-spacing:.5px}
.card-state{font-size:11px;padding:2px 7px;border-radius:3px;font-weight:bold}
.state-STRONG{background:#14532d;color:#86efac}
.state-BREAK{background:#1e3a5f;color:#93c5fd}
.state-BUILD{background:#451a03;color:#fcd34d}
.state-RADAR{background:#2e1065;color:#c4b5fd}
.state-IDLE{background:#1a1a1a;color:#555}
.card-score{font-size:24px;font-weight:bold;margin-bottom:6px}
.score-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:2px 6px;font-size:11px;color:#888;margin-bottom:8px}
.score-item{display:flex;justify-content:space-between;gap:4px}
.score-item .sv{color:#d4d4d8;font-weight:bold}
.divider{border:none;border-top:1px solid #1e1e1e;margin:6px 0}
.card-risk{font-size:11px;display:grid;grid-template-columns:1fr 1fr;gap:3px}
.card-risk .rl{color:#888}
.card-risk .rv{color:#d4d4d8;font-weight:bold}
.tp-row{font-size:11px;color:#22c55e;margin-top:4px}
.sl-row{font-size:11px;color:#ef4444;margin-top:2px}
.alert-exit{color:#ef4444;font-weight:bold;font-size:11px;margin-top:4px;padding:3px 6px;background:#200808;border-radius:3px}
.trail-row{color:#f59e0b;font-size:11px;margin-top:4px}
.lock-badge{font-size:10px;color:#555;margin-top:2px}
.cd-badge{font-size:10px;color:#3b82f6;margin-top:2px}
.log-panel{position:fixed;bottom:0;left:0;right:0;height:120px;background:#050505;border-top:1px solid #1a1a1a;overflow-y:auto;padding:6px 14px;font-size:11px}
.log-line{padding:1px 0;border-bottom:1px solid #0d0d0d}
.log-line.info{color:#4b7fa8}
.log-line.warn{color:#a87a2a}
.log-line.signal{color:#22c55e;font-weight:bold}
.log-line.exit{color:#ef4444;font-weight:bold}
.log-line.tp{color:#a855f7;font-weight:bold}
.log-line.err{color:#7f1d1d}
.spacer{height:130px}
</style>
</head>
<body>

<div class="top-panel">
  <button class="btn btn-green" onclick="startEngine()">â–¶ é–‹å§‹æƒæ</button>
  <button class="btn btn-red" onclick="stopEngine()">â–  åœæ­¢</button>
  <input id="tgToken" placeholder="Telegram Bot Token">
  <input id="tgChat" placeholder="Chat ID">
  <button class="btn btn-gray" onclick="testPush()">æ¸¬è©¦æ¨æ’­</button>
  <button class="btn btn-yellow" onclick="clearLocks()">æ¸…é™¤é–å®š</button>
</div>

<div class="status-bar">
  <div class="stat"><span class="stat-label">å¼•æ“</span><span class="stat-value" id="engSt" style="color:#ef4444">OFF</span></div>
  <div class="stat"><span class="stat-label">ç›£æ§å¹£æ•¸</span><span class="stat-value" id="uniCnt">0</span></div>
  <div class="stat"><span class="stat-label">WSç‹€æ…‹</span><span class="stat-value" id="wsSt" style="color:#ef4444">â€”</span></div>
  <div class="stat"><span class="stat-label">è¼ªæ›¿å€’æ•¸</span><span class="stat-value" id="rotTmr">â€”</span></div>
  <div class="stat"><span class="stat-label">æœ€å¾Œæ›´æ–°</span><span class="stat-value" id="lastUpd">â€”</span></div>
  <div class="stat"><span class="stat-label">REST/åˆ†</span><span class="stat-value" id="reqR">0</span></div>
</div>

<div class="score-bar">
  <span class="STRONG-txt" id="cS">STRONG:0</span>
  <span class="BREAK-txt" id="cB">BREAK:0</span>
  <span class="BUILD-txt" id="cBu">BUILD:0</span>
  <span class="RADAR-txt" id="cR">RADAR:0</span>
  <span class="IDLE-txt" id="cI">IDLE:0</span>
  <span style="color:#666;margin-left:12px;font-size:11px">é€²å ´é–€æª»: <span id="thrLabel" style="color:#f59e0b">BUILD(65åˆ†)</span></span>
  <button class="btn btn-gray" style="font-size:11px;padding:3px 8px" onclick="cycleThr()">åˆ‡æ›é–€æª»</button>
</div>

<div id="cards"></div>
<div class="spacer"></div>
<div class="log-panel" id="logPanel"></div>

<script>
'use strict'
///////////////////////////////////////////////////////////////
// V15 QUANT ENGINE
// ä¸»è¦æ”¹å‹•ï¼š
//  1. é€²å ´é–€æª»é™ä½ + å¯åˆ‡æ›ï¼ˆRADAR/BUILD/BREAK/STRONGï¼‰
//  2. pushLock åŠ å†·å»é‡ç½®æ©Ÿåˆ¶ï¼ˆåˆ†æ•¸ä¸‹é™å¾Œè§£é–ï¼Œå¯å†æ¨ï¼‰
//  3. æ­¢æï¼š1må‰30æ ¹æˆäº¤é‡å¯†é›†å€åº•éƒ¨ï¼ˆVPOCåº•éƒ¨æ”¯æ’ï¼‰
//  4. æ­¢ç›ˆTP1ï¼šé ‚éƒ¨å£“åŠ›ä½ï¼ˆè¿‘30æ ¹1mé«˜é»å¯†é›†å€é ‚éƒ¨ï¼‰
//     æ­¢ç›ˆTP2ï¼š1må¹³å‡ATR Ã— å€æ•¸ï¼ˆå‹•æ…‹ç›®æ¨™ï¼‰
//  5. å‡ºå ´æ¢ä»¶é¬†ç¶ï¼š2æ¢æˆç«‹å³å‡ºï¼ˆåŸ3æ¢å…¨æˆç«‹ï¼‰
//  6. ç§»å‹•æ­¢æåŠ é€Ÿï¼šæµ®ç›ˆ5%ç§»æˆæœ¬ï¼Œ10%ç§»+3%ï¼Œ20%ç§»+8%
///////////////////////////////////////////////////////////////

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¼•æ“è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ENGINE={
    running:false,
    universeSize:30,
    rotationInterval:30*60*1000,
    reconnectDelay:5000,
    oiQueueInterval:800,
    strategyInterval:3000,
    uiInterval:2000,
    historyBars:300,
    minBars15:100,
    minBars1:50,
    maxStreamPerWS:180,
    stopMinDist:0.5,       // æ­¢æè·é›¢æœ€å°å€¼%ï¼ˆé™ä½é–€æª»ï¼‰
    riskPct:1,             // æ¯ç­†å›ºå®šé¢¨éšª%
    // ç§»å‹•æ­¢æä¸‰æ®µ
    trail1Pct:5,           // æµ®ç›ˆ5% â†’ æ­¢æåˆ°æˆæœ¬
    trail2Pct:10,          // æµ®ç›ˆ10% â†’ æ­¢æåˆ°+3%
    trail2Loc:3,
    trail3Pct:20,          // æµ®ç›ˆ20% â†’ æ­¢æåˆ°+8%
    trail3Loc:8,
    // æ­¢ç›ˆATRå€æ•¸
    tpAtrMult:3.0,         // TP2 = é€²å ´åƒ¹ + ATRÃ—3
    // æ¨æ’­å†·å»ï¼šåˆ†æ•¸æ‰å‡ºç›®æ¨™å€å¾Œå¯é‡æ–°è§£é–
    pushCooldownBars:20,   // ç­–ç•¥è¼ªæ¬¡è·‘20æ¬¡å¾Œä¸”åˆ†æ•¸é‡æ–°é”æ¨™æ‰é‡æ¨
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é€²å ´é–€æª»ï¼ˆå¯åˆ‡æ›ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const THR_LEVELS=[
    {label:'RADAR(55åˆ†)',  score:55},
    {label:'BUILD(70åˆ†)',  score:70},
    {label:'BREAK(85åˆ†)',  score:85},
    {label:'STRONG(100åˆ†)',score:100},
]
let thrIdx=1   // é è¨­ BUILD
function cycleThr(){
    thrIdx=(thrIdx+1)%THR_LEVELS.length
    document.getElementById('thrLabel').textContent=THR_LEVELS[thrIdx].label
    log(`é€²å ´é–€æª»åˆ‡æ›ç‚º ${THR_LEVELS[thrIdx].label}`,'warn')
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ’é™¤å¤§å¹£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EXCLUDED_TOP35=new Set([
"BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT",
"ADAUSDT","DOGEUSDT","AVAXUSDT","TRXUSDT","DOTUSDT",
"MATICUSDT","LTCUSDT","LINKUSDT","BCHUSDT","ATOMUSDT",
"UNIUSDT","ETCUSDT","XLMUSDT","FILUSDT","APTUSDT",
"ARBUSDT","OPUSDT","NEARUSDT","INJUSDT","STXUSDT",
"RUNEUSDT","SUIUSDT","SEIUSDT","TIAUSDT","GALAUSDT",
"SANDUSDT","MANAUSDT","AAVEUSDT","MKRUSDT","SNXUSDT"
])

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…¨åŸŸç‹€æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let STREAM_SOCKETS=[]
let SYMBOL_POOL={}
let BTC_POOL={k15:[],k1:[],lastPrice:0}
let CURRENT_UNIVERSE=[]
let OI_QUEUE_IDX=0
let rotationLeft=ENGINE.rotationInterval
let reqCount=0,reqCountMin=0,lastReqReset=Date.now()
let rotationTimer=null,oiTimer=null,strategyTimer=null,uiTimer=null

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Symbol çµæ§‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createEmptySymbol(){
    return{
        lastPrice:0, quoteVolume:0,
        k15:[], k1:[],
        oi:0, prevOI:0, oiHistory:[],
        state:"IDLE", score:0, scoreDetails:{},
        // é¢¨æ§
        stopPrice:0,    // æ­¢æåƒ¹ï¼ˆæˆäº¤é‡å¯†é›†åº•éƒ¨ï¼‰
        stopDist:0,     // æ­¢æè·é›¢%
        tp1:0,          // æ­¢ç›ˆ1ï¼šå£“åŠ›ä½é ‚éƒ¨
        tp2:0,          // æ­¢ç›ˆ2ï¼šATRç›®æ¨™
        suggestLev:1,
        // å‡ºå ´è¿½è¹¤
        exitCheckOIDown:0,
        exitVolDown:false,
        exitNoNewHigh:false,
        lastHigh:0,
        whaleExit:false,
        exitReason:'',
        // æ¨æ’­æ§åˆ¶
        pushLock:false,
        pushCooldown:0,  // å†·å»è¨ˆæ•¸å™¨
        exitLock:false,
        // ç§»å‹•æ­¢æ
        inPosition:false,
        entryPrice:0,
        trailStage:0,
        currentStop:0,
        // é›œé …
        oiChange:0, volRatio:0,
        sym1hRet:0, btc1hRet:0,
        poc:0, pocResistance:0,
        atr1m:0,
    }
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ—¥èªŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAX_LOG=150
function log(msg,type='info'){
    let p=document.getElementById('logPanel')
    if(!p) return
    let d=document.createElement('div')
    d.className='log-line '+type
    d.textContent=`[${new Date().toTimeString().slice(0,8)}] ${msg}`
    p.insertBefore(d,p.firstChild)
    let ls=p.querySelectorAll('.log-line')
    if(ls.length>MAX_LOG) ls[ls.length-1].remove()
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è«‹æ±‚è¨ˆæ•¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function countReq(){
    reqCount++
    if(Date.now()-lastReqReset>60000){
        reqCountMin=reqCount; reqCount=0; lastReqReset=Date.now()
    }
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å®‰å…¨ fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function safeFetch(url,timeout=9000){
    countReq()
    let ctrl=new AbortController()
    let tid=setTimeout(()=>ctrl.abort(),timeout)
    try{
        let r=await fetch(url,{signal:ctrl.signal})
        clearTimeout(tid)
        if(!r.ok) throw new Error(`HTTP ${r.status}`)
        return await r.json()
    }catch(e){ clearTimeout(tid); throw e }
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å•Ÿå‹• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startEngine(){
    if(ENGINE.running){log('å·²åœ¨é‹è¡Œ','warn');return}
    ENGINE.running=true
    setEngUI(true)
    log('V15 å¼•æ“å•Ÿå‹•','info')
    try{ await buildUniverse() }
    catch(e){
        log('Universeå¤±æ•—:'+e.message,'err')
        ENGINE.running=false; setEngUI(false); return
    }
    await warmUpHistory()
    connectAllSockets()
    startOIQueue()

    rotationTimer=setInterval(async()=>{
        if(!ENGINE.running) return
        log('30åˆ†é˜è¼ªæ›¿','warn')
        rotationLeft=ENGINE.rotationInterval
        await rotateUniverse()
    },ENGINE.rotationInterval)

    strategyTimer=setInterval(()=>{
        if(!ENGINE.running) return
        CURRENT_UNIVERSE.forEach(s=>runStrategy(s))
    },ENGINE.strategyInterval)

    uiTimer=setInterval(()=>{
        if(!ENGINE.running) return
        renderCards(); updateStatusBar()
    },ENGINE.uiInterval)

    setInterval(()=>{
        if(!ENGINE.running) return
        rotationLeft=Math.max(0,rotationLeft-1000)
        let m=Math.floor(rotationLeft/60000),sc=Math.floor((rotationLeft%60000)/1000)
        document.getElementById('rotTmr').textContent=`${m}m ${sc}s`
    },1000)
}

function stopEngine(){
    ENGINE.running=false
    STREAM_SOCKETS.forEach(ws=>{try{ws.close()}catch(e){}})
    STREAM_SOCKETS=[]
    ;[rotationTimer,oiTimer,strategyTimer,uiTimer].forEach(t=>{if(t)clearInterval(t)})
    setEngUI(false)
    log('å¼•æ“åœæ­¢','warn')
}

function setEngUI(on){
    let el=document.getElementById('engSt')
    el.textContent=on?'ON':'OFF'
    el.style.color=on?'#22c55e':'#ef4444'
    document.getElementById('wsSt').textContent='â€”'
    document.getElementById('wsSt').style.color='#ef4444'
}

function clearLocks(){
    CURRENT_UNIVERSE.forEach(s=>{
        if(SYMBOL_POOL[s]){
            SYMBOL_POOL[s].pushLock=false
            SYMBOL_POOL[s].pushCooldown=0
            SYMBOL_POOL[s].exitLock=false
        }
    })
    log('æ¨æ’­é–å…¨æ¸…','warn')
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å»ºç«‹ Universe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function buildUniverse(){
    log('å–å¾—åˆç´„æ¸…å–®...','info')
    let [tickers,exInfo]=await Promise.all([
        safeFetch("https://fapi.binance.com/fapi/v1/ticker/24hr"),
        safeFetch("https://fapi.binance.com/fapi/v1/exchangeInfo")
    ])
    // åªä¿ç•™ PERPETUAL + TRADING + USDT
    let valid=new Set(), onboard={}
    ;(exInfo.symbols||[]).forEach(s=>{
        if(s.symbol.endsWith("USDT")&&s.contractType==="PERPETUAL"&&s.status==="TRADING"){
            valid.add(s.symbol)
            if(s.onboardDate) onboard[s.symbol]=s.onboardDate
        }
    })
    log(`æœ‰æ•ˆæ°¸çºŒåˆç´„ï¼š${valid.size}`,'info')
    let now=Date.now(), minAge=3*86400000
    let filtered=tickers
        .filter(t=>valid.has(t.symbol))
        .filter(t=>!EXCLUDED_TOP35.has(t.symbol))
        .filter(t=>{ let ob=onboard[t.symbol]; return !ob||(now-ob)>minAge })
        .filter(t=>parseFloat(t.quoteVolume)>5000000)
        .sort((a,b)=>parseFloat(b.quoteVolume)-parseFloat(a.quoteVolume))
        .slice(0,ENGINE.universeSize)
    CURRENT_UNIVERSE=filtered.map(t=>t.symbol)
    CURRENT_UNIVERSE.forEach(s=>{
        if(!SYMBOL_POOL[s]) SYMBOL_POOL[s]=createEmptySymbol()
        SYMBOL_POOL[s].quoteVolume=parseFloat(filtered.find(f=>f.symbol===s)?.quoteVolume||0)
    })
    OI_QUEUE_IDX=0
    log(`Universeï¼š${CURRENT_UNIVERSE.length}å¹£`,'info')
    document.getElementById('uniCnt').textContent=CURRENT_UNIVERSE.length
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é ç†± K ç·š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function warmUpHistory(){
    log('é ç†±Kç·š...','warn')
    const BATCH=5, DELAY=900
    try{
        let [b15,b1]=await Promise.all([
            safeFetch(`https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=15m&limit=200`),
            safeFetch(`https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=1m&limit=120`)
        ])
        BTC_POOL.k15=b15.map(pk); BTC_POOL.k1=b1.map(pk)
        BTC_POOL.lastPrice=BTC_POOL.k15.at(-1)?.close||0
        log('BTC Kç·šOK','info')
    }catch(e){log('BTC Kç·šå¤±æ•—','err')}
    for(let i=0;i<CURRENT_UNIVERSE.length;i+=BATCH){
        let batch=CURRENT_UNIVERSE.slice(i,i+BATCH)
        await Promise.all(batch.map(async sym=>{
            try{
                let [k15,k1]=await Promise.all([
                    safeFetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=15m&limit=200`),
                    safeFetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=1m&limit=120`)
                ])
                let s=SYMBOL_POOL[sym]; if(!s) return
                s.k15=k15.map(pk); s.k1=k1.map(pk)
                s.lastPrice=s.k15.at(-1)?.close||0
            }catch(e){ log(`${sym} é ç†±å¤±æ•—`,'err') }
        }))
        if(i+BATCH<CURRENT_UNIVERSE.length) await sleep(DELAY)
    }
    log('Kç·šé ç†±å®Œæˆ','info')
}

function pk(k){
    return{open:+k[1],high:+k[2],low:+k[3],close:+k[4],volume:+k[5]}
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¼ªæ›¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function rotateUniverse(){
    STREAM_SOCKETS.forEach(ws=>{try{ws.close()}catch(e){}})
    STREAM_SOCKETS=[]; CURRENT_UNIVERSE=[]
    try{
        await buildUniverse(); await warmUpHistory(); connectAllSockets()
    }catch(e){ log('è¼ªæ›¿å¤±æ•—:'+e.message,'err') }
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectAllSockets(){
    let streams=["btcusdt@kline_15m","btcusdt@kline_1m"]
    CURRENT_UNIVERSE.forEach(s=>{
        streams.push(`${s.toLowerCase()}@kline_15m`,`${s.toLowerCase()}@kline_1m`)
    })
    let chunks=[]
    for(let i=0;i<streams.length;i+=ENGINE.maxStreamPerWS)
        chunks.push(streams.slice(i,i+ENGINE.maxStreamPerWS))
    log(`å»ºç«‹${chunks.length}æ¢WSï¼Œå…±${streams.length}streams`,'info')
    chunks.forEach((c,i)=>openWS(c,i))
}

function openWS(streams,idx){
    let url="wss://fstream.binance.com/stream?streams="+streams.join("/")
    let ws=new WebSocket(url)
    STREAM_SOCKETS[idx]=ws
    ws.onopen=()=>{
        log(`WS[${idx}]é€£ç·š(${streams.length})`,'info')
        let el=document.getElementById('wsSt')
        el.textContent='LIVE'; el.style.color='#22c55e'
    }
    ws.onmessage=(e)=>{
        try{
            let msg=JSON.parse(e.data)
            let d=msg.data||msg
            if(d&&d.k) processKline(d)
        }catch(err){}
    }
    ws.onerror=()=>log(`WS[${idx}]éŒ¯èª¤`,'err')
    ws.onclose=()=>{
        let el=document.getElementById('wsSt')
        el.textContent='æ–·ç·š'; el.style.color='#f59e0b'
        log(`WS[${idx}]æ–·ç·šï¼Œé‡é€£ä¸­`,'warn')
        if(ENGINE.running) setTimeout(()=>{if(ENGINE.running)openWS(streams,idx)},ENGINE.reconnectDelay)
    }
}

function processKline(d){
    let sym=d.s, k=d.k
    let bar={open:+k.o,high:+k.h,low:+k.l,close:+k.c,volume:+k.v}
    if(sym==="BTCUSDT"){
        BTC_POOL.lastPrice=bar.close
        pushBar(BTC_POOL,k.i,bar); return
    }
    let s=SYMBOL_POOL[sym]; if(!s) return
    s.lastPrice=bar.close
    pushBar(s,k.i,bar)
    if(s.inPosition&&k.i==="1m"){
        if(bar.high>s.lastHigh) s.lastHigh=bar.high
        checkTrail(sym,bar.close)
    }
}

function pushBar(pool,interval,bar){
    let arr=interval==="15m"?pool.k15:interval==="1m"?pool.k1:null
    if(!arr) return
    arr.push(bar)
    if(arr.length>ENGINE.historyBars) arr.shift()
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ OI åºåˆ—è¼ªè©¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startOIQueue(){
    oiTimer=setInterval(async()=>{
        if(!ENGINE.running||!CURRENT_UNIVERSE.length) return
        let sym=CURRENT_UNIVERSE[OI_QUEUE_IDX%CURRENT_UNIVERSE.length]
        OI_QUEUE_IDX++
        try{
            let d=await safeFetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${sym}`)
            let s=SYMBOL_POOL[sym]; if(!s||!d?.openInterest) return
            s.prevOI=s.oi; s.oi=parseFloat(d.openInterest)
            s.oiHistory.push(s.oi)
            if(s.oiHistory.length>30) s.oiHistory.shift()
        }catch(e){}
    },ENGINE.oiQueueInterval)
}

//==============================================================
// æ•¸å­¸å·¥å…·
//==============================================================
function MA(data,n){
    if(data.length<n) return 0
    return data.slice(-n).reduce((a,b)=>a+b.close,0)/n
}
function getHigh(data,n){
    if(data.length<n) return 0
    return Math.max(...data.slice(-n).map(c=>c.high))
}
function getLow(data,n){
    if(data.length<n) return 0
    return Math.min(...data.slice(-n).map(c=>c.low))
}
function ATR(data,n){
    if(data.length<n+1) return 0
    let sum=0,cnt=0
    for(let i=Math.max(1,data.length-n);i<data.length;i++){
        let tr=Math.max(
            data[i].high-data[i].low,
            Math.abs(data[i].high-data[i-1].close),
            Math.abs(data[i].low-data[i-1].close)
        )
        sum+=tr; cnt++
    }
    return cnt?sum/cnt:0
}
function EMA(data,n){
    if(data.length<n) return 0
    let k=2/(n+1), ema=data[data.length-n].close
    for(let i=data.length-n+1;i<data.length;i++) ema=data[i].close*k+ema*(1-k)
    return ema
}
function slopeN(data,n){
    if(data.length<n) return 0
    let bars=data.slice(-n), mean=bars.reduce((a,b)=>a+b.close,0)/n
    let num=0,den=0
    bars.forEach((b,i)=>{num+=(i-(n-1)/2)*(b.close-mean);den+=(i-(n-1)/2)**2})
    return den?num/den:0
}

//==============================================================
// â˜… æˆäº¤é‡å¯†é›†å€ï¼ˆVolume Profileï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç”¨é€”ï¼š
//   calcVPOC(bars)  â†’ {poc, support, resistance}
//   poc        = æˆäº¤é‡æœ€å¤§åƒ¹æ ¼
//   support    = æˆäº¤é‡å¯†é›†å¸¶ã€Œåº•éƒ¨ã€ â†’ æ­¢æä½
//   resistance = æˆäº¤é‡å¯†é›†å¸¶ã€Œé ‚éƒ¨ã€ â†’ æ­¢ç›ˆåƒè€ƒ
// æ¼”ç®—æ³•ï¼š
//   1. æŠŠè¿‘Næ ¹Kç·šçš„é«˜ä½åƒ¹ç­‰åˆ†æˆBUCKETSå€‹åƒ¹æ ¼æ§½
//   2. æ¯æ ¹Kç·šçš„æˆäº¤é‡ä¾æ¯”ä¾‹åˆ†é…åˆ°è¦†è“‹çš„æ§½
//   3. æ‰¾å‡ºæˆäº¤é‡æœ€å¤§æ§½ï¼ˆPOCï¼‰
//   4. å¾€ä¸‹æ‰¾ç¬¬ä¸€å€‹æˆäº¤é‡<å‡é‡50%çš„æ§½ â†’ æ”¯æ’åº•éƒ¨
//   5. å¾€ä¸Šæ‰¾ç¬¬ä¸€å€‹æˆäº¤é‡<å‡é‡50%çš„æ§½ â†’ å£“åŠ›é ‚éƒ¨
//==============================================================
function calcVPOC(bars, buckets=40){
    if(bars.length<5) return{poc:0,support:0,resistance:0}
    let hi=Math.max(...bars.map(b=>b.high))
    let lo=Math.min(...bars.map(b=>b.low))
    if(hi<=lo) return{poc:0,support:0,resistance:0}
    let step=(hi-lo)/buckets
    let vol=new Array(buckets).fill(0)
    bars.forEach(b=>{
        let bLo=Math.max(0,Math.floor((b.low-lo)/step))
        let bHi=Math.min(buckets-1,Math.floor((b.high-lo)/step))
        let span=bHi-bLo+1
        for(let i=bLo;i<=bHi;i++) vol[i]+=b.volume/span
    })
    // POC ç´¢å¼•
    let pocIdx=vol.indexOf(Math.max(...vol))
    let poc=lo+pocIdx*step+step/2
    // å‡é‡ï¼ˆéæ¿¾ä½é »æ§½ç”¨ï¼‰
    let avgVol=vol.reduce((a,b)=>a+b,0)/buckets
    let threshold=avgVol*0.45
    // å¾€ä¸‹æ‰¾æ”¯æ’åº•éƒ¨ï¼ˆpocå¾€ä¸‹ç¬¬ä¸€å€‹é‡ä½æ§½ = æ”¯æ’ä¸‹ç·£ï¼‰
    let supportIdx=pocIdx
    for(let i=pocIdx-1;i>=0;i--){
        if(vol[i]<threshold){ supportIdx=i+1; break }
        if(i===0) supportIdx=0
    }
    // å¾€ä¸Šæ‰¾å£“åŠ›é ‚éƒ¨
    let resistIdx=pocIdx
    for(let i=pocIdx+1;i<buckets;i++){
        if(vol[i]<threshold){ resistIdx=i-1; break }
        if(i===buckets-1) resistIdx=buckets-1
    }
    let support=lo+supportIdx*step
    let resistance=lo+resistIdx*step+step
    return{poc,support,resistance}
}

//==============================================================
// â˜… ä¸»ç­–ç•¥
//==============================================================
function runStrategy(symbol){
    let s=SYMBOL_POOL[symbol]; if(!s) return
    if(s.k15.length<ENGINE.minBars15||s.k1.length<ENGINE.minBars1) return
    if(BTC_POOL.k15.length<ENGINE.minBars15) return
    let price=s.lastPrice; if(price<=0) return

    //â”€â”€â”€â”€â”€â”€ ç¬¬ä¸€å±¤ï¼šè¶¨å‹¢çµæ§‹ï¼ˆæœ€é«˜28åˆ†ï¼‰â”€â”€â”€â”€â”€â”€
    let ma7=MA(s.k15,7), ma20=MA(s.k15,20), ma25=MA(s.k15,25), ma99=MA(s.k15,99)
    let structStrong=(ma7>ma20&&ma20>ma25&&ma25>ma99)
    let structBuild=(ma7>ma20&&ma20>ma25)
    let structBase=(ma7>ma20)
    let slUp=slopeN(s.k15,5)>0
    let priceAboveMA=(price>ma7)
    let structScore=structStrong?20:(structBuild?14:(structBase?8:0))
    let slopeScore=(slUp?5:0)+(priceAboveMA?3:0)

    //â”€â”€â”€â”€â”€â”€ ç¬¬äºŒå±¤ï¼šçªç ´ï¼ˆæœ€é«˜22åˆ†ï¼‰â”€â”€â”€â”€â”€â”€
    let high20=getHigh(s.k15,20), high35=getHigh(s.k15,35)
    let bo20=price>high20, bo35=price>high35
    let near20=price>high20*0.993
    // ç¢ºèªï¼š1mä¸Šæœ€è¿‘3æ ¹æ”¶ç›¤é«˜æ–¼çªç ´ä½
    let last3_1m=s.k1.slice(-3)
    let bo1mConfirm=bo20&&last3_1m.length===3&&last3_1m.every(c=>c.close>high20*0.99)
    let breakScore=bo1mConfirm?22:(bo35?16:(bo20?12:(near20?7:0)))

    //â”€â”€â”€â”€â”€â”€ ç¬¬ä¸‰å±¤ï¼šå‹•èƒ½ï¼ˆæœ€é«˜24åˆ†ï¼‰â”€â”€â”€â”€â”€â”€
    // 15mé‡èƒ½
    let recent20=s.k15.slice(-20)
    let avgVol15=recent20.reduce((a,b)=>a+b.volume,0)/20
    let volNow15=s.k15.at(-1).volume
    let volR15=avgVol15>0?volNow15/avgVol15:1
    // 1mé‡èƒ½ï¼ˆè¿‘10æ ¹å‡é‡ï¼‰
    let avg1m=s.k1.slice(-15).reduce((a,b)=>a+b.volume,0)/15
    let volNow1m=s.k1.at(-1)?.volume||0
    let volR1m=avg1m>0?volNow1m/avg1m:1
    // ATR æ“´å¼µ
    let atr15=ATR(s.k15,14), atrPast=ATR(s.k15.slice(0,-5),14)
    let atrExp=atrPast>0&&atr15>atrPast*1.05
    let btcATR=ATR(BTC_POOL.k15,14)
    let atrDec=btcATR>0&&atr15>btcATR*1.15
    let vol15Score=volR15>2.5?14:(volR15>2?11:(volR15>1.5?7:(volR15>1.2?4:0)))
    let vol1mScore=volR1m>2?5:(volR1m>1.5?3:0)
    let atrScore=(atrExp?3:0)+(atrDec?2:0)

    //â”€â”€â”€â”€â”€â”€ ç¬¬å››å±¤ï¼šOIï¼ˆæœ€é«˜26åˆ†ï¼‰â”€â”€â”€â”€â”€â”€
    let oiNow=s.oi, oiPrev=s.prevOI||oiNow
    let oiChange=oiPrev>0?((oiNow-oiPrev)/oiPrev*100):0
    let oiBuild=oiChange>0.3, oiStrong=oiChange>1.5
    let oiTrend=false, oiConUp=0
    if(s.oiHistory.length>=4){
        let rOI=s.oiHistory.slice(-4)
        oiTrend=rOI[3]>rOI[0]
        for(let i=rOI.length-1;i>0;i--){if(rOI[i]>rOI[i-1])oiConUp++;else break}
    }
    let oiScore=(oiStrong?14:(oiBuild?7:0))+(oiTrend?7:0)+(oiConUp>=3?5:0)

    //â”€â”€â”€â”€â”€â”€ ç¬¬äº”å±¤ï¼šBTC è„«é‰¤ï¼ˆæœ€é«˜12åˆ†ï¼‰â”€â”€â”€â”€â”€â”€
    let btcPrice=BTC_POOL.lastPrice
    let btcHigh20=getHigh(BTC_POOL.k15,20)
    let btcMA7=MA(BTC_POOL.k15,7), btcMA20=MA(BTC_POOL.k15,20)
    let priceDec=(price>high20&&btcPrice<btcHigh20*0.997)
    let structDec=(structBuild&&!(btcMA7>btcMA20))
    let sym1hRet=s.k1.length>=60?(s.k1.at(-1).close/s.k1[s.k1.length-61].close-1)*100:0
    let btc1hRet=BTC_POOL.k1.length>=60?(BTC_POOL.k1.at(-1).close/BTC_POOL.k1[BTC_POOL.k1.length-61].close-1)*100:0
    let retDec=btc1hRet!==0&&sym1hRet>btc1hRet*1.8
    let decScore=(priceDec?5:0)+(structDec?3:0)+(retDec?4:0)

    //â”€â”€â”€â”€â”€â”€ ç¬¬å…­å±¤ï¼šPOCï¼ˆæœ€é«˜8åˆ†ï¼‰â”€â”€â”€â”€â”€â”€
    // ç”¨ 1m å‰30æ ¹åš Volume Profile
    let vp1m=calcVPOC(s.k1.slice(-30),40)
    let pocBreak=price>vp1m.poc
    let pocDist=vp1m.poc>0?((price-vp1m.poc)/vp1m.poc*100):0
    let pocScore=pocBreak?(pocDist>0.5?8:5):0

    //â”€â”€â”€â”€â”€â”€ â˜… é¢¨æ§è¨ˆç®—ï¼ˆæ­¢æ + æ­¢ç›ˆï¼‰â”€â”€â”€â”€â”€â”€
    // æ­¢æï¼š1må‰30æ ¹Volume Profileçš„æ”¯æ’åº•éƒ¨
    // è‹¥æ”¯æ’åº•éƒ¨éè¿‘ï¼ˆ<0.5%ï¼‰ï¼Œæ”¹ç”¨æœ€è¿‘30æ ¹1mæœ€ä½é»
    let vpSupport=vp1m.support
    let rawLow=getLow(s.k1,30)
    // å–ã€Œè¼ƒé«˜çš„é‚£å€‹ã€ä½œç‚ºæ›´ç²¾ç¢ºçš„æ”¯æ’ï¼ˆä¸éä½å–æœ€ä½é»å…œåº•ï¼‰
    let stopPrice=vpSupport>rawLow*1.001?vpSupport:rawLow
    // å†å¾€ä¸‹ç•™ä¸€é»ç·©è¡ï¼ˆ0.1%ï¼‰é¿å…è¢«åˆ·æ‰
    stopPrice=stopPrice*(1-0.001)
    let stopDist=price>0?((price-stopPrice)/price*100):0

    // æ­¢ç›ˆTP1ï¼š1må‰30æ ¹å£“åŠ›é ‚éƒ¨
    let tp1=vp1m.resistance>price?vp1m.resistance:0
    // æ­¢ç›ˆTP2ï¼š1må¹³å‡ATR Ã— å€æ•¸
    let atr1m=ATR(s.k1,14)
    s.atr1m=atr1m
    let tp2=atr1m>0?price+atr1m*ENGINE.tpAtrMult:0
    // è‹¥TP1æ¯”TP2é«˜ï¼Œå„ªå…ˆç”¨TP2ï¼ˆæ›´ä¿å®ˆï¼‰ï¼Œåä¹‹ç”¨TP1ï¼ˆæ›´æ¿€é€²ï¼‰
    // å…©å€‹éƒ½è¼¸å‡ºï¼Œè®“ä½¿ç”¨è€…è‡ªé¸
    let suggestLev=stopDist>0?Math.min(Math.floor(ENGINE.riskPct/stopDist*100),20):1

    s.stopPrice=stopPrice; s.stopDist=stopDist
    s.tp1=tp1; s.tp2=tp2
    s.suggestLev=suggestLev
    s.poc=vp1m.poc; s.pocResistance=vp1m.resistance

    //â”€â”€â”€â”€â”€â”€ å‡ºå ´è¿½è¹¤ â”€â”€â”€â”€â”€â”€
    if(s.oiHistory.length>=2){
        let last=s.oiHistory.at(-1), prev=s.oiHistory.at(-2)
        if(last<prev) s.exitCheckOIDown++; else s.exitCheckOIDown=0
    }
    s.exitVolDown=(volR15<0.75)
    if(s.inPosition&&price>0) s.exitNoNewHigh=(price<s.lastHigh*0.997)

    // å‡ºå ´ï¼š2æ¢æˆç«‹å³è§¸ç™¼ï¼ˆé™ä½é–€æª»ï¼‰
    let exitCount=
        (s.exitCheckOIDown>=2?1:0)+
        (s.exitVolDown?1:0)+
        (s.exitNoNewHigh?1:0)
    let exitSignal=exitCount>=2
    // å¼·å‡ºï¼šOIæ€¥é™ + é‡ç¸®
    if(oiChange<-1.2&&volR15<0.7) exitSignal=true
    let exitReason=[]
    if(s.exitCheckOIDown>=2) exitReason.push(`OIé€£é™${s.exitCheckOIDown}æ ¹`)
    if(s.exitVolDown) exitReason.push('é‡ç¸®')
    if(s.exitNoNewHigh) exitReason.push('æœªå‰µé«˜')
    if(oiChange<-1.2&&volR15<0.7) exitReason.push('OIæ€¥é™+é‡ç¸®')
    s.whaleExit=exitSignal
    s.exitReason=exitReason.join(' / ')

    //â”€â”€â”€â”€â”€â”€ åˆ†æ•¸å½™æ•´ â”€â”€â”€â”€â”€â”€
    let sd={
        structure:structScore, slope:slopeScore,
        breakout:breakScore,
        vol15:vol15Score, vol1m:vol1mScore, atr:atrScore,
        oi:oiScore, decouple:decScore, poc:pocScore
    }
    let total=Object.values(sd).reduce((a,b)=>a+b,0)

    //â”€â”€â”€â”€â”€â”€ ç‹€æ…‹æ©Ÿ â”€â”€â”€â”€â”€â”€
    let state="IDLE"
    if(total>=100) state="STRONG"
    else if(total>=82) state="BREAK"
    else if(total>=65) state="BUILD"
    else if(total>=48) state="RADAR"

    s.score=total; s.scoreDetails=sd; s.state=state
    s.oiChange=oiChange; s.volRatio=volR15
    s.sym1hRet=sym1hRet; s.btc1hRet=btc1hRet

    //â”€â”€â”€â”€â”€â”€ pushLock å†·å»é‡ç½®æ©Ÿåˆ¶ â”€â”€â”€â”€â”€â”€
    // ç•¶åˆ†æ•¸æ‰å‡ºè§¸ç™¼å€å¾Œè¨ˆæ•¸ï¼Œæ»¿pushCooldownBarsä¸”åˆ†æ•¸é‡æ–°é”æ¨™ â†’ è§£é–å¯å†æ¨
    let thrScore=THR_LEVELS[thrIdx].score
    if(s.pushLock){
        if(total<thrScore-10){
            s.pushCooldown++
        } else if(s.pushCooldown>=ENGINE.pushCooldownBars&&total>=thrScore){
            s.pushLock=false; s.pushCooldown=0
            log(`${symbol} æ¨æ’­é–è§£é™¤ï¼ˆåˆ†æ•¸å›å‡ï¼‰`,'info')
        }
    }

    handlePush(symbol)
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç§»å‹•æ­¢æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkTrail(symbol,price){
    let s=SYMBOL_POOL[symbol]; if(!s||!s.inPosition) return
    let entry=s.entryPrice; if(entry<=0) return
    let fp=(price-entry)/entry*100
    if(fp>=ENGINE.trail3Pct&&s.trailStage<3){
        s.trailStage=3; s.currentStop=entry*(1+ENGINE.trail3Loc/100)
        notifyTrail(symbol,fp,3,ENGINE.trail3Loc,s.currentStop)
    } else if(fp>=ENGINE.trail2Pct&&s.trailStage<2){
        s.trailStage=2; s.currentStop=entry*(1+ENGINE.trail2Loc/100)
        notifyTrail(symbol,fp,2,ENGINE.trail2Loc,s.currentStop)
    } else if(fp>=ENGINE.trail1Pct&&s.trailStage<1){
        s.trailStage=1; s.currentStop=entry
        notifyTrail(symbol,fp,1,0,s.currentStop)
    }
}

function notifyTrail(sym,fp,stage,loc,stop){
    let tag=stage===1?'ç§»è‡³æˆæœ¬':`ç§»è‡³+${loc}%`
    log(`ğŸ’° ${sym} ç§»å‹•æ­¢æ[${stage}] æµ®ç›ˆ${fp.toFixed(1)}% â†’ ${tag}`,'signal')
    sendTG(
`ğŸ’° ç§»å‹•æ­¢ææ›´æ–° ${sym}
æµ®ç›ˆï¼š+${fp.toFixed(2)}%
æ­¢æç§»è‡³ï¼š${tag} = ${stop.toFixed(6)}
éšæ®µï¼š${stage}/3`
    )
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ¨æ’­æ§åˆ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handlePush(symbol){
    let s=SYMBOL_POOL[symbol]; if(!s) return
    let thrScore=THR_LEVELS[thrIdx].score
    if(s.stopDist<ENGINE.stopMinDist) return

    // é€²å ´æ¨æ’­
    if(s.score>=thrScore&&!s.pushLock){
        s.pushLock=true; s.pushCooldown=0
        sendTG(buildEntryMsg(symbol,s))
        log(`ğŸ“¡ é€²å ´è¨Šè™Ÿ ${symbol} åˆ†æ•¸:${s.score} æ­¢æ:${s.stopDist.toFixed(2)}%`,'signal')
    }

    // å‡ºå ´æ¨æ’­
    if(s.whaleExit&&!s.exitLock){
        s.exitLock=true
        sendTG(buildExitMsg(symbol,s))
        log(`ğŸš¨ å‡ºå ´è¨Šè™Ÿ ${symbol} åŸå› :${s.exitReason}`,'exit')
    }
}

function fmt(n,d=4){ return (n||0).toFixed(d) }

function buildEntryMsg(sym,s){
    let tp1Str=s.tp1>0?`${fmt(s.tp1)} (+${((s.tp1/s.lastPrice-1)*100).toFixed(2)}%)`:'â€”'
    let tp2Str=s.tp2>0?`${fmt(s.tp2)} (+${((s.tp2/s.lastPrice-1)*100).toFixed(2)}%)`:'â€”'
    return `ğŸ”¥ é€²å ´è¨Šè™Ÿ ${sym}  [${THR_LEVELS[thrIdx].label}]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’° åƒ¹æ ¼   ï¼š${fmt(s.lastPrice)}
ğŸ›‘ æ­¢æ   ï¼š${fmt(s.stopPrice)}  (-${fmt(s.stopDist,2)}%)
   â”” ä¾æ“šï¼š1må‰30æ ¹æˆäº¤é‡å¯†é›†åº•éƒ¨
ğŸ¯ æ­¢ç›ˆTP1ï¼š${tp1Str}
   â”” ä¾æ“šï¼š1må‰30æ ¹å£“åŠ›é ‚éƒ¨
ğŸ¯ æ­¢ç›ˆTP2ï¼š${tp2Str}
   â”” ä¾æ“šï¼š1m ATRÃ—${ENGINE.tpAtrMult}
âš¡ å»ºè­°æ§“æ¡¿ï¼š${s.suggestLev}x  (é¢¨éšª${ENGINE.riskPct}%)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š ç¸½åˆ†ï¼š${s.score}
çµæ§‹:${s.scoreDetails.structure} æ–œç‡:${s.scoreDetails.slope} çªç ´:${s.scoreDetails.breakout}
é‡15m:${s.scoreDetails.vol15} é‡1m:${s.scoreDetails.vol1m} ATR:${s.scoreDetails.atr}
OI:${s.scoreDetails.oi} è„«é‰¤:${s.scoreDetails.decouple} POC:${s.scoreDetails.poc}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ˆ 1hæ¼²å¹…ï¼š${fmt(s.sym1hRet,2)}% (BTC:${fmt(s.btc1hRet,2)}%)
ğŸ‹ é‡èƒ½å€æ•¸ï¼š${fmt(s.volRatio,2)}x
ğŸ“‚ OIè®ŠåŒ–ï¼š${fmt(s.oiChange,2)}%
ğŸ’¡ ç§»å‹•æ­¢æï¼šæµ®ç›ˆ${ENGINE.trail1Pct}%â†’æˆæœ¬ ${ENGINE.trail2Pct}%â†’+${ENGINE.trail2Loc}% ${ENGINE.trail3Pct}%â†’+${ENGINE.trail3Loc}%`
}

function buildExitMsg(sym,s){
    return `âš ï¸ å‡ºå ´è¨Šè™Ÿ ${sym}
æ¢ä»¶ï¼š${s.exitReason}
ç•¶å‰åƒ¹ï¼š${fmt(s.lastPrice)}
OIè®ŠåŒ–ï¼š${fmt(s.oiChange,2)}%
é‡èƒ½å€æ•¸ï¼š${fmt(s.volRatio,2)}x`
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Telegram â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendTG(msg){
    let token=document.getElementById('tgToken').value.trim()
    let chat=document.getElementById('tgChat').value.trim()
    if(!token||!chat) return
    try{
        await fetch(`https://api.telegram.org/bot${token}/sendMessage`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({chat_id:chat,text:msg})
        })
    }catch(e){}
}
function testPush(){
    sendTG(`âœ… V15 QUANT ENGINE æ¸¬è©¦\nç›£æ§å¹£ï¼š${CURRENT_UNIVERSE.length}\né€²å ´é–€æª»ï¼š${THR_LEVELS[thrIdx].label}`)
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStatusBar(){
    document.getElementById('lastUpd').textContent=new Date().toTimeString().slice(0,8)
    document.getElementById('reqR').textContent=reqCountMin+'/min'
}

function renderCards(){
    let container=document.getElementById('cards')
    container.innerHTML=''
    let sorted=[...CURRENT_UNIVERSE].sort((a,b)=>(SYMBOL_POOL[b]?.score||0)-(SYMBOL_POOL[a]?.score||0))
    let cnt={STRONG:0,BREAK:0,BUILD:0,RADAR:0,IDLE:0}
    sorted.forEach(symbol=>{
        let s=SYMBOL_POOL[symbol]; if(!s) return
        let st=s.state||'IDLE'; cnt[st]=(cnt[st]||0)+1
        let div=document.createElement('div')
        div.className='card '+st
        let thrScore=THR_LEVELS[thrIdx].score
        let lockHtml=s.pushLock?
            `<div class="lock-badge">ğŸ”’ å·²æ¨æ’­ å†·å»:${s.pushCooldown}/${ENGINE.pushCooldownBars}</div>`:
            (s.score>=thrScore?`<div class="cd-badge">â³ ç­‰å¾…æ¨æ’­</div>`:'')
        let tp1Str=s.tp1>0?`${fmt(s.tp1)} (+${((s.tp1/s.lastPrice-1)*100).toFixed(1)}%)`:'â€”'
        let tp2Str=s.tp2>0?`${fmt(s.tp2)} (+${((s.tp2/s.lastPrice-1)*100).toFixed(1)}%)`:'â€”'
        let trailHtml=s.inPosition?
            `<div class="trail-row">âš¡æŒå€‰ é€²å ´:${fmt(s.entryPrice)} æ­¢æ:${fmt(s.currentStop)} [éšæ®µ${s.trailStage}]</div>`
            :''
        div.innerHTML=`
<div class="card-header">
  <span class="card-symbol">${symbol}</span>
  <span class="card-state state-${st}">${st}</span>
</div>
<div class="card-score" style="color:${stClr(st)}">${s.score}<span style="font-size:13px;color:#555"> /120</span></div>
<div class="score-grid">
  <div class="score-item"><span>çµæ§‹</span><span class="sv">${s.scoreDetails.structure??'-'}</span></div>
  <div class="score-item"><span>æ–œç‡</span><span class="sv">${s.scoreDetails.slope??'-'}</span></div>
  <div class="score-item"><span>çªç ´</span><span class="sv">${s.scoreDetails.breakout??'-'}</span></div>
  <div class="score-item"><span>é‡15m</span><span class="sv">${s.scoreDetails.vol15??'-'}</span></div>
  <div class="score-item"><span>é‡1m</span><span class="sv">${s.scoreDetails.vol1m??'-'}</span></div>
  <div class="score-item"><span>ATR</span><span class="sv">${s.scoreDetails.atr??'-'}</span></div>
  <div class="score-item"><span>OI</span><span class="sv">${s.scoreDetails.oi??'-'}</span></div>
  <div class="score-item"><span>è„«é‰¤</span><span class="sv">${s.scoreDetails.decouple??'-'}</span></div>
  <div class="score-item"><span>POC</span><span class="sv">${s.scoreDetails.poc??'-'}</span></div>
</div>
<hr class="divider">
<div class="card-risk">
  <span class="rl">æ­¢æ</span><span class="rv sl-row">${fmt(s.stopPrice)} (-${fmt(s.stopDist,2)}%)</span>
  <span class="rl">TP1å£“åŠ›</span><span class="rv tp-row">${tp1Str}</span>
  <span class="rl">TP2 ATR</span><span class="rv tp-row">${tp2Str}</span>
  <span class="rl">æ§“æ¡¿å»ºè­°</span><span class="rv">${s.suggestLev}x</span>
  <span class="rl">é‡èƒ½</span><span class="rv">${fmt(s.volRatio,2)}x</span>
  <span class="rl">OI</span><span class="rv">${fmt(s.oiChange,2)}%</span>
</div>
${s.whaleExit?`<div class="alert-exit">âš  å‡ºå ´ä¿¡è™Ÿï¼š${s.exitReason}</div>`:''}
${trailHtml}
${lockHtml}`
        container.appendChild(div)
    })
    document.getElementById('cS').textContent='STRONG:'+cnt.STRONG
    document.getElementById('cB').textContent='BREAK:'+(cnt.BREAK||0)
    document.getElementById('cBu').textContent='BUILD:'+(cnt.BUILD||0)
    document.getElementById('cR').textContent='RADAR:'+(cnt.RADAR||0)
    document.getElementById('cI').textContent='IDLE:'+(cnt.IDLE||0)
}

function stClr(st){
    return{STRONG:'#22c55e',BREAK:'#3b82f6',BUILD:'#f59e0b',RADAR:'#a855f7',IDLE:'#333'}[st]||'#333'
}
</script>
</body>
</html>
