<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>TRIDENT V47 PRO</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#000;color:#ddd;font-family:monospace}
.card{background:#0a0a0a;border:1px solid #222;padding:12px;border-radius:8px;margin-bottom:10px}
.entry{border:2px solid gold;box-shadow:0 0 15px gold}
.tag{display:inline-block;padding:2px 6px;margin:2px;border-radius:4px;font-size:10px}
.pass{background:#065f46}
.fail{background:#7f1d1d}
.progress{height:6px;background:#222;border-radius:4px;overflow:hidden}
.progress-inner{height:100%;background:#10b981;width:0%}
</style>
</head>
<body class="p-6">

<h1 class="text-2xl mb-4 font-bold">TRIDENT V47 PRO</h1>
<button onclick="ignite()" class="bg-green-600 px-4 py-2 rounded mb-4">啟動掃描</button>

<div class="progress mb-4">
<div id="timerBar" class="progress-inner"></div>
</div>

<div class="flex gap-4">
<div id="list" class="flex-1"></div>
<div class="w-72 bg-black border border-zinc-800 p-2 rounded">
<div class="text-xs mb-2">Signal Log</div>
<div id="log" class="text-xs space-y-1"></div>
</div>
</div>

<script>
let market={}
let livePrice={}
let btcSlope=0
let running=false

const MAX_SYMBOLS=15

async function ignite(){
if(running)return
running=true
await loadBTC()
await loadUniverse()
startWS()
startTimer()
}

async function loadBTC(){
const k=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=15m&limit=20`).then(r=>r.json())
btcSlope=calcSlope(k.map(x=>parseFloat(x[4])))
}

async function loadUniverse(){
const data=await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json())
const top=data.filter(x=>x.symbol.endsWith('USDT'))
.sort((a,b)=>b.quoteVolume-a.quoteVolume)
.slice(0,MAX_SYMBOLS)

for(let t of top){
await initSymbol(t.symbol)
}
}

async function initSymbol(s){
const k=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=30`).then(r=>r.json())
market[s]={
klines:k,
poc:calcPOC(k),
vwap:calcVWAP(k),
slope:calcSlope(k.map(x=>parseFloat(x[4]))),
avgVol:k.reduce((a,b)=>a+parseFloat(b[5]),0)/k.length
}
}

function calcSlope(arr){
let n=arr.length
let sumX=0,sumY=0,sumXY=0,sumXX=0
for(let i=0;i<n;i++){
sumX+=i
sumY+=arr[i]
sumXY+=i*arr[i]
sumXX+=i*i
}
return (n*sumXY-sumX*sumY)/(n*sumXX-sumX*sumX)
}

function calcVWAP(k){
let totalPV=0,totalV=0
k.forEach(x=>{
let price=parseFloat(x[4])
let vol=parseFloat(x[5])
totalPV+=price*vol
totalV+=vol
})
return totalPV/totalV
}

function calcPOC(k){
let bins={}
k.forEach(x=>{
let price=parseFloat(x[4])
let vol=parseFloat(x[5])
bins[Math.round(price*100)/100]=(bins[Math.round(price*100)/100]||0)+vol
})
let max=0,poc=0
for(let b in bins){
if(bins[b]>max){max=bins[b];poc=parseFloat(b)}
}
return poc
}

function startWS(){
const ws=new WebSocket('wss://fstream.binance.com/ws/!ticker@arr')
ws.onmessage=e=>{
JSON.parse(e.data).forEach(m=>{
livePrice[m.s]={price:parseFloat(m.c),vol:parseFloat(m.q)}
})
}
}

function startTimer(){
let t=0
setInterval(()=>{
t+=100
let percent=(t/30000)*100
document.getElementById('timerBar').style.width=percent+"%"
if(t>=30000){
t=0
recalculate()
}
},100)
}

function recalculate(){
let result=[]

for(let s in market){
if(!livePrice[s])continue
let price=livePrice[s].price
let vol=livePrice[s].vol
let data=market[s]

let pass=[]
let fail=[]
let score=0

// 1 Breakout
if(price>Math.max(...data.klines.map(x=>parseFloat(x[2])))){
score+=20;pass.push("Breakout")
}else fail.push("Breakout")

// 2 VWAP Trend
if(price>data.vwap && data.slope>0){
score+=15;pass.push("VWAP Trend")
}else fail.push("VWAP Trend")

// 3 POC
if(Math.abs(price-data.poc)/data.poc<0.005){
score+=15;pass.push("POC Zone")
}else fail.push("POC Zone")

// 4 BTC Sync
if(btcSlope>0 && data.slope>0){
score+=10;pass.push("BTC Sync")
}else fail.push("BTC Sync")

// 5 Volume Spike
if(vol/data.avgVol>1.5){
score+=10;pass.push("Volume Spike")
}else fail.push("Volume Spike")

// 6 Momentum
if(data.slope>0){
score+=10;pass.push("Momentum")
}else fail.push("Momentum")

// 7 Basic Trend
if(price>data.klines[data.klines.length-1][4]){
score+=10;pass.push("Trend Hold")
}else fail.push("Trend Hold")

// 8 Structure
if(price>data.poc){
score+=10;pass.push("Structure")
}else fail.push("Structure")

result.push({symbol:s,score,pass,fail})
}

result.sort((a,b)=>b.score-a.score)
render(result)
}

function render(arr){
let html=""
arr.forEach(r=>{
let entry=r.score>=85
if(entry){
document.getElementById('log').innerHTML=
`<div class="text-yellow-400">ENTRY READY ${r.symbol} ${r.score}</div>`
+document.getElementById('log').innerHTML
}

html+=`
<div class="card ${entry?'entry':''}">
<div class="flex justify-between">
<div>${r.symbol}</div>
<div>${r.score}</div>
</div>
<div class="mt-2">
${r.pass.map(x=>`<span class="tag pass">${x}</span>`).join("")}
</div>
<div class="mt-1">
${r.fail.map(x=>`<span class="tag fail">${x}</span>`).join("")}
</div>
<div class="text-xs mt-1">缺少 ${r.fail.length} 條件</div>
</div>
`
})
document.getElementById('list').innerHTML=html
}
</script>
</body>
</html>
