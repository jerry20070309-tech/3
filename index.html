<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ SNIPER V24.0 | ç‰©ç†é™é »å°åŒ…ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { background: #010101; color: #FFD700; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .card { background: #050505; border: 1px solid #1a1a1a; border-radius: 4px; padding: 12px; transition: 0.2s; position: relative; }
        .tight-zone { border: 1px solid #eab308; background: linear-gradient(135deg, #0a0a00, #000); }
        .monster-boost { border: 2px solid #ef4444 !important; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 5px #450a0a; } 50% { box-shadow: 0 0 20px #ef4444; } 100% { box-shadow: 0 0 5px #450a0a; } }
        .bar-container { background: #111; height: 3px; border-radius: 2px; margin: 4px 0; overflow: hidden; }
        .bar-power { height: 100%; background: #2563eb; transition: 0.5s ease-out; }
    </style>
</head>
<body class="h-screen flex flex-col p-2 text-[10px]">

    <header class="p-3 border-b border-yellow-900/50 flex justify-between items-center">
        <div class="flex items-center gap-6">
            <h1 class="text-2xl font-black text-yellow-500 italic tracking-tighter">âš¡ SNIPER V24.0</h1>
            <div id="dayStrategy" class="px-3 py-1 bg-blue-900/20 border border-blue-500/50 text-blue-400 font-bold rounded">ç­‰å¾…åˆå§‹åŒ–...</div>
        </div>
        <div class="flex gap-4 items-center">
            <button id="switchBtn" onclick="toggleSystem()" class="bg-yellow-500 hover:bg-yellow-400 text-black px-6 py-2 font-black rounded transition-all">START RADAR</button>
            <div id="apiStatus" class="font-bold text-zinc-600 border border-zinc-800 px-4 py-2 rounded uppercase text-[9px]">SYSTEM: IDLE</div>
        </div>
    </header>

    <div class="bg-zinc-900/20 p-2 grid grid-cols-6 gap-4 border-b border-yellow-900/10">
        <div>ğŸŒ€ SQZæ©«ç›¤ <span id="v_sqz" class="text-yellow-500 font-bold">1.2%</span><input type="range" id="i_sqz" min="5" max="50" value="12" class="w-full mt-1 accent-yellow-500"></div>
        <div>ğŸ¯ POCçªç ´ <span id="v_poc" class="text-green-500 font-bold">1.1%</span><input type="range" id="i_poc" min="5" max="50" value="11" class="w-full mt-1 accent-green-500"></div>
        <div>ğŸš¨ SLPä¹–é›¢ <span id="v_slp" class="text-red-500 font-bold">1.5%</span><input type="range" id="i_slp" min="5" max="50" value="15" class="w-full mt-1 accent-red-500"></div>
        <div>ğŸš€ DRVçœŸç©º <span id="v_drv" class="text-blue-500 font-bold">90</span><input type="range" id="i_drv" min="10" max="150" value="90" class="w-full mt-1 accent-blue-500"></div>
        <div>âš¡ MOMå‡ç·š <span id="v_mom" class="text-orange-500 font-bold">0.8%</span><input type="range" id="i_mom" min="1" max="50" value="8" class="w-full mt-1 accent-orange-500"></div>
        <div>ğŸ“Š RSIé–¾å€¼ <span id="v_rsi" class="text-purple-400 font-bold">70</span><input type="range" id="i_rsi" min="50" max="90" value="70" class="w-full mt-1 accent-purple-400"></div>
    </div>

    <div class="flex flex-1 overflow-hidden mt-2 gap-2">
        <main id="dashboard" class="flex-1 overflow-y-auto grid grid-cols-4 gap-3 p-1 content-start"></main>
        <aside class="w-80 bg-black border-l border-yellow-900/30 flex flex-col">
            <div class="p-2 border-b border-zinc-800 text-[10px] font-black italic flex justify-between uppercase">
                <span class="text-red-600">ğŸ›¡ï¸ PACKET SURVEILLANCE</span>
                <span id="pwrStatus" class="text-zinc-700 font-mono">STEP: 0</span>
            </div>
            <div id="logBox" class="flex-1 overflow-y-auto p-2 space-y-1 font-mono text-[9px]"></div>
        </aside>
    </div>

<script>
    let isRunning = false, stats = {}, activeWS = null;
    let FILTER = { SQZ: 0.012, POC: 0.011, SLP: 0.015, DRV: 90, MOM: 0.008, RSI: 70 };
    let step = 0; // æ ¸å¿ƒç‹€æ…‹æ©Ÿæ­¥é€²
    let currentSubscribed = []; // å°åŒ…è¨‚é–±è¿½è¹¤

    function toggleSystem() {
        isRunning = !isRunning;
        const b = document.getElementById('switchBtn');
        b.innerText = isRunning ? "STOP RADAR" : "START RADAR";
        b.style.backgroundColor = isRunning ? "#ef4444" : "#eab308";
        document.getElementById('apiStatus').innerText = isRunning ? "SYSTEM: ACTIVE" : "SYSTEM: IDLE";
        if (isRunning) {
            initPacketWS();
            masterClock();
        } else {
            if(activeWS) activeWS.close();
        }
    }

    // [A] æ ¸å¿ƒ WebSocket å°åŒ…é€£ç·šï¼šåƒ…å»ºç«‹ä¸€å€‹ï¼Œç”¨æ–¼è¨‚é–±é«˜åˆ†å¹£
    function initPacketWS() {
        activeWS = new WebSocket("wss://fstream.binance.com/ws");
        activeWS.onmessage = (e) => {
            const d = JSON.parse(e.data);
            if (d.e === "aggTrade") {
                const usd = parseFloat(d.q) * parseFloat(d.p);
                if (usd > 50000) {
                    const side = d.m ? "SELL" : "BUY";
                    if (!stats[d.s]) return;
                    if (side === "BUY") stats[d.s].buyV += usd; else stats[d.s].sellV += usd;
                    addLog(`ğŸ‹ [WHALE] ${d.s} $${(usd/1000).toFixed(0)}K | ${side}`, d.m ? "text-orange-500" : "text-green-500 border-l border-green-500 pl-1");
                }
            }
            if (d.e === "forceOrder") {
                const val = (parseFloat(d.o.q) * parseFloat(d.o.p) / 1000).toFixed(1);
                if (stats[d.o.s]) stats[d.o.s].liq += parseFloat(val);
                addLog(`ğŸ’€ [LIQ] ${d.o.s} $${val}K | ${d.o.S}`, "text-red-500 font-bold border-l border-red-500 pl-1");
            }
        };
        activeWS.onopen = () => {
            activeWS.send(JSON.stringify({ method: "SUBSCRIBE", params: ["!forceOrder@arr"], id: 1 }));
        };
    }

    // [B] ç‰©ç†é™é »è„ˆè¡ (éµå¾ª V18.0 è«‹æ±‚æ–¹å¼)
    async function masterClock() {
        if (!isRunning) return;
        document.getElementById('pwrStatus').innerText = `STEP: ${step}`;
        try {
            if (step === 0) {
                // æ­¥é©Ÿ 0: ç²å–å…¨å ´ 24h è¡Œæƒ… (é »ç‡: 3s å‘¨æœŸä¸­çš„ç¬¬ 1 ç§’)
                const r = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
                const data = await r.json();
                data.forEach(t => {
                    if (!t.symbol.endsWith('USDT')) return;
                    const s = t.symbol, p = parseFloat(t.lastPrice), h = parseFloat(t.highPrice), l = parseFloat(t.lowPrice);
                    const chg = parseFloat(t.priceChangePercent);
                    let score = ((h-l)/p <= FILTER.SQZ) ? 40 : 0;
                    if (chg > 5) score += 30;
                    if (!stats[s]) stats[s] = { s, score:0, price:p, funding:0, bid:0, ask:0, liq:0, buyV:0, sellV:0, vol:parseFloat(t.quoteVolume), oldP:p };
                    stats[s] = { ...stats[s], price:p, score, vol:parseFloat(t.quoteVolume), chg, isVac: (h-p)/p < 0.003 };
                });
                step = 1;
            } else if (step === 1) {
                // æ­¥é©Ÿ 1: ç²å–è²»ç‡ (é »ç‡: 3s å‘¨æœŸä¸­çš„ç¬¬ 2 ç§’)
                const r = await fetch('https://fapi.binance.com/fapi/v1/premiumIndex');
                const data = await r.json();
                data.forEach(p => { if(stats[p.symbol]) stats[p.symbol].funding = p.lastFundingRate; });
                step = 2;
            } else {
                // æ­¥é©Ÿ 2: æ·±åº¦æƒæèˆ‡ã€Œå°åŒ…å‹•æ…‹åˆ‡æ›ã€ (é »ç‡: 3s å‘¨æœŸä¸­çš„ç¬¬ 3 ç§’)
                const sorted = Object.values(stats).sort((a,b) => b.score - a.score);
                const topTargets = sorted.slice(0, 10); // åªé‡å°å‰ 10 å
                
                // å‹•æ…‹å°åŒ…è¨‚é–±ç®¡ç†
                if (activeWS && activeWS.readyState === 1) {
                    const newStreams = topTargets.map(x => `${x.s.toLowerCase()}@aggTrade`);
                    const toUnsub = currentSubscribed.filter(s => !newStreams.includes(s));
                    const toSub = newStreams.filter(s => !currentSubscribed.includes(s));
                    if (toUnsub.length) activeWS.send(JSON.stringify({ method: "UNSUBSCRIBE", params: toUnsub, id: 2 }));
                    if (toSub.length) activeWS.send(JSON.stringify({ method: "SUBSCRIBE", params: toSub, id: 3 }));
                    currentSubscribed = newStreams;
                }

                // æŠ“å–ç¬¬ä¸€åçš„æ·±åº¦ (ç‰©ç†é™é »è«‹æ±‚)
                const top = topTargets[0];
                if (top) {
                    const r = await fetch(`https://fapi.binance.com/fapi/v1/depth?symbol=${top.s}&limit=10`);
                    const d = await r.json();
                    stats[top.s].ask = d.asks.reduce((a,b)=>a+parseFloat(b[1]),0);
                    stats[top.s].bid = d.bids.reduce((a,b)=>a+parseFloat(b[1]),0);
                }
                step = 0;
            }
            render();
        } catch (e) { console.warn("API ç‰©ç†ä¿è­·å•Ÿå‹• - å»¶é²ä¸­"); }
        setTimeout(masterClock, 1000); // æ¯ä¸€ç§’åˆ‡æ›ä¸€æ¬¡ç‹€æ…‹ï¼Œå®Œæ•´é€±æœŸä¸‰ç§’
    }

    function render() {
        const board = document.getElementById('dashboard');
        const sorted = Object.values(stats).sort((a,b) => b.score - a.score).slice(0, 24);
        board.innerHTML = sorted.map(x => {
            const flow = (x.buyV - x.sellV)/1000;
            const power = (x.bid / (x.bid + x.ask) * 100) || 50;
            return `
            <div class="card ${x.score >= 50 ? 'tight-zone' : ''} ${x.vol > 1e9 ? 'monster-boost' : ''}">
                <div class="flex justify-between font-black text-[11px]">
                    <span class="text-white uppercase">${x.s.replace('USDT','')}</span>
                    <span class="text-yellow-500">â˜…${x.score}</span>
                </div>
                <div class="text-2xl font-black text-white py-1 italic tracking-tighter">$${x.price}</div>
                <div class="flex justify-between text-[8px] font-bold">
                    <span class="${x.chg >= 0 ? 'text-green-500' : 'text-red-500'}">${x.chg}%</span>
                    <span class="${x.funding < 0 ? 'text-red-500' : 'text-green-500'}">F: ${(x.funding*100).toFixed(4)}%</span>
                </div>
                <div class="bar-container"><div class="bar-power" style="width: ${power}%"></div></div>
                <div class="flex justify-between text-[8px] font-bold mt-1 uppercase">
                    <span class="text-blue-400">NET: $${flow.toFixed(0)}K</span>
                    <span class="text-zinc-600">LIQ: $${x.liq.toFixed(0)}K</span>
                </div>
                ${x.isVac ? '<div class="absolute bottom-1 right-1 text-[7px] bg-blue-600 text-white px-1 rounded font-bold uppercase">Vacuum</div>' : ''}
            </div>`;
        }).join('');
    }

    // 2026-01-24 æŒ‡ä»¤èˆ‡æ»‘æ¡¿
    const day = new Date().getDay();
    const notice = document.getElementById('dayStrategy');
    if (day === 6) { 
        notice.innerText = "ğŸ“… é€±å…­æ¨¡å¼ï¼šé–å®šé€±å…­æœŸæ•¸è¨ˆç®—"; 
        FILTER.SQZ = 0.008; 
    } else { 
        notice.innerText = "ğŸ“… å¸¸è¦ç­–ç•¥æƒæä¸­"; 
    }

    function addLog(m, c) {
        const b = document.getElementById('logBox');
        const d = document.createElement('div'); d.className = `p-1 border-b border-zinc-900 ${c}`;
        d.innerHTML = `[${new Date().toLocaleTimeString()}] ${m}`;
        b.prepend(d); if(b.childNodes.length > 50) b.removeChild(b.lastChild);
    }

    // æ»‘æ¡¿èª¿ç¯€é‚è¼¯ (éµå¾ª V18)
    ['i_sqz', 'i_poc', 'i_slp', 'i_drv', 'i_mom', 'i_rsi'].forEach(id => {
        document.getElementById(id).oninput = (e) => {
            const k = id.split('_')[1].toUpperCase();
            FILTER[k] = parseFloat(e.target.value) / (k === 'RSI' ? 1 : 1000);
            document.getElementById('v_'+id.split('_')[1]).innerText = (k==='RSI'?e.target.value:(e.target.value/10).toFixed(1) + '%');
        };
    });
</script>
</body>
</html>
