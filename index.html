<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>CITY V3 PRO – LONG ONLY</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#050505;color:#d4d4d8;font-family:monospace}
.card{background:#0f0f11;border:1px solid #1f1f23}
.progress{height:4px;background:#22c55e;transition:width 1s linear}
</style>
</head>
<body class="p-6">

<div class="flex justify-between mb-4">
<div>
<h1 class="text-2xl font-bold text-white">CITY V3 PRO</h1>
<div class="text-xs text-zinc-400">LONG ONLY ENGINE</div>
</div>

<div>
<input id="marginInput" type="number" placeholder="輸入保證金"
class="bg-black border border-zinc-700 px-3 py-1 text-sm w-32">
</div>
</div>

<div class="w-full bg-zinc-800 mb-6">
<div id="timerBar" class="progress w-0"></div>
</div>

<div id="list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

<script>

const BLACKLIST = [
'BTCUSDT','ETHUSDT','BNBUSDT','XRPUSDT','SOLUSDT','ADAUSDT',
'DOGEUSDT','TRXUSDT','AVAXUSDT','DOTUSDT','LINKUSDT','MATICUSDT',
'LTCUSDT','BCHUSDT','XLMUSDT','ATOMUSDT','ETCUSDT','APTUSDT',
'FILUSDT','ICPUSDT','ARBUSDT','OPUSDT','NEARUSDT','HBARUSDT',
'VETUSDT','INJUSDT','IMXUSDT','GRTUSDT','AAVEUSDT','RNDRUSDT',
'SUIUSDT','FTMUSDT','THETAUSDT','EGLDUSDT','KASUSDT'
];

let marketData = {};
let alerted = new Set();
let firstScan = true;

async function fetchSymbols(limit){

const tickers = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr')
.then(r=>r.json());

return tickers
.filter(t=>t.symbol.endsWith('USDT') && !BLACKLIST.includes(t.symbol))
.sort((a,b)=>b.quoteVolume-a.quoteVolume)
.slice(0,limit)
.map(t=>t.symbol);

}

async function scan(){

const symbols = await fetchSymbols(firstScan?400:100);
firstScan = false;

for(let s of symbols){
await calculateSymbol(s);
}

render();

}

async function calculateSymbol(s){

try{

const k = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=120`)
.then(r=>r.json());

const closes = k.map(x=>parseFloat(x[4]));
const highs = k.map(x=>parseFloat(x[2]));
const lows = k.map(x=>parseFloat(x[3]));
const volumes = k.map(x=>parseFloat(x[5]));

const price = closes.at(-1);

const ma25 = avg(closes.slice(-25));
const ma99 = avg(closes.slice(-99));

const slope = ma25 - avg(closes.slice(-26,-1));

const atr = avg(highs.map((h,i)=>h-lows[i]).slice(-14));
const atrLong = avg(highs.map((h,i)=>h-lows[i]).slice(-50));

const storm = atr/atrLong;

const poc = calculatePOC(k);

const oi15 = await getOI(s,'15m');
const oi1h = await getOI(s,'1h');

const funding = await fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${s}`)
.then(r=>r.json()).then(d=>parseFloat(d.lastFundingRate));

let score = 0;
let tags = [];

if(ma25>ma99){score+=20;tags.push('多頭排列')}
if(price>ma25){score+=15;tags.push('站上均線')}
if(price>poc){score+=15;tags.push('站上POC')}
if(oi15>0 && oi1h>0){score+=15;tags.push('OI同步增')}
if(storm>1.3){score+=15;tags.push('風暴比強')}
if(slope>0){score+=10;tags.push('斜率正')}
if(funding<0.02){score+=10;tags.push('Funding健康')}

marketData[s]={
price,ma25,ma99,poc,score,tags,
stop:lows.slice(-10).reduce((a,b)=>Math.min(a,b)),
atr
};

}catch(e){}

}

function render(){

const container=document.getElementById('list');
container.innerHTML='';

const sorted=Object.entries(marketData)
.filter(([_,v])=>v.score>=80)
.sort((a,b)=>b[1].score-a[1].score);

sorted.forEach(([s,v])=>{

const margin=parseFloat(document.getElementById('marginInput').value)||0;
const riskPerUnit=v.price-v.stop;
const qty=margin/riskPerUnit;
const tp=v.price+v.atr*1.5;
const rr=(tp-v.price)/(v.price-v.stop);

if(v.score>=90 && !alerted.has(s)){
alert(s+' 強信號');
alerted.add(s);
}

container.innerHTML+=`
<div class="card p-4 rounded">
<div class="text-white font-bold">${s}</div>
<div class="text-sm text-zinc-400">Score: ${v.score}</div>
<div class="text-xs text-green-400">${v.tags.join(' | ')}</div>
<div class="mt-2 text-xs">
Entry: ${v.price.toFixed(4)}<br>
SL: ${v.stop.toFixed(4)}<br>
TP: ${tp.toFixed(4)}<br>
RR: ${rr.toFixed(2)}<br>
倉位: ${qty.toFixed(2)}
</div>
</div>
`;

});

}

function calculatePOC(k){
let bins={};
k.forEach(c=>{
let p=parseFloat(c[4]);
let v=parseFloat(c[5]);
bins[p]=(bins[p]||0)+v;
});
return parseFloat(Object.entries(bins).sort((a,b)=>b[1]-a[1])[0][0]);
}

async function getOI(s,period){
try{
const r=await fetch(`https://fapi.binance.com/futures/data/openInterestHist?symbol=${s}&period=${period}&limit=2`)
.then(r=>r.json());
if(r.length>1){
return (r[1].sumOpenInterest-r[0].sumOpenInterest);
}
}catch(e){}
return 0;
}

function avg(arr){
return arr.reduce((a,b)=>a+b,0)/arr.length;
}

scan();
setInterval(scan,30000);

let t=0;
setInterval(()=>{
t=(t+1)%30;
document.getElementById('timerBar').style.width=(t/30*100)+'%';
},1000);

</script>
</body>
</html>
