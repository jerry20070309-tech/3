import streamlit as st
import pandas as pd
import time
from datetime import datetime
from binance.client import Client
from binance.exceptions import BinanceAPIException

# --- [A] å°ˆæ¥­ Sniper é…ç½® ---
st.set_page_config(page_title="SNIPER RADAR V13.5", layout="wide")
st.markdown("""
<style>
    .main { background-color: #050505; color: #FFD700; font-family: 'JetBrains Mono', monospace; }
    .stMetric { border: 1px solid #1a1a1a; background-color: #0a0a0a; padding: 15px; border-radius: 8px; }
</style>
""", unsafe_allow_html=True)

# --- [B] å´é‚Šæ¬„æ§åˆ¶ ---
with st.sidebar:
    st.title("âš¡ SNIPER V13.5")
    target_symbol = st.text_input("ğŸ” ç›£æ§ç›®æ¨™ (å¦‚ BTCUSDT)", value="BTCUSDT").upper()
    whale_limit = st.number_input("ğŸ’µ å·¨é¯¨é–€æª» (USDT)", value=50000)
    st.divider()
    api_key = st.text_input("Binance API Key", type="password")
    api_secret = st.text_input("Binance API Secret", type="password")
    is_active = st.toggle("ğŸš€ START RADAR")

# --- [C] ä¿®æ­£å¾Œçš„æ•¸æ“šå¼•æ“ (è§£æ±º 400 éŒ¯èª¤) ---
def get_valid_data(client, symbol):
    try:
        # P2: æˆäº¤æ•¸æ“š (æ­£å¸¸)
        trades = client.futures_recent_trades(symbol=symbol, limit=20)
        # B2: æŒå€‰æ•¸æ“š (ä¿®æ­£é»ï¼šå¿…é ˆæŒ‡å®š symbolï¼Œä¸å¯ç”¨ ALL)
        oi = client.futures_open_interest(symbol=symbol)
        # P3: çˆ†å€‰æ•¸æ“š
        liqs = client.futures_get_all_liquidation_orders(symbol=symbol, limit=1)
        return trades, oi, liqs
    except BinanceAPIException as e:
        st.error(f"API è«‹æ±‚å¤±æ•—: {e.message}") # æ•æ‰ 400 éŒ¯èª¤ä¸¦é¡¯ç¤ºåŸå› 
        return None, None, None

# --- [D] æ ¸å¿ƒåŸ·è¡Œé‚è¼¯ ---
if is_active and api_key and api_secret:
    client = Client(api_key, api_secret)
    if 'prev_oi' not in st.session_state: st.session_state.prev_oi = 0.0
    
    dashboard = st.empty()
    
    while is_active:
        start_time = time.perf_counter()
        t_data, o_data, l_data = get_valid_data(client, target_symbol)
        
        if t_data and o_data:
            # æ•¸æ“šè§£æ
            price = float(t_data[-1]['price'])
            curr_oi = float(o_data['openInterest'])
            oi_change = curr_oi - st.session_state.prev_oi if st.session_state.prev_oi > 0 else 0
            
            # é€±å…­/é€±ä¸€åˆ¤å®š
            now = datetime.utcnow()
            is_sat = now.weekday() == 5
            is_mon = now.weekday() == 0
            status_tag = "ğŸŸ¢ (é€±å…­å°ˆå±¬)" if is_sat else ("ğŸ”µ (é€±ä¸€é«˜å‹ç‡)" if is_mon else "âšª (ä¸€èˆ¬ç›£æ§)")

            with dashboard.container():
                st.subheader(f"ğŸ“Š {target_symbol} æˆ°å ± {status_tag}")
                c1, c2, c3 = st.columns(3)
                c1.metric("å³æ™‚å¸‚åƒ¹", f"${price:,.2f}")
                c2.metric("æŒå€‰è®Šå‹• (B2)", f"{curr_oi:,.0f}", f"{oi_change:,.2f}")
                
                vol = price * float(t_data[-1]['qty'])
                c3.metric("æœ€æ–°æˆäº¤ (P2)", f"${vol:,.0f}")
                
                # ğŸ³ å·¨é¯¨åˆ¤å®š
                if vol >= whale_limit:
                    if t_data[-1]['isBuyerMaker'] and oi_change < 0:
                        st.error(f"ğŸš¨ å·¨é¯¨å¹³å€‰å‡ºè²¨ï¼é‡‘é¡: ${vol:,.0f}")
                    elif not t_data[-1]['isBuyerMaker'] and oi_change > 0:
                        st.success(f"ğŸ’ å·¨é¯¨åº•éƒ¨å»ºå€‰ï¼é‡‘é¡: ${vol:,.0f}")
                
                if is_sat:
                    st.warning("âš ï¸ æé†’ï¼šé€±å…­æ•¸æ“šç¨ç«‹æ­¸å±¬ï¼Œä¸èˆ‡é€±æ—¥æ··ç”¨ã€‚")

            st.session_state.prev_oi = curr_oi
            
        # ç²¾ç¢º 3 ç§’å¾ªç’°ï¼Œé˜²æ­¢ GitHub Actions è³‡æºç«¶çˆ­
        wait = max(0, 3.0 - (time.perf_counter() - start_time))
        time.sleep(wait)
else:
    st.info("ğŸ’¡ è«‹é…ç½® API Key ä¸¦å•Ÿå‹•ç›£æ§ã€‚ä¿®æ­£å¾Œçš„ä»£ç¢¼å·²ç§»é™¤ 'symbol=ALL' ä»¥è§£æ±º 400 å ±éŒ¯ã€‚")
