<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>幣安清算型態全幣對掃描器</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b0e11; color: #eaecef; margin: 0; padding: 20px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; position: sticky; top: 0; background: #0b0e11; padding: 10px 0; }
        input { background: #2b3139; border: 1px solid #474d57; color: white; padding: 8px; border-radius: 4px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .card { background: #1e2329; border-radius: 8px; padding: 15px; border: 1px solid #2b3139; transition: 0.3s; }
        .card.alert { border-color: #f6465d; box-shadow: 0 0 10px rgba(246, 70, 93, 0.3); }
        .card.pinned { border-color: #f0b90b; order: -1; } /* 定選排在前面 */
        .symbol-header { display: flex; justify-content: space-between; font-size: 1.2em; font-weight: bold; }
        .pin-btn { cursor: pointer; color: #474d57; }
        .pin-btn.active { color: #f0b90b; }
        .data-row { display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.9em; }
        .val { color: #f0b90b; }
        #status-bar { color: #848e9c; margin-bottom: 10px; font-size: 0.8em; }
    </style>
</head>
<body>

    <h2>幣安清算型態掃描器</h2>
    <div id="status-bar">正在初始化幣對清單...</div>
    
    <div class="controls">
        <input type="text" id="searchInput" placeholder="搜尋幣對 (如: PIPP) ...">
        <div>掃描頻率: 3秒/次 (分段請求)</div>
    </div>

    <div class="grid" id="mainGrid"></div>

    <script>
        const API_BASE = 'https://api.binance.com';
        let allSymbols = [];
        let pinnedSymbols = new Set(JSON.parse(localStorage.getItem('pinned')) || []);
        let searchFilter = '';

        // 初始化：獲取所有幣對
        async function initSymbols() {
            try {
                const res = await fetch(`${API_BASE}/api/v3/exchangeInfo`);
                const data = await res.json();
                allSymbols = data.symbols
                    .filter(s => s.status === 'TRADING' && s.quoteAsset === 'USDT')
                    .filter(s => !s.symbol.includes('BTC') && !s.symbol.includes('ETH')) // 排除 BTC/ETH 相關
                    .map(s => s.symbol);
                document.getElementById('status-bar').innerText = `已排除 BTC/ETH，正在掃描 ${allSymbols.length} 個 USDT 幣對...`;
                startScanning();
            } catch (e) {
                document.getElementById('status-bar').innerText = '初始化失敗，請檢查網頁是否允許 CORS。';
            }
        }

        // 核心掃描邏輯
        async function startScanning() {
            while (true) {
                // 優先掃描定選的，再掃描搜尋的，最後掃其餘的（分批處理避免封鎖）
                let currentBatch = allSymbols.filter(s => 
                    s.toLowerCase().includes(searchFilter.toLowerCase())
                ).slice(0, 20); // 每次循環只細掃前20個，保護 API 權重

                for (let symbol of currentBatch) {
                    await scanSymbol(symbol);
                    await new Promise(r => setTimeout(r, 150)); // 每小個請求間隔 150ms (符合你要求的拆分封包精神)
                }
                await new Promise(r => setTimeout(r, 3000)); // 大循環間隔 3 秒
            }
        }

        async function scanSymbol(symbol) {
            try {
                // 請求 A: K線 (分析支撐)
                const kRes = await fetch(`${API_BASE}/api/v3/klines?symbol=${symbol}&interval=15m&limit=30`);
                const klines = await kRes.json();
                
                let minLow = Math.min(...klines.map(k => parseFloat(k[3])));
                let avgVol = klines.reduce((a, b) => a + parseFloat(b[5]), 0) / klines.length;

                // 請求 B: 即時價格
                const tRes = await fetch(`${API_BASE}/api/v3/ticker/24hr?symbol=${symbol}`);
                const ticker = await tRes.json();
                
                const lastPrice = parseFloat(ticker.lastPrice);
                const currentVol = parseFloat(ticker.volume) / 96;
                const isAlert = lastPrice < minLow && currentVol > (avgVol * 2);

                updateUI(symbol, lastPrice, minLow, avgVol, currentVol, isAlert);
            } catch (e) { console.error(`${symbol} 請求失敗`); }
        }

        function updateUI(symbol, price, support, avgV, curV, isAlert) {
            let card = document.getElementById(`card-${symbol}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${symbol}`;
                card.className = 'card';
                document.getElementById('mainGrid').appendChild(card);
            }

            const isPinned = pinnedSymbols.has(symbol);
            card.className = `card ${isAlert ? 'alert' : ''} ${isPinned ? 'pinned' : ''}`;
            
            card.innerHTML = `
                <div class="symbol-header">
                    <span>${symbol}</span>
                    <span class="pin-btn ${isPinned ? 'active' : ''}" onclick="togglePin('${symbol}')">★</span>
                </div>
                <div class="data-row"><span>最新價:</span><span class="val">${price}</span></div>
                <div class="data-row"><span>支撐位:</span><span>${support}</span></div>
                <div class="data-row"><span>量能比:</span><span class="${isAlert ? 'alert' : ''}">${(curV/avgV).toFixed(2)}x</span></div>
            `;
            
            // 根據搜尋過濾顯示
            card.style.display = symbol.toLowerCase().includes(searchFilter.toLowerCase()) ? 'block' : 'none';
        }

        function togglePin(symbol) {
            if (pinnedSymbols.has(symbol)) pinnedSymbols.delete(symbol);
            else pinnedSymbols.add(symbol);
            localStorage.setItem('pinned', JSON.stringify([...pinnedSymbols]));
            location.reload(); // 重新整理排序
        }

        document.getElementById('searchInput').oninput = (e) => {
            searchFilter = e.target.value;
        };

        initSymbols();
    </script>
</body>
</html>
