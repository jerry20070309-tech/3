<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>⚡ TRIDENT V33 | 終極策略診斷系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&display=swap');
        body { background: #050505; color: #d4d4d8; font-family: 'JetBrains Mono', monospace; }
        .win-gradient { background: linear-gradient(90deg, #ef4444 0%, #18181b 50%, #22c55e 100%); height: 8px; border-radius: 4px; position: relative; border: 1px solid #222; }
        .pointer { width: 3px; height: 16px; background: #fff; position: absolute; top: -4px; box-shadow: 0 0 10px #fff; transition: left 0.2s; }
        .card-stat { background: #0f0f11; border: 1px solid #1f1f23; transition: all 0.3s; position: relative; }
        .liq-alert { border: 2px solid #ef4444 !important; background: #210808 !important; animation: blink 0.8s infinite; }
        .pinned { border: 1px solid #3b82f6 !important; background: #081121 !important; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .status-tag { font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .tag-reentry { background: #4c1d95; color: #a78bfa; } 
        .tag-vol-up { background: #064e3b; color: #34d399; } 
        .tag-range { background: #27272a; color: #a1a1aa; }
        .del-btn { position: absolute; top: 8px; right: 8px; color: #52525b; cursor: pointer; transition: 0.2s; z-index: 60; }
        .del-btn:hover { color: #ffffff; }
    </style>
</head>
<body class="p-6 h-screen flex flex-col">

    <header class="flex flex-wrap justify-between items-center border-b border-zinc-800 pb-4 mb-6 gap-4">
        <div>
            <h1 class="text-xl font-black italic text-white uppercase tracking-tighter">TRIDENT <span class="text-red-600">V33</span></h1>
            <p id="status" class="text-[10px] text-zinc-500 font-bold uppercase mt-1">趨勢診斷核心已啟動 | 手動刪除已啟用</p>
        </div>
        
        <div class="flex items-center gap-3">
            <input type="text" id="searchInput" placeholder="搜尋幣種..." 
                class="bg-zinc-900 border border-zinc-700 text-xs px-3 py-2 rounded w-40 outline-none focus:border-red-600 text-white uppercase">
            <button id="startBtn" onclick="ignite()" class="bg-red-700 hover:bg-red-600 text-white px-6 py-2 font-black rounded text-xs shadow-lg transition-all">啟動掃描</button>
            <button onclick="location.reload()" class="bg-zinc-800 text-zinc-400 px-3 py-2 rounded text-xs hover:text-white">重置系統</button>
        </div>
    </header>

    <div id="monitorList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 overflow-y-auto flex-1 pr-2"></div>

<script>
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','BNBUSDT'];
    let marketData = {};
    let pinnedSymbols = new Set(JSON.parse(localStorage.getItem('pinned')) || []);

    // 刪除卡片邏輯
    function removeCard(s) {
        const el = document.getElementById(`card-${s}`);
        if(el) el.remove();
        delete marketData[s]; // 徹底從數據追蹤中移除
    }

    // 訂選功能
    function togglePin(s) {
        if (pinnedSymbols.has(s)) pinnedSymbols.delete(s);
        else pinnedSymbols.add(s);
        localStorage.setItem('pinned', JSON.stringify([...pinnedSymbols]));
    }

    async function getOI(s) {
        try {
            const res = await fetch(`https://fapi.binance.com/futures/data/openInterestHist?symbol=${s.toUpperCase()}&period=1h&limit=5`);
            const d = await res.json();
            if (d.length >= 4) {
                const now = parseFloat(d[d.length-1].sumOpenInterest);
                const h1 = parseFloat(d[d.length-2].sumOpenInterest);
                return { h1: ((now - h1) / h1 * 100).toFixed(2) };
            }
        } catch(e) { return { h1: "0.00" }; }
        return { h1: "0.00" };
    }

    async function ignite() {
        document.getElementById('startBtn').classList.add('hidden');
        const statusMsg = document.getElementById('status');
        
        const tickers = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        const targets = tickers.filter(t => t.symbol.endsWith('USDT') && !EXCLUDE.includes(t.symbol))
                               .sort((a,b) => b.quoteVolume - a.quoteVolume).slice(0, 50);

        for (let t of targets) {
            statusMsg.innerText = `加載中: ${t.symbol}`;
            try {
                const k = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${t.symbol}&interval=15m&limit=50`).then(r=>r.json());
                const lows = k.map(x => parseFloat(x[3]));
                const oi = await getOI(t.symbol);
                
                marketData[t.symbol] = {
                    support: Math.min(...lows),
                    avgVol: k.reduce((a,b)=>a+parseFloat(b[5]), 0) / k.length,
                    oi: oi,
                    ratioHistory: [],
                    winRate: 50
                };
            } catch(e) {}
        }
        statusMsg.innerText = "監控中: 手動管理模式";
        startWS();
    }

    function startWS() {
        const ws = new WebSocket('wss://fstream.binance.com/ws/!ticker@arr');
        ws.onmessage = (e) => {
            const searchVal = document.getElementById('searchInput').value.toUpperCase();
            JSON.parse(e.data).forEach(m => {
                const base = marketData[m.s];
                if (!base) return;

                const price = parseFloat(m.c);
                const ratio = ((parseFloat(m.q) / 1440) * 15) / base.avgVol;
                
                base.ratioHistory.push(ratio);
                if(base.ratioHistory.length > 15) base.ratioHistory.shift();
                
                let trend = "盤整"; let tClass = "tag-range";
                const recentRatio = base.ratioHistory.slice(-3).reduce((a,b)=>a+b,0)/3;
                
                if (ratio > 1.5) { trend = "持續放量"; tClass = "tag-vol-up"; }
                if (ratio > 2.2 && recentRatio > 1.2) { trend = "二次趨勢反轉"; tClass = "tag-reentry"; }

                const isLiq = (price < base.support) && (ratio > 2.0);
                const isPinned = pinnedSymbols.has(m.s);
                const isSearching = searchVal && m.s.includes(searchVal);

                if (isSearching || isPinned || ratio > 1.25 || isLiq) {
                    updateUI(m.s, price, ratio, isLiq, base, trend, tClass, isPinned);
                } else {
                    const card = document.getElementById(`card-${m.s}`);
                    if(card) card.remove();
                }
            });
        };
    }

    function updateUI(s, p, r, alert, data, trend, tClass, isPinned) {
        let el = document.getElementById(`card-${s}`);
        if (!el) {
            el = document.createElement('div');
            el.id = `card-${s}`;
            document.getElementById('monitorList').prepend(el);
        }
        
        el.style.order = isPinned ? "-1" : "0";
        el.className = `card-stat p-4 rounded-lg ${alert ? 'liq-alert' : ''} ${isPinned ? 'pinned' : ''}`;
        el.innerHTML = `
            <div onclick="removeCard('${s}')" class="del-btn font-bold text-lg">×</div>
            <div class="flex justify-between items-start mb-2 pr-6">
                <div>
                    <span class="text-xl font-black italic text-white">${s.replace('USDT','')}</span>
                    <button onclick="togglePin('${s}')" class="ml-1 text-xs ${isPinned ? 'text-yellow-500' : 'text-zinc-700'}">★</button>
                </div>
                <span class="status-tag ${tClass}">${trend}</span>
            </div>
            <div class="text-[10px] text-zinc-500 mb-3 font-bold">動能倍率: ${r.toFixed(2)}x</div>
            <div class="win-gradient mb-4">
                <div class="pointer" style="left: 50%"></div>
            </div>
            <div class="space-y-1.5 text-[11px] font-bold">
                <div class="flex justify-between">
                    <span class="text-zinc-600 uppercase tracking-tighter">Price / Support</span>
                    <span class="${p < data.support ? 'text-red-500' : 'text-white'}">${p} / ${data.support.toFixed(4)}</span>
                </div>
                <div class="flex justify-between border-t border-zinc-800 pt-1.5">
                    <span class="text-zinc-600 uppercase tracking-tighter">1H OI Change</span>
                    <span class="${data.oi.h1 < 0 ? 'text-red-500' : 'text-emerald-500'}">${data.oi.h1}%</span>
                </div>
            </div>
        `;
    }
</script>
</body>
</html>
