<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ è¶¨å‹¢æ”¹è®Š V14.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&display=swap');
        body { background: #000; color: #fbbf24; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; padding: 1rem; }
        .card { background: #0a0a0a; border: 1px solid #222; padding: 1rem; border-radius: 4px; transition: 0.2s; }
        .liq-alert { border: 2px solid #ef4444 !important; background: #200 !important; animation: pulse 0.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .log-entry { border-left: 3px solid #ef4444; background: #111; padding: 0.5rem; margin-bottom: 0.5rem; font-size: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="p-4 border-b border-zinc-800 flex justify-between items-center bg-black">
        <h1 class="text-xl font-black italic">âš¡ è¶¨å‹¢æ”¹è®Š V14.0 (WSç‰ˆ)</h1>
        <div class="flex gap-4 items-center">
            <span id="status" class="text-[10px] text-zinc-500 uppercase">æº–å‚™å°±ç·’</span>
            <button id="ctrlBtn" onclick="toggleSystem()" class="bg-fbbf24 text-black px-6 py-1 font-bold rounded hover:bg-yellow-500">å•Ÿå‹•ç›£æ§</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <main id="dashboard" class="flex-1 grid-container overflow-y-auto"></main>
        <aside class="w-80 border-l border-zinc-800 bg-zinc-950 p-4 flex flex-col">
            <h2 class="text-red-500 font-bold mb-4 text-sm uppercase">æ¸…ç®—ç•°å¸¸æ—¥èªŒ</h2>
            <div id="log" class="flex-1 overflow-y-auto"></div>
        </aside>
    </div>

<script>
    const API_BASE = 'https://api.binance.com';
    const WS_BASE = 'wss://stream.binance.com:9443/ws';
    let isRunning = false;
    let socket = null;
    let dataMap = {};
    
    // ä½ æŒ‡å®šçš„ç›£æ§ç›®æ¨™ï¼ˆå¯è‡ªç”±å¢æ¸›ï¼‰
    const SYMBOLS = ['PIPPINUSDT', 'BNBUSDT', 'ADAUSDT', 'LTCUSDT', 'NEOUSDT', 'QTUMUSDT'];

    // 1. åˆå§‹åŒ–æ”¯æ’ä½ (åƒ…åœ¨å•Ÿå‹•æ™‚åŸ·è¡Œä¸€æ¬¡ï¼Œä¸é‡è¤‡è«‹æ±‚)
    async function initBaseData() {
        document.getElementById('status').innerText = "æ­£åœ¨å»ºç«‹æ”¯æ’åŸºæº–...";
        for (let s of SYMBOLS) {
            try {
                const res = await fetch(`${API_BASE}/api/v3/klines?symbol=${s}&interval=15m&limit=50`);
                const klines = await res.json();
                const lows = klines.map(k => parseFloat(k[3]));
                const volumes = klines.map(k => parseFloat(k[5]));
                
                dataMap[s] = {
                    symbol: s,
                    support: Math.min(...lows), // 50æ ¹Kç·šæœ€ä½é»
                    avgVol: volumes.reduce((a, b) => a + b, 0) / volumes.length, // å¹³å‡æˆäº¤é‡
                    price: 0,
                    volRatio: 0,
                    isLiq: false
                };
                // æ¯å€‹å¹£ç¨®é–“éš” 200msï¼Œé˜²æ­¢åˆå§‹è«‹æ±‚éå¿«
                await new Promise(r => setTimeout(r, 200));
            } catch (e) { console.error(`${s} åˆå§‹åŒ–å¤±æ•—`); }
        }
        startWebSocket();
    }

    // 2. WebSocket æ¥æ”¶æ•¸æ“š (é€™è§£æ±ºäº†ä½ æˆªåœ–ä¸­ fetch çˆ†é‡çš„å•é¡Œ)
    function startWebSocket() {
        const streams = SYMBOLS.map(s => `${s.toLowerCase()}@ticker`).join('/');
        socket = new WebSocket(`${WS_BASE}/${streams}`);

        socket.onopen = () => { document.getElementById('status').innerText = "WS é€£ç·šæ­£å¸¸ - ç›£æ§ä¸­"; };

        socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            const s = msg.s;
            const target = dataMap[s];
            if (!target) return;

            target.price = parseFloat(msg.c);
            const curVol = parseFloat(msg.v) / 96; // æ›ç®—ç‚º 15m ä¼°è¨ˆé‡
            target.volRatio = (curVol / target.avgVol).toFixed(2);

            // ç­–ç•¥æ ¸å¿ƒï¼šåƒ¹æ ¼ < æ”¯æ’ ä¸” æˆäº¤é‡ > 2.5å€å‡é‡
            const priceDropped = target.price < target.support;
            const volumeExploded = target.volRatio > 2.5;

            if (priceDropped && volumeExploded) {
                if (!target.isLiq) {
                    pushLog(s, target.price, target.volRatio);
                    target.isLiq = true;
                }
            } else {
                target.isLiq = false;
            }
            render();
        };
    }

    function render() {
        const container = document.getElementById('dashboard');
        container.innerHTML = SYMBOLS.map(s => {
            const d = dataMap[s];
            if (!d) return `<div class="card">è¼‰å…¥ä¸­...</div>`;
            return `
                <div class="card ${d.isLiq ? 'liq-alert' : ''}">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-white text-lg font-bold">${s}</span>
                        <span class="text-[10px] bg-zinc-800 px-2 py-0.5 text-zinc-400">15M ç›£æ§</span>
                    </div>
                    <div class="space-y-2 text-[11px]">
                        <div class="flex justify-between"><span>ç•¶å‰åƒ¹æ ¼</span><span class="text-white font-bold">${d.price}</span></div>
                        <div class="flex justify-between"><span>æ”¯æ’ä½(50K)</span><span class="text-zinc-500">${d.support}</span></div>
                        <div class="flex justify-between border-t border-zinc-900 pt-2">
                            <span>é‡èƒ½å¼·åº¦</span>
                            <span class="${d.volRatio > 2.5 ? 'text-red-500' : 'text-green-500'} font-bold">${d.volRatio}x</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function pushLog(s, p, r) {
        const log = document.getElementById('log');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `<div>ğŸš¨ <b>${s}</b> è§¸ç™¼æ¸…ç®—å‹æ…‹</div>
                           <div class="text-zinc-500">åƒ¹æ ¼: ${p} | é‡èƒ½: ${r}x | æ™‚é–“: ${new Date().toLocaleTimeString()}</div>`;
        log.prepend(entry);
    }

    function toggleSystem() {
        isRunning = !isRunning;
        const btn = document.getElementById('ctrlBtn');
        if (isRunning) {
            btn.innerText = "åœæ­¢ç›£æ§";
            btn.className = "bg-red-600 text-white px-6 py-1 font-bold rounded";
            initBaseData();
        } else {
            if (socket) socket.close();
            location.reload(); // ç°¡å–®é‡ç½®
        }
    }
</script>
</body>
</html>
