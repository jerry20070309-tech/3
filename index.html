// --- 1. é€™è£¡æ˜¯ä½ åŸæœ¬çš„ç­–ç•¥æ ¸å¿ƒåƒæ•¸ (ç”± Slider æ§åˆ¶) ---
let FILTER = { SQZ: 0.012, POC: 0.011, SLP: -0.15, DRV: 90, MOM: 0.008 };

async function coreStrategyScanner() {
    const res = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
    const tickers = await res.json();
    
    tickers.forEach(t => {
        const s = t.symbol;
        if (!s.endsWith('USDT')) return;

        // --- 2. å¸¶å…¥ä½ çš„è©•åˆ†å…¬å¼é‚è¼¯ ---
        const price = parseFloat(t.lastPrice);
        const avgPrice = parseFloat(t.weightedAvgPrice);
        const maSqz = (parseFloat(t.highPrice) - parseFloat(t.lowPrice)) / avgPrice;
        const drvScore = Math.min(100, (Math.abs(parseFloat(t.priceChangePercent)) / (parseFloat(t.quoteVolume) / 1e8)) * 15);
        
        // è©•åˆ†è¨ˆç®— (ä¾ç…§ä½ æä¾›çš„ V11.8 é‚è¼¯)
        let score = 0;
        if (maSqz <= FILTER.SQZ) score += 25;
        if (Math.abs(parseFloat(t.priceChangePercent))/100 >= FILTER.POC) score += 25;
        if (drvScore >= FILTER.DRV) score += 35;
        // ... å…¶ä»– SLP èˆ‡ M7 åˆ¤æ–· ...

        // --- 3. é—œéµæ©‹æ¥ï¼šè©•åˆ†éæ¿¾ ---
        if (score >= 75) {
            // åªæœ‰åˆ†æ•¸å¤ é«˜ï¼Œæ‰ä¸Ÿé€²å»ç›£æ§å™¨é¡¯ç¤ºã€Œå·¨é¯¨ã€çˆ†å€‰ã€æ›å–®ã€
            startWhaleSniper(s, score, price);
        } else {
            stopWhaleSniper(s);
        }
    });
}

// --- 4. æ·±åº¦æ•¸æ“šç›£æ§æ¨¡çµ„ (é¡¯ç¤ºä½ è¦çš„æ•¸æ“š) ---
function startWhaleSniper(symbol, score, currentPrice) {
    if (activeMonitors.has(symbol)) return; // é¿å…é‡è¤‡é€£ç·š
    
    // é–‹å•Ÿ WebSocket ç›£æ§çˆ†å€‰ (forceOrder) èˆ‡ èšåˆå¤§å–® (aggTrade)
    const ws = new WebSocket(`wss://fstream.binance.com/ws/${symbol.toLowerCase()}@aggTrade/${symbol.toLowerCase()}@forceOrder`);
    
    ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        
        // A. åµæ¸¬çˆ†å€‰é‡
        if (data.e === "forceOrder") {
            const liqAmount = parseFloat(data.o.q) * parseFloat(data.o.p);
            addLog(`ğŸ’€ [çˆ†å€‰è­¦å‘Š] ${symbol} åƒ¹å€¼: $${liqAmount.toFixed(0)}`);
        }
        
        // B. åµæ¸¬å·¨é¯¨å¤§å–®
        if (data.e === "aggTrade") {
            const tradeVal = parseFloat(data.q) * parseFloat(data.p);
            if (tradeVal >= 50000) {
                addLog(`ğŸ‹ [å·¨é¯¨æˆäº¤] ${symbol} é‡‘é¡: $${tradeVal.toFixed(0)}`);
            }
        }
    };
    
    // C. ç²å–å·¨å¤§æ›å–®åƒ¹æ ¼ä½ (æŠ“å– Order Book)
    updateOrderWall(symbol);
}
