import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.time.Duration;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;
import com.google.gson.JsonArray;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;

/**
 * åŠŸèƒ½ï¼šç›£æ§å¹£å®‰ PIPPINSUDT
 * ç‰¹å¾µï¼šåµæ¸¬ã€Œç¸®é‡æ©«ç›¤å¾Œï¼Œæ”¾é‡è·Œç ´æ”¯æ’ï¼ˆæ¸…ç®—å¤šå–®ï¼‰ã€çš„å‹æ…‹
 * é »ç‡ï¼šæ¯ 3 ç§’ä¸€å€‹å¾ªç’°ï¼Œæ‹†åˆ†ç‚ºå…©å€‹è«‹æ±‚å°åŒ…
 */
public class BinanceLiquidationScanner {

    // å¹£å®‰ç¾è²¨ API
    private static final String BASE_URL = "https://api.binance.com";
    private static final String SYMBOL = "PIPPINUSDT";
    
    // é–€æª»è¨­å®š
    private static final int LOOKBACK_PERIOD = 50; // è§€å¯Ÿéå» 50 æ ¹ K ç·š
    private static final double VOLUME_SPIKE_RATIO = 2.5; // æˆäº¤é‡éœ€å¤§æ–¼å‡å€¼ 2.5 å€

    private final HttpClient httpClient;
    private double supportLevel = 0.0;
    private double avgVolume = 0.0;

    public BinanceLiquidationScanner() {
        this.httpClient = HttpClient.newBuilder()
                .connectTimeout(Duration.ofSeconds(5))
                .build();
    }

    public void start() {
        ScheduledExecutorService scheduler = Executors.newSingleThreadScheduledExecutor();
        System.out.println(">>> å•Ÿå‹•ç›£æ§: " + SYMBOL);
        System.out.println(">>> ç­–ç•¥ï¼šåµæ¸¬ç¸®é‡æ©«ç›¤å¾Œçš„ã€Œæ”¾é‡æ¸…ç®—ã€...");

        scheduler.scheduleAtFixedRate(() -> {
            try {
                // --- å°åŒ… 1: è«‹æ±‚ K ç·šæ•¸æ“š (åˆ†æèƒŒæ™¯) ---
                String klineUrl = BASE_URL + "/api/v3/klines?symbol=" + SYMBOL + "&interval=15m&limit=" + LOOKBACK_PERIOD;
                String klineJson = fetch(klineUrl);
                calculateBaseLine(klineJson);

                // å¼·åˆ¶ç­‰å¾… 1.5 ç§’ï¼Œç¢ºä¿å…©å€‹å°åŒ…è«‹æ±‚åœ¨æ™‚é–“ä¸Šå®Œå…¨åˆ†é–‹
                Thread.sleep(1500);

                // --- å°åŒ… 2: è«‹æ±‚æœ€æ–° Ticker (åµæ¸¬ç•°å‹•) ---
                String tickerUrl = BASE_URL + "/api/v3/ticker/24hr?symbol=" + SYMBOL;
                String tickerJson = fetch(tickerUrl);
                detectLiquidation(tickerJson);

            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            } catch (Exception e) {
                System.err.println("[ç³»çµ±éŒ¯èª¤] " + e.getMessage());
            }
        }, 0, 3, TimeUnit.SECONDS);
    }

    private String fetch(String url) throws Exception {
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(url))
                .GET()
                .header("Accept", "application/json")
                .build();
        return httpClient.send(request, HttpResponse.BodyHandlers.ofString()).body();
    }

    private void calculateBaseLine(String json) {
        JsonArray klines = JsonParser.parseString(json).getAsJsonArray();
        double minLow = Double.MAX_VALUE;
        double totalVol = 0;

        for (int i = 0; i < klines.size(); i++) {
            JsonArray k = klines.get(i).getAsJsonArray();
            // Kç·šçµæ§‹: [0]Time, [1]Open, [2]High, [3]Low, [4]Close, [5]Volume
            double low = k.get(3).getAsDouble();
            double vol = k.get(5).getAsDouble();
            
            if (low < minLow) minLow = low;
            totalVol += vol;
        }
        this.supportLevel = minLow;
        this.avgVolume = totalVol / klines.size();
    }

    private void detectLiquidation(String json) {
        JsonObject ticker = JsonParser.parseString(json).getAsJsonObject();
        double currentPrice = ticker.get("lastPrice").getAsDouble();
        double currentVol = ticker.get("volume").getAsDouble() / 96; // ç°¡å–®ä¼°ç®—ç•¶å‰ 15m çš„å³æ™‚é‡

        boolean priceDropped = currentPrice < supportLevel;
        boolean volumeExploded = currentVol > (avgVolume * VOLUME_SPIKE_RATIO);

        if (priceDropped && volumeExploded) {
            System.out.println("\nğŸ”¥ [è­¦å‘Š] åµæ¸¬åˆ°æ¸…ç®—å‹æ…‹ï¼");
            System.out.println("ç•¶å‰åƒ¹æ ¼ " + currentPrice + " è·Œç ´æ”¯æ’ " + supportLevel);
            System.out.println("æˆäº¤é‡é¡¯è‘—æ”¾å¤§ï¼Œå¤šå–®å¯èƒ½æ­£åœ¨è¢«å¼·åˆ¶å¹³å€‰ï¼");
        } else {
            System.out.print("."); // é‹è¡Œä¸­å¿ƒè·³åŒ…é¡¯ç¤º
        }
    }

    public static void main(String[] args) {
        // ç¢ºä¿å°ˆæ¡ˆä¸­å·²å¼•å…¥ Gson ä¾è³´
        new BinanceLiquidationScanner().start();
    }
}
