<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>V15 QUANT ENGINE</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#050505;color:#d4d4d8;font-family:'Courier New',monospace;font-size:13px}
.top-panel{padding:14px 18px;border-bottom:1px solid #1a1a1a;background:#0a0a0c;display:flex;flex-wrap:wrap;gap:12px;align-items:center}
.top-panel input{background:#111;border:1px solid #333;color:#d4d4d8;padding:6px 10px;border-radius:4px;width:200px}
.btn{padding:6px 14px;border:none;border-radius:4px;cursor:pointer;font-family:monospace;font-size:13px;font-weight:bold}
.btn-green{background:#16a34a;color:#fff}
.btn-red{background:#dc2626;color:#fff}
.btn-gray{background:#374151;color:#d4d4d8}
.btn-yellow{background:#92400e;color:#fcd34d}
.status-bar{padding:10px 18px;border-bottom:1px solid #1a1a1a;background:#0d0d10;display:flex;gap:20px;flex-wrap:wrap}
.stat{display:flex;flex-direction:column;gap:2px}
.stat-label{font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1px}
.stat-value{font-size:14px;font-weight:bold}
.score-bar{padding:8px 18px;border-bottom:1px solid #1a1a1a;background:#0a0a0c;display:flex;gap:20px;flex-wrap:wrap;align-items:center}
.score-bar span{font-size:13px}
.STRONG-txt{color:#22c55e}.BREAK-txt{color:#3b82f6}.BUILD-txt{color:#f59e0b}.RADAR-txt{color:#a855f7}.IDLE-txt{color:#444}
#cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:10px;padding:14px}
.card{background:#0f0f11;border:1px solid #222;border-radius:6px;padding:12px;transition:border .2s}
.card.STRONG{border:2px solid #22c55e;background:#080e08}
.card.BREAK{border:2px solid #3b82f6;background:#080a10}
.card.BUILD{border:2px solid #f59e0b;background:#100d04}
.card.RADAR{border:2px solid #a855f7;background:#0c0810}
.card.IDLE{border:1px solid #1e1e1e}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.card-symbol{font-size:15px;font-weight:bold}
.card-state{font-size:11px;padding:2px 7px;border-radius:3px;font-weight:bold}
.state-STRONG{background:#14532d;color:#86efac}
.state-BREAK{background:#1e3a5f;color:#93c5fd}
.state-BUILD{background:#451a03;color:#fcd34d}
.state-RADAR{background:#2e1065;color:#c4b5fd}
.state-IDLE{background:#1a1a1a;color:#555}
.card-score{font-size:24px;font-weight:bold;margin-bottom:6px}
.score-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:2px 6px;font-size:11px;color:#888;margin-bottom:8px}
.score-item{display:flex;justify-content:space-between;gap:4px}
.score-item .sv{color:#d4d4d8;font-weight:bold}
.divider{border:none;border-top:1px solid #1e1e1e;margin:6px 0}
.card-risk{font-size:11px;display:grid;grid-template-columns:auto 1fr;gap:3px 10px}
.card-risk .rl{color:#888}
.card-risk .rv{color:#d4d4d8;font-weight:bold}
.tp-val{color:#22c55e}.sl-val{color:#ef4444}
.alert-exit{color:#ef4444;font-weight:bold;font-size:11px;margin-top:4px;padding:3px 6px;background:#200808;border-radius:3px}
.trail-row{color:#f59e0b;font-size:11px;margin-top:4px}
.lock-badge{font-size:10px;color:#555;margin-top:3px}
.warn-badge{font-size:10px;color:#f59e0b;margin-top:2px}
.log-panel{position:fixed;bottom:0;left:0;right:0;height:120px;background:#050505;border-top:1px solid #1a1a1a;overflow-y:auto;padding:6px 14px;font-size:11px}
.log-line{padding:1px 0;border-bottom:1px solid #0d0d0d}
.log-line.info{color:#4b7fa8}.log-line.warn{color:#a87a2a}
.log-line.signal{color:#22c55e;font-weight:bold}
.log-line.exit{color:#ef4444;font-weight:bold}
.log-line.err{color:#7f1d1d}
.spacer{height:130px}
</style>
</head>
<body>

<div class="top-panel">
  <button class="btn btn-green" onclick="startEngine()">â–¶ é–‹å§‹æƒæ</button>
  <button class="btn btn-red" onclick="stopEngine()">â–  åœæ­¢</button>
  <input id="tgToken" placeholder="Telegram Bot Token">
  <input id="tgChat" placeholder="Chat ID">
  <button class="btn btn-gray" onclick="testPush()">æ¸¬è©¦æ¨æ’­</button>
  <button class="btn btn-yellow" onclick="clearLocks()">æ¸…é™¤é–å®š</button>
</div>

<div class="status-bar">
  <div class="stat"><span class="stat-label">å¼•æ“</span><span class="stat-value" id="engSt" style="color:#ef4444">OFF</span></div>
  <div class="stat"><span class="stat-label">ç›£æ§å¹£æ•¸</span><span class="stat-value" id="uniCnt">0</span></div>
  <div class="stat"><span class="stat-label">WSç‹€æ…‹</span><span class="stat-value" id="wsSt" style="color:#ef4444">â€”</span></div>
  <div class="stat"><span class="stat-label">è¼ªæ›¿å€’æ•¸</span><span class="stat-value" id="rotTmr">â€”</span></div>
  <div class="stat"><span class="stat-label">æœ€å¾Œæ›´æ–°</span><span class="stat-value" id="lastUpd">â€”</span></div>
  <div class="stat"><span class="stat-label">REST/åˆ†</span><span class="stat-value" id="reqR">0</span></div>
</div>

<div class="score-bar">
  <span class="STRONG-txt" id="cS">STRONG:0</span>
  <span class="BREAK-txt" id="cB">BREAK:0</span>
  <span class="BUILD-txt" id="cBu">BUILD:0</span>
  <span class="RADAR-txt" id="cR">RADAR:0</span>
  <span class="IDLE-txt" id="cI">IDLE:0</span>
  <span style="color:#666;margin-left:12px;font-size:11px">
    é€²å ´é–€æª»: <span id="thrLabel" style="color:#f59e0b">BUILD(65åˆ†)</span>
  </span>
  <button class="btn btn-gray" style="font-size:11px;padding:3px 8px" onclick="cycleThr()">åˆ‡æ›é–€æª»</button>
</div>

<div id="cards"></div>
<div class="spacer"></div>
<div class="log-panel" id="logPanel"></div>

<script>
'use strict'
///////////////////////////////////////////////////////////////
// V15.2 QUANT ENGINE
// ä¿®æ­£ï¼š
//  1. è¶…ä½åƒ¹å¹£ç²¾åº¦ä¿®æ­£ï¼ˆå‹•æ…‹å°æ•¸ä½ï¼‰
//  2. calcVPOC ç²¾åº¦ä¿®æ­£ï¼ˆæ”¹ç”¨ç›¸å°åº§æ¨™è¨ˆç®—ï¼‰
//  3. ATR é˜²ç²¾åº¦æå¤±ï¼ˆæ”¹ç”¨å°æ•¸å·®è¨ˆç®—ï¼‰
//  4. æ­¢ææœ€å°è·é›¢ä¿è­·ï¼ˆé˜²æ­¢æ­¢æ=é€²å ´ï¼‰
//  5. TP1 è¨ˆç®—ä¿®æ­£ï¼ˆç¢ºä¿ resistance > priceï¼‰
//  6. pushLock çœŸæ­£é˜²é‡è¤‡ï¼ˆåŠ æœ€çŸ­å†·å»æ™‚é–“æˆ³ï¼‰
//  7. æ§“æ¡¿ä¸Šé™å®‰å…¨é–ï¼ˆstopDist<0.3% æ™‚ä¸å»ºè­°é€²å ´ï¼‰
///////////////////////////////////////////////////////////////

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¼•æ“è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ENGINE={
    running:false,
    universeSize:30,
    rotationInterval:30*60*1000,
    reconnectDelay:5000,
    oiQueueInterval:800,
    strategyInterval:3000,
    uiInterval:2000,
    historyBars:300,
    minBars15:100,
    minBars1:50,
    maxStreamPerWS:180,
    stopMinDist:0.8,        // æ­¢æè·é›¢æœ€å°å€¼%ï¼ˆä½æ–¼æ­¤ä¸æ¨æ’­ï¼Œé˜²æ­¢æ­¢æ=é€²å ´ï¼‰
    stopMaxDist:8.0,        // æ­¢æè·é›¢æœ€å¤§å€¼%ï¼ˆå¤ªé æ§“æ¡¿å¤ªä½æ²’æ„ç¾©ï¼‰
    riskPct:1,              // æ¯ç­†å›ºå®šé¢¨éšª%
    maxLev:20,              // æ§“æ¡¿ä¸Šé™
    // ç§»å‹•æ­¢æä¸‰æ®µ
    trail1Pct:5,            // æµ®ç›ˆ5% â†’ æ­¢æåˆ°æˆæœ¬
    trail2Pct:10,           // æµ®ç›ˆ10% â†’ æ­¢æåˆ°+3%
    trail2Loc:3,
    trail3Pct:20,           // æµ®ç›ˆ20% â†’ æ­¢æåˆ°+8%
    trail3Loc:8,
    tpAtrMult:3.0,          // TP2 = é€²å ´åƒ¹ + 1m ATRÃ—3
    // é˜²é‡è¤‡æ¨æ’­ï¼šåŒä¸€å¹£ç¨®è‡³å°‘é–“éš”Nåˆ†é˜
    pushCooldownMs:15*60*1000,  // 15åˆ†é˜å…§ä¸é‡è¤‡æ¨åŒä¸€å¹£
    pushCooldownBars:25,         // åˆ†æ•¸æ‰å‡ºå¾Œé‡ç½®æ‰€éœ€è¼ªæ¬¡
    // æ­¢æ Volume Profile è¨­å®š
    vpBuckets:60,           // æé«˜æ¡¶æ•¸ï¼Œæ”¹å–„ä½åƒ¹å¹£ç²¾åº¦
    vpMinStopBuffer:0.003,  // æ­¢æç·©è¡ï¼ˆ0.3%ï¼‰
    vpFallback:0.015,       // VP å¤±æ•ˆæ™‚æ”¹ç”¨ ATRÃ—1.5 ä½œæ­¢æç·©è¡
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é€²å ´é–€æª» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const THR_LEVELS=[
    {label:'RADAR(50åˆ†)', score:50},
    {label:'BUILD(65åˆ†)', score:65},
    {label:'BREAK(82åˆ†)', score:82},
    {label:'STRONG(98åˆ†)',score:98},
]
let thrIdx=1
function cycleThr(){
    thrIdx=(thrIdx+1)%THR_LEVELS.length
    document.getElementById('thrLabel').textContent=THR_LEVELS[thrIdx].label
    log(`é–€æª»åˆ‡æ›ï¼š${THR_LEVELS[thrIdx].label}`,'warn')
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ’é™¤å¤§å¹£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EXCLUDED_TOP35=new Set([
"BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT",
"ADAUSDT","DOGEUSDT","AVAXUSDT","TRXUSDT","DOTUSDT",
"MATICUSDT","LTCUSDT","LINKUSDT","BCHUSDT","ATOMUSDT",
"UNIUSDT","ETCUSDT","XLMUSDT","FILUSDT","APTUSDT",
"ARBUSDT","OPUSDT","NEARUSDT","INJUSDT","STXUSDT",
"RUNEUSDT","SUIUSDT","SEIUSDT","TIAUSDT","GALAUSDT",
"SANDUSDT","MANAUSDT","AAVEUSDT","MKRUSDT","SNXUSDT"
])

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…¨åŸŸç‹€æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let STREAM_SOCKETS=[]
let SYMBOL_POOL={}
let BTC_POOL={k15:[],k1:[],lastPrice:0}
let CURRENT_UNIVERSE=[]
let OI_QUEUE_IDX=0
let rotationLeft=ENGINE.rotationInterval
let reqCount=0,reqCountMin=0,lastReqReset=Date.now()
let rotationTimer=null,oiTimer=null,strategyTimer=null,uiTimer=null

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Symbol çµæ§‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createEmptySymbol(){
    return{
        lastPrice:0, quoteVolume:0,
        k15:[], k1:[],
        oi:0, prevOI:0, oiHistory:[],
        state:"IDLE", score:0, scoreDetails:{},
        // é¢¨æ§æ¬„ä½
        stopPrice:0,
        stopDist:0,
        tp1:0,
        tp2:0,
        suggestLev:1,
        stopValid:false,    // æ­¢ææ˜¯å¦æœ‰æ•ˆï¼ˆè·é›¢åœ¨åˆç†ç¯„åœå…§ï¼‰
        // å‡ºå ´è¿½è¹¤
        exitCheckOIDown:0,
        exitVolDown:false,
        exitNoNewHigh:false,
        lastHigh:0,
        whaleExit:false,
        exitReason:'',
        // æ¨æ’­æ§åˆ¶
        pushLock:false,
        pushLockTs:0,       // æ¨æ’­æ™‚é–“æˆ³ï¼ˆç”¨æ–¼å†·å»åˆ¤æ–·ï¼‰
        pushCooldown:0,
        exitLock:false,
        // ç§»å‹•æ­¢æ
        inPosition:false,
        entryPrice:0,
        trailStage:0,
        currentStop:0,
        // é›œé …
        oiChange:0, volRatio:0,
        sym1hRet:0, btc1hRet:0,
        poc:0, pocResistance:0,
        atr1m:0,
    }
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ—¥èªŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAX_LOG=150
function log(msg,type='info'){
    let p=document.getElementById('logPanel')
    if(!p) return
    let d=document.createElement('div')
    d.className='log-line '+type
    d.textContent=`[${new Date().toTimeString().slice(0,8)}] ${msg}`
    p.insertBefore(d,p.firstChild)
    let ls=p.querySelectorAll('.log-line')
    if(ls.length>MAX_LOG) ls[ls.length-1].remove()
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è«‹æ±‚è¨ˆæ•¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function countReq(){
    reqCount++
    if(Date.now()-lastReqReset>60000){
        reqCountMin=reqCount; reqCount=0; lastReqReset=Date.now()
    }
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å®‰å…¨ fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function safeFetch(url,timeout=9000){
    countReq()
    let ctrl=new AbortController()
    let tid=setTimeout(()=>ctrl.abort(),timeout)
    try{
        let r=await fetch(url,{signal:ctrl.signal})
        clearTimeout(tid)
        if(!r.ok) throw new Error(`HTTP ${r.status}`)
        return await r.json()
    }catch(e){ clearTimeout(tid); throw e }
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å•Ÿå‹• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startEngine(){
    if(ENGINE.running){log('å·²åœ¨é‹è¡Œ','warn');return}
    ENGINE.running=true
    setEngUI(true)
    log('V15.2 å¼•æ“å•Ÿå‹•','info')
    try{ await buildUniverse() }
    catch(e){
        log('Universeå¤±æ•—:'+e.message,'err')
        ENGINE.running=false; setEngUI(false); return
    }
    await warmUpHistory()
    connectAllSockets()
    startOIQueue()

    rotationTimer=setInterval(async()=>{
        if(!ENGINE.running) return
        log('30åˆ†é˜è¼ªæ›¿','warn')
        rotationLeft=ENGINE.rotationInterval
        await rotateUniverse()
    },ENGINE.rotationInterval)

    strategyTimer=setInterval(()=>{
        if(!ENGINE.running) return
        CURRENT_UNIVERSE.forEach(s=>runStrategy(s))
    },ENGINE.strategyInterval)

    uiTimer=setInterval(()=>{
        if(!ENGINE.running) return
        renderCards(); updateStatusBar()
    },ENGINE.uiInterval)

    setInterval(()=>{
        if(!ENGINE.running) return
        rotationLeft=Math.max(0,rotationLeft-1000)
        let m=Math.floor(rotationLeft/60000),sc=Math.floor((rotationLeft%60000)/1000)
        document.getElementById('rotTmr').textContent=`${m}m ${sc}s`
    },1000)
}

function stopEngine(){
    ENGINE.running=false
    STREAM_SOCKETS.forEach(ws=>{try{ws.close()}catch(e){}})
    STREAM_SOCKETS=[]
    ;[rotationTimer,oiTimer,strategyTimer,uiTimer].forEach(t=>{if(t)clearInterval(t)})
    setEngUI(false)
    log('å¼•æ“åœæ­¢','warn')
}

function setEngUI(on){
    let el=document.getElementById('engSt')
    el.textContent=on?'ON':'OFF'
    el.style.color=on?'#22c55e':'#ef4444'
    if(!on){
        document.getElementById('wsSt').textContent='â€”'
        document.getElementById('wsSt').style.color='#ef4444'
    }
}

function clearLocks(){
    CURRENT_UNIVERSE.forEach(s=>{
        if(SYMBOL_POOL[s]){
            SYMBOL_POOL[s].pushLock=false
            SYMBOL_POOL[s].pushLockTs=0
            SYMBOL_POOL[s].pushCooldown=0
            SYMBOL_POOL[s].exitLock=false
        }
    })
    log('æ¨æ’­é–å…¨æ¸…','warn')
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å»ºç«‹ Universe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function buildUniverse(){
    log('å–å¾—åˆç´„æ¸…å–®...','info')
    let [tickers,exInfo]=await Promise.all([
        safeFetch("https://fapi.binance.com/fapi/v1/ticker/24hr"),
        safeFetch("https://fapi.binance.com/fapi/v1/exchangeInfo")
    ])
    let valid=new Set(), onboard={}
    ;(exInfo.symbols||[]).forEach(s=>{
        if(s.symbol.endsWith("USDT")&&s.contractType==="PERPETUAL"&&s.status==="TRADING"){
            valid.add(s.symbol)
            if(s.onboardDate) onboard[s.symbol]=s.onboardDate
        }
    })
    log(`æœ‰æ•ˆæ°¸çºŒåˆç´„ï¼š${valid.size}`,'info')
    let now=Date.now(), minAge=3*86400000
    let filtered=tickers
        .filter(t=>valid.has(t.symbol))
        .filter(t=>!EXCLUDED_TOP35.has(t.symbol))
        .filter(t=>{ let ob=onboard[t.symbol]; return !ob||(now-ob)>minAge })
        .filter(t=>parseFloat(t.quoteVolume)>5000000)
        .sort((a,b)=>parseFloat(b.quoteVolume)-parseFloat(a.quoteVolume))
        .slice(0,ENGINE.universeSize)
    CURRENT_UNIVERSE=filtered.map(t=>t.symbol)
    CURRENT_UNIVERSE.forEach(s=>{
        if(!SYMBOL_POOL[s]) SYMBOL_POOL[s]=createEmptySymbol()
        SYMBOL_POOL[s].quoteVolume=parseFloat(filtered.find(f=>f.symbol===s)?.quoteVolume||0)
    })
    OI_QUEUE_IDX=0
    log(`Universeï¼š${CURRENT_UNIVERSE.length}å¹£`,'info')
    document.getElementById('uniCnt').textContent=CURRENT_UNIVERSE.length
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é ç†± K ç·š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function warmUpHistory(){
    log('é ç†±Kç·š...','warn')
    const BATCH=5, DELAY=900
    try{
        let [b15,b1]=await Promise.all([
            safeFetch(`https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=15m&limit=200`),
            safeFetch(`https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=1m&limit=120`)
        ])
        BTC_POOL.k15=b15.map(pk); BTC_POOL.k1=b1.map(pk)
        BTC_POOL.lastPrice=BTC_POOL.k15.at(-1)?.close||0
        log('BTC Kç·šOK','info')
    }catch(e){log('BTC Kç·šå¤±æ•—','err')}
    for(let i=0;i<CURRENT_UNIVERSE.length;i+=BATCH){
        let batch=CURRENT_UNIVERSE.slice(i,i+BATCH)
        await Promise.all(batch.map(async sym=>{
            try{
                let [k15,k1]=await Promise.all([
                    safeFetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=15m&limit=200`),
                    safeFetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=1m&limit=120`)
                ])
                let s=SYMBOL_POOL[sym]; if(!s) return
                s.k15=k15.map(pk); s.k1=k1.map(pk)
                s.lastPrice=s.k15.at(-1)?.close||0
            }catch(e){ log(`${sym} é ç†±å¤±æ•—`,'err') }
        }))
        if(i+BATCH<CURRENT_UNIVERSE.length) await sleep(DELAY)
    }
    log('Kç·šé ç†±å®Œæˆ','info')
}

function pk(k){
    return{open:+k[1],high:+k[2],low:+k[3],close:+k[4],volume:+k[5]}
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¼ªæ›¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function rotateUniverse(){
    STREAM_SOCKETS.forEach(ws=>{try{ws.close()}catch(e){}})
    STREAM_SOCKETS=[]; CURRENT_UNIVERSE=[]
    try{
        await buildUniverse(); await warmUpHistory(); connectAllSockets()
    }catch(e){ log('è¼ªæ›¿å¤±æ•—:'+e.message,'err') }
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectAllSockets(){
    let streams=["btcusdt@kline_15m","btcusdt@kline_1m"]
    CURRENT_UNIVERSE.forEach(s=>{
        streams.push(`${s.toLowerCase()}@kline_15m`,`${s.toLowerCase()}@kline_1m`)
    })
    let chunks=[]
    for(let i=0;i<streams.length;i+=ENGINE.maxStreamPerWS)
        chunks.push(streams.slice(i,i+ENGINE.maxStreamPerWS))
    log(`å»ºç«‹${chunks.length}æ¢WSï¼Œå…±${streams.length}streams`,'info')
    chunks.forEach((c,i)=>openWS(c,i))
}

function openWS(streams,idx){
    let url="wss://fstream.binance.com/stream?streams="+streams.join("/")
    let ws=new WebSocket(url)
    STREAM_SOCKETS[idx]=ws
    ws.onopen=()=>{
        log(`WS[${idx}]é€£ç·š(${streams.length})`,'info')
        let el=document.getElementById('wsSt')
        el.textContent='LIVE'; el.style.color='#22c55e'
    }
    ws.onmessage=(e)=>{
        try{
            let msg=JSON.parse(e.data)
            let d=msg.data||msg
            if(d&&d.k) processKline(d)
        }catch(err){}
    }
    ws.onerror=()=>log(`WS[${idx}]éŒ¯èª¤`,'err')
    ws.onclose=()=>{
        let el=document.getElementById('wsSt')
        el.textContent='æ–·ç·š'; el.style.color='#f59e0b'
        log(`WS[${idx}]æ–·ç·šï¼Œé‡é€£ä¸­`,'warn')
        if(ENGINE.running)
            setTimeout(()=>{ if(ENGINE.running) openWS(streams,idx) },ENGINE.reconnectDelay)
    }
}

function processKline(d){
    let sym=d.s, k=d.k
    let bar={open:+k.o,high:+k.h,low:+k.l,close:+k.c,volume:+k.v}
    if(sym==="BTCUSDT"){
        BTC_POOL.lastPrice=bar.close
        pushBar(BTC_POOL,k.i,bar); return
    }
    let s=SYMBOL_POOL[sym]; if(!s) return
    s.lastPrice=bar.close
    pushBar(s,k.i,bar)
    if(s.inPosition&&k.i==="1m"){
        if(bar.high>s.lastHigh) s.lastHigh=bar.high
        checkTrail(sym,bar.close)
    }
}

function pushBar(pool,interval,bar){
    let arr=interval==="15m"?pool.k15:interval==="1m"?pool.k1:null
    if(!arr) return
    arr.push(bar)
    if(arr.length>ENGINE.historyBars) arr.shift()
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ OI åºåˆ—è¼ªè©¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startOIQueue(){
    oiTimer=setInterval(async()=>{
        if(!ENGINE.running||!CURRENT_UNIVERSE.length) return
        let sym=CURRENT_UNIVERSE[OI_QUEUE_IDX%CURRENT_UNIVERSE.length]
        OI_QUEUE_IDX++
        try{
            let d=await safeFetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${sym}`)
            let s=SYMBOL_POOL[sym]; if(!s||!d?.openInterest) return
            s.prevOI=s.oi; s.oi=parseFloat(d.openInterest)
            s.oiHistory.push(s.oi)
            if(s.oiHistory.length>30) s.oiHistory.shift()
        }catch(e){}
    },ENGINE.oiQueueInterval)
}

//==============================================================
// â˜… æ•¸å­¸å·¥å…·
//==============================================================
function MA(data,n){
    if(data.length<n) return 0
    return data.slice(-n).reduce((a,b)=>a+b.close,0)/n
}
function getHigh(data,n){
    if(data.length<n) return 0
    return Math.max(...data.slice(-n).map(c=>c.high))
}
function getLow(data,n){
    if(data.length<n) return 0
    return Math.min(...data.slice(-n).map(c=>c.low))
}

// â˜… ä¿®æ­£ ATRï¼šæ”¹ç”¨ high/low/prevClose çš„ã€Œå·®å€¼æ¯”ä¾‹ã€è¨ˆç®—
// å°è¶…ä½åƒ¹å¹£ï¼ˆ0.0002ï¼‰ç”¨çµ•å°å€¼è¨ˆç®—æœƒå›  IEEE754 ç²¾åº¦æå¤±å¾—åˆ° 0
// æ”¹ç”¨ç™¾åˆ†æ¯” TR å†ä¹˜ä»¥ price é‚„åŸï¼Œç¢ºä¿ç²¾åº¦
function ATR(data,n){
    if(data.length<n+1) return 0
    let sum=0, cnt=0
    let start=Math.max(1,data.length-n)
    for(let i=start;i<data.length;i++){
        let h=data[i].high, l=data[i].low, pc=data[i-1].close
        if(pc<=0) continue
        // TR ç”¨ç™¾åˆ†æ¯”è¨ˆç®—ï¼Œé¿å…è¶…ä½åƒ¹å¹£ç²¾åº¦æå¤±
        let trPct=Math.max(
            (h-l)/pc,
            Math.abs(h-pc)/pc,
            Math.abs(l-pc)/pc
        )
        sum+=trPct; cnt++
    }
    if(cnt===0) return 0
    // é‚„åŸç‚ºçµ•å°å€¼ï¼ˆÃ— ç•¶å‰ priceï¼‰
    let refPrice=data[data.length-1].close
    return (sum/cnt)*refPrice
}

function EMA(data,n){
    if(data.length<n) return 0
    let k=2/(n+1), ema=data[data.length-n].close
    for(let i=data.length-n+1;i<data.length;i++) ema=data[i].close*k+ema*(1-k)
    return ema
}

function slopeN(data,n){
    if(data.length<n) return 0
    let bars=data.slice(-n), mean=bars.reduce((a,b)=>a+b.close,0)/n
    let num=0,den=0
    bars.forEach((b,i)=>{ num+=(i-(n-1)/2)*(b.close-mean); den+=(i-(n-1)/2)**2 })
    return den?num/den:0
}

//==============================================================
// â˜… ä¿®æ­£ç‰ˆ Volume Profileï¼ˆæ”¯æ´è¶…ä½åƒ¹å¹£ï¼‰
// æ ¸å¿ƒä¿®æ­£ï¼šæ”¹ç”¨ã€Œç›¸å°ç´¢å¼•ã€è¨ˆç®—ï¼Œä¸ä¾è³´çµ•å°æµ®é»ç²¾åº¦
// è¼¸å‡ºï¼š
//   poc        = æˆäº¤é‡æœ€å¤§åƒ¹æ ¼ï¼ˆçµ•å°åƒ¹æ ¼ï¼‰
//   support    = å¯†é›†å¸¶åº•éƒ¨ï¼ˆæ­¢æä½ï¼‰
//   resistance = å¯†é›†å¸¶é ‚éƒ¨ï¼ˆTP1ï¼‰
//   valid      = è¨ˆç®—æ˜¯å¦å¯ä¿¡ï¼ˆhi-lo æ˜¯å¦è¶³å¤ å¤§ï¼‰
//==============================================================
function calcVPOC(bars, buckets){
    buckets = buckets || ENGINE.vpBuckets
    if(bars.length<5) return{poc:0,support:0,resistance:0,valid:false}

    let hi=Math.max(...bars.map(b=>b.high))
    let lo=Math.min(...bars.map(b=>b.low))
    if(hi<=lo||hi===0) return{poc:0,support:0,resistance:0,valid:false}

    // æœ‰æ•ˆæ€§æª¢æŸ¥ï¼šrange å¿…é ˆ >= 0.1% æ‰æœ‰æ„ç¾©
    let rangePct=(hi-lo)/lo
    if(rangePct<0.001) return{poc:0,support:0,resistance:0,valid:false}

    let step=(hi-lo)/buckets
    let vol=new Float64Array(buckets)

    bars.forEach(b=>{
        // ç”¨ Math.max/min é˜²æ­¢ index è¶Šç•Œ
        let bLo=Math.max(0,Math.min(buckets-1,Math.floor((b.low-lo)/step)))
        let bHi=Math.max(0,Math.min(buckets-1,Math.floor((b.high-lo)/step)))
        let span=bHi-bLo+1
        for(let i=bLo;i<=bHi;i++) vol[i]+=b.volume/span
    })

    // POC
    let pocIdx=0, maxV=0
    for(let i=0;i<buckets;i++){ if(vol[i]>maxV){maxV=vol[i];pocIdx=i} }
    let poc=lo+pocIdx*step+step*0.5

    // å‡é‡é–¾å€¼
    let totalVol=0
    for(let i=0;i<buckets;i++) totalVol+=vol[i]
    let avgVol=totalVol/buckets
    let threshold=avgVol*0.4

    // å¾€ä¸‹æ‰¾å¯†é›†å¸¶åº•éƒ¨ï¼ˆæ”¯æ’ï¼‰
    let supportIdx=pocIdx
    for(let i=pocIdx-1;i>=0;i--){
        if(vol[i]<threshold){ supportIdx=i+1; break }
        if(i===0) supportIdx=0
    }

    // å¾€ä¸Šæ‰¾å¯†é›†å¸¶é ‚éƒ¨ï¼ˆå£“åŠ›ï¼‰
    let resistIdx=pocIdx
    for(let i=pocIdx+1;i<buckets;i++){
        if(vol[i]<threshold){ resistIdx=i-1; break }
        if(i===buckets-1) resistIdx=buckets-1
    }

    let support=lo+supportIdx*step
    let resistance=lo+(resistIdx+1)*step

    return{poc, support, resistance, valid:true}
}

//==============================================================
// â˜… å‹•æ…‹ç²¾åº¦æ ¼å¼åŒ–ï¼ˆè§£æ±º 0.0002 é¡¯ç¤ºå•é¡Œï¼‰
// æ ¹æ“šåƒ¹æ ¼å¤§å°è‡ªå‹•æ±ºå®šå°æ•¸ä½æ•¸
//==============================================================
function fmtPrice(n){
    if(!n||n<=0) return '0'
    if(n>=1000)  return n.toFixed(2)
    if(n>=100)   return n.toFixed(3)
    if(n>=1)     return n.toFixed(4)
    if(n>=0.01)  return n.toFixed(5)
    if(n>=0.001) return n.toFixed(6)
    if(n>=0.0001)return n.toFixed(7)
    return n.toFixed(8)
}

function fmtPct(n,d=2){ return (n||0).toFixed(d)+'%' }

//==============================================================
// â˜… ä¸»ç­–ç•¥
//==============================================================
function runStrategy(symbol){
    let s=SYMBOL_POOL[symbol]; if(!s) return
    if(s.k15.length<ENGINE.minBars15||s.k1.length<ENGINE.minBars1) return
    if(BTC_POOL.k15.length<ENGINE.minBars15) return
    let price=s.lastPrice; if(price<=0) return

    //â”€â”€â”€â”€â”€â”€ ç¬¬ä¸€å±¤ï¼šè¶¨å‹¢çµæ§‹ï¼ˆæœ€é«˜28åˆ†ï¼‰â”€â”€â”€â”€â”€â”€
    let ma7=MA(s.k15,7), ma20=MA(s.k15,20), ma25=MA(s.k15,25), ma99=MA(s.k15,99)
    let structStrong=(ma7>ma20&&ma20>ma25&&ma25>ma99)
    let structBuild=(ma7>ma20&&ma20>ma25)
    let structBase=(ma7>ma20)
    let slUp=slopeN(s.k15,5)>0
    let priceAboveMA=(price>ma7)
    let structScore=structStrong?20:(structBuild?14:(structBase?8:0))
    let slopeScore=(slUp?5:0)+(priceAboveMA?3:0)

    //â”€â”€â”€â”€â”€â”€ ç¬¬äºŒå±¤ï¼šçªç ´ï¼ˆæœ€é«˜22åˆ†ï¼‰â”€â”€â”€â”€â”€â”€
    let high20=getHigh(s.k15,20), high35=getHigh(s.k15,35)
    let bo20=price>high20, bo35=price>high35
    let near20=price>high20*0.993
    let last3_1m=s.k1.slice(-3)
    let bo1mConfirm=bo20&&last3_1m.length===3&&last3_1m.every(c=>c.close>high20*0.99)
    let breakScore=bo1mConfirm?22:(bo35?16:(bo20?12:(near20?7:0)))

    //â”€â”€â”€â”€â”€â”€ ç¬¬ä¸‰å±¤ï¼šå‹•èƒ½ï¼ˆæœ€é«˜24åˆ†ï¼‰â”€â”€â”€â”€â”€â”€
    let recent20=s.k15.slice(-20)
    let avgVol15=recent20.reduce((a,b)=>a+b.volume,0)/20
    let volNow15=s.k15.at(-1).volume
    let volR15=avgVol15>0?volNow15/avgVol15:1
    let avg1m=s.k1.slice(-15).reduce((a,b)=>a+b.volume,0)/15
    let volNow1m=s.k1.at(-1)?.volume||0
    let volR1m=avg1m>0?volNow1m/avg1m:1
    let atr15=ATR(s.k15,14), atrPast=ATR(s.k15.slice(0,-5),14)
    let atrExp=atrPast>0&&atr15>atrPast*1.05
    let btcATR=ATR(BTC_POOL.k15,14)
    let atrDec=btcATR>0&&atr15>btcATR*1.15
    let vol15Score=volR15>2.5?14:(volR15>2?11:(volR15>1.5?7:(volR15>1.2?4:0)))
    let vol1mScore=volR1m>2?5:(volR1m>1.5?3:0)
    let atrScore=(atrExp?3:0)+(atrDec?2:0)

    //â”€â”€â”€â”€â”€â”€ ç¬¬å››å±¤ï¼šOIï¼ˆæœ€é«˜26åˆ†ï¼‰â”€â”€â”€â”€â”€â”€
    let oiNow=s.oi, oiPrev=s.prevOI||oiNow
    let oiChange=oiPrev>0?((oiNow-oiPrev)/oiPrev*100):0
    let oiBuild=oiChange>0.3, oiStrong=oiChange>1.5
    let oiTrend=false, oiConUp=0
    if(s.oiHistory.length>=4){
        let rOI=s.oiHistory.slice(-4)
        oiTrend=rOI[3]>rOI[0]
        for(let i=rOI.length-1;i>0;i--){ if(rOI[i]>rOI[i-1])oiConUp++; else break }
    }
    let oiScore=(oiStrong?14:(oiBuild?7:0))+(oiTrend?7:0)+(oiConUp>=3?5:0)

    //â”€â”€â”€â”€â”€â”€ ç¬¬äº”å±¤ï¼šBTC è„«é‰¤ï¼ˆæœ€é«˜12åˆ†ï¼‰â”€â”€â”€â”€â”€â”€
    let btcPrice=BTC_POOL.lastPrice
    let btcHigh20=getHigh(BTC_POOL.k15,20)
    let btcMA7=MA(BTC_POOL.k15,7), btcMA20=MA(BTC_POOL.k15,20)
    let priceDec=(price>high20&&btcPrice<btcHigh20*0.997)
    let structDec=(structBuild&&!(btcMA7>btcMA20))
    let sym1hRet=s.k1.length>=60?(s.k1.at(-1).close/s.k1[s.k1.length-61].close-1)*100:0
    let btc1hRet=BTC_POOL.k1.length>=60?(BTC_POOL.k1.at(-1).close/BTC_POOL.k1[BTC_POOL.k1.length-61].close-1)*100:0
    let retDec=btc1hRet!==0&&sym1hRet>btc1hRet*1.8
    let decScore=(priceDec?5:0)+(structDec?3:0)+(retDec?4:0)

    //â”€â”€â”€â”€â”€â”€ ç¬¬å…­å±¤ï¼šPOCï¼ˆæœ€é«˜8åˆ†ï¼‰â”€â”€â”€â”€â”€â”€
    let vp1m=calcVPOC(s.k1.slice(-30))
    let pocBreak=vp1m.valid&&price>vp1m.poc
    let pocDist=vp1m.poc>0?((price-vp1m.poc)/vp1m.poc*100):0
    let pocScore=pocBreak?(pocDist>0.5?8:5):0

    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â˜… é¢¨æ§è¨ˆç®—ï¼ˆä¿®æ­£ç‰ˆï¼‰
    // æ­¢æï¼šVolume Profile æ”¯æ’åº•éƒ¨ï¼ˆç¢ºä¿è·é›¢åˆç†ï¼‰
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let atr1m=ATR(s.k1,14)
    s.atr1m=atr1m

    let stopPrice=0
    let stopDist=0
    let stopValid=false
    let stopMethod=''

    if(vp1m.valid && vp1m.support>0 && vp1m.support<price){
        let vpStopDist=(price-vp1m.support)/price*100
        // VP æ­¢æè·é›¢å¿…é ˆåœ¨åˆç†ç¯„åœå…§
        if(vpStopDist>=ENGINE.stopMinDist && vpStopDist<=ENGINE.stopMaxDist){
            stopPrice=vp1m.support*(1-ENGINE.vpMinStopBuffer) // å†å¾€ä¸‹ç•™ 0.3% ç·©è¡
            stopDist=(price-stopPrice)/price*100
            stopValid=true
            stopMethod='VPå¯†é›†åº•éƒ¨'
        }
    }

    // VP å¤±æ•ˆï¼ˆä½åƒ¹å¹£ç²¾åº¦å•é¡Œæˆ–è·é›¢ä¸åˆç†ï¼‰â†’ æ”¹ç”¨ ATR æ­¢æ
    if(!stopValid){
        if(atr1m>0){
            stopPrice=price-atr1m*ENGINE.vpFallback*100
            stopDist=(price-stopPrice)/price*100
            // ATR æ­¢æåŒæ¨£éœ€è¦åœ¨åˆç†ç¯„åœ
            if(stopDist>=ENGINE.stopMinDist && stopDist<=ENGINE.stopMaxDist){
                stopValid=true
                stopMethod='ATRæ­¢æ'
            } else {
                // ATR ç®—å‡ºä¾†è·é›¢ä¹Ÿä¸åˆç†ï¼ˆå¹£ç¨®å¤ªç©©æˆ–è³‡æ–™ä¸è¶³ï¼‰
                stopPrice=price*(1-ENGINE.stopMinDist/100)
                stopDist=ENGINE.stopMinDist
                stopValid=false  // æ¨™è¨˜ç‚ºä¸å¯ä¿¡ï¼Œä¸æ¨æ’­
                stopMethod='å›ºå®šæœ€å°å€¼(ä¸å¯ä¿¡)'
            }
        }
    }

    // â˜… æ­¢ç›ˆ TP1ï¼šVolume Profile å£“åŠ›é ‚éƒ¨ï¼ˆå¿…é ˆ > priceï¼‰
    let tp1=0
    if(vp1m.valid && vp1m.resistance>price*1.002){
        // å£“åŠ›é ‚éƒ¨å¿…é ˆæ¯”ç•¶å‰åƒ¹é«˜è‡³å°‘ 0.2%
        tp1=vp1m.resistance
    }

    // â˜… æ­¢ç›ˆ TP2ï¼š1m ATR Ã— å€æ•¸
    let tp2=0
    if(atr1m>0){
        tp2=price+atr1m*ENGINE.tpAtrMult
    }

    // â˜… æ§“æ¡¿è¨ˆç®—ï¼ˆä¿®æ­£ï¼‰
    // åªæœ‰ stopDist ç¢ºå¯¦æœ‰æ•ˆæ‰è¨ˆç®—æ§“æ¡¿
    // å…¬å¼ï¼šæ§“æ¡¿ = é¢¨éšª% / (æ­¢æè·é›¢% / 100)
    let suggestLev=1
    if(stopDist>0.1){
        suggestLev=Math.floor(ENGINE.riskPct/stopDist*100)
        suggestLev=Math.max(1,Math.min(ENGINE.maxLev,suggestLev))
    }

    s.stopPrice=stopPrice
    s.stopDist=stopDist
    s.stopValid=stopValid
    s.stopMethod=stopMethod
    s.tp1=tp1
    s.tp2=tp2
    s.suggestLev=suggestLev
    s.poc=vp1m.poc||0
    s.pocResistance=vp1m.resistance||0

    //â”€â”€â”€â”€â”€â”€ å‡ºå ´è¿½è¹¤ â”€â”€â”€â”€â”€â”€
    if(s.oiHistory.length>=2){
        let last=s.oiHistory.at(-1), prev=s.oiHistory.at(-2)
        if(last<prev) s.exitCheckOIDown++; else s.exitCheckOIDown=0
    }
    s.exitVolDown=(volR15<0.75)
    if(s.inPosition&&price>0) s.exitNoNewHigh=(price<s.lastHigh*0.997)

    let exitCount=
        (s.exitCheckOIDown>=2?1:0)+
        (s.exitVolDown?1:0)+
        (s.exitNoNewHigh?1:0)
    let exitSignal=exitCount>=2
    if(oiChange<-1.2&&volR15<0.7) exitSignal=true

    let exitReason=[]
    if(s.exitCheckOIDown>=2) exitReason.push(`OIé€£é™${s.exitCheckOIDown}æ ¹`)
    if(s.exitVolDown) exitReason.push('é‡ç¸®')
    if(s.exitNoNewHigh) exitReason.push('æœªå‰µé«˜')
    if(oiChange<-1.2&&volR15<0.7) exitReason.push('OIæ€¥é™+é‡ç¸®')
    s.whaleExit=exitSignal
    s.exitReason=exitReason.join(' / ')

    //â”€â”€â”€â”€â”€â”€ åˆ†æ•¸ â”€â”€â”€â”€â”€â”€
    let sd={
        structure:structScore, slope:slopeScore,
        breakout:breakScore,
        vol15:vol15Score, vol1m:vol1mScore, atr:atrScore,
        oi:oiScore, decouple:decScore, poc:pocScore
    }
    let total=Object.values(sd).reduce((a,b)=>a+b,0)
    let state="IDLE"
    if(total>=98)  state="STRONG"
    else if(total>=82) state="BREAK"
    else if(total>=65) state="BUILD"
    else if(total>=50) state="RADAR"

    s.score=total; s.scoreDetails=sd; s.state=state
    s.oiChange=oiChange; s.volRatio=volR15
    s.sym1hRet=sym1hRet; s.btc1hRet=btc1hRet

    //â”€â”€â”€â”€â”€â”€ pushLock å†·å»é‡ç½®ï¼ˆæ™‚é–“æˆ³ç‰ˆï¼‰â”€â”€â”€â”€â”€â”€
    let thrScore=THR_LEVELS[thrIdx].score
    let now=Date.now()
    if(s.pushLock){
        // æ¢ä»¶1ï¼šè¶…éå†·å»æ™‚é–“
        let cooldownExpired=(now-s.pushLockTs)>=ENGINE.pushCooldownMs
        // æ¢ä»¶2ï¼šåˆ†æ•¸æ›¾æ‰å‡ºè§¸ç™¼å€ï¼ˆè¨ˆæ•¸å™¨åˆ°é”é–€æª»ï¼‰
        if(total<thrScore-10) s.pushCooldown++
        if(cooldownExpired && s.pushCooldown>=ENGINE.pushCooldownBars && total>=thrScore){
            s.pushLock=false; s.pushCooldown=0
            log(`${symbol} æ¨æ’­é–è§£é™¤`,'info')
        }
        // å¼·åˆ¶è§£é–ï¼šå†·å»æ™‚é–“åˆ°äº†å°±ç›´æ¥è§£é–ï¼ˆä¸ç®¡ pushCooldownBarsï¼‰
        if(cooldownExpired && s.pushCooldown>=10 && total>=thrScore){
            s.pushLock=false; s.pushCooldown=0
            log(`${symbol} æ¨æ’­é–å¼·åˆ¶è§£é™¤ï¼ˆå†·å»åˆ°æœŸï¼‰`,'info')
        }
    }

    handlePush(symbol)
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç§»å‹•æ­¢æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkTrail(symbol,price){
    let s=SYMBOL_POOL[symbol]; if(!s||!s.inPosition) return
    let entry=s.entryPrice; if(entry<=0) return
    let fp=(price-entry)/entry*100
    if(fp>=ENGINE.trail3Pct&&s.trailStage<3){
        s.trailStage=3; s.currentStop=entry*(1+ENGINE.trail3Loc/100)
        notifyTrail(symbol,fp,3,ENGINE.trail3Loc,s.currentStop)
    } else if(fp>=ENGINE.trail2Pct&&s.trailStage<2){
        s.trailStage=2; s.currentStop=entry*(1+ENGINE.trail2Loc/100)
        notifyTrail(symbol,fp,2,ENGINE.trail2Loc,s.currentStop)
    } else if(fp>=ENGINE.trail1Pct&&s.trailStage<1){
        s.trailStage=1; s.currentStop=entry
        notifyTrail(symbol,fp,1,0,s.currentStop)
    }
}

function notifyTrail(sym,fp,stage,loc,stop){
    let tag=stage===1?'ç§»è‡³æˆæœ¬':`ç§»è‡³+${loc}%`
    log(`ğŸ’° ${sym} ç§»å‹•æ­¢æ[${stage}] æµ®ç›ˆ${fp.toFixed(1)}% â†’ ${tag}`,'signal')
    sendTG(
`ğŸ’° ç§»å‹•æ­¢ææ›´æ–° ${sym}
æµ®ç›ˆï¼š+${fp.toFixed(2)}%
æ­¢æç§»è‡³ï¼š${tag} = ${fmtPrice(stop)}
éšæ®µï¼š${stage}/3`
    )
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ¨æ’­æ§åˆ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handlePush(symbol){
    let s=SYMBOL_POOL[symbol]; if(!s) return
    let thrScore=THR_LEVELS[thrIdx].score
    let now=Date.now()

    // â˜… é€²å ´æ¨æ’­æ¢ä»¶ï¼š
    // 1. åˆ†æ•¸é”æ¨™
    // 2. æ­¢ææœ‰æ•ˆï¼ˆä¸æ˜¯æ­¢æ=é€²å ´çš„ç‹€æ³ï¼‰
    // 3. æ²’æœ‰ pushLock
    if(s.score>=thrScore && s.stopValid && !s.pushLock){
        // äºŒæ¬¡é˜²é‡è¤‡ï¼šç¢ºèªè·é›¢ä¸Šæ¬¡æ¨æ’­è¶…éå†·å»æ™‚é–“
        if(now-s.pushLockTs >= ENGINE.pushCooldownMs){
            s.pushLock=true
            s.pushLockTs=now
            s.pushCooldown=0
            sendTG(buildEntryMsg(symbol,s))
            log(`ğŸ“¡ é€²å ´è¨Šè™Ÿ ${symbol} åˆ†æ•¸:${s.score} æ­¢æ:${s.stopDist.toFixed(2)}% [${s.stopMethod}]`,'signal')
        }
    }

    // å‡ºå ´æ¨æ’­
    if(s.whaleExit&&!s.exitLock){
        s.exitLock=true
        sendTG(buildExitMsg(symbol,s))
        log(`ğŸš¨ å‡ºå ´è¨Šè™Ÿ ${symbol} åŸå› :${s.exitReason}`,'exit')
    }
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¨Šæ¯æ¨¡æ¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildEntryMsg(sym,s){
    let p=s.lastPrice
    let tp1Str=s.tp1>0
        ? `${fmtPrice(s.tp1)}  (+${((s.tp1/p-1)*100).toFixed(2)}%)`
        : 'â€”ï¼ˆå£“åŠ›ä½ä¸æ˜é¡¯ï¼‰'
    let tp2Str=s.tp2>0
        ? `${fmtPrice(s.tp2)}  (+${((s.tp2/p-1)*100).toFixed(2)}%)`
        : 'â€”'
    let stopPct=`-${s.stopDist.toFixed(2)}%`
    let riskWarn=s.suggestLev>=15?`\nâš ï¸ æ­¢æè·é›¢æ¥µå°ï¼Œè«‹è¬¹æ…ä½¿ç”¨é«˜æ§“æ¡¿`:'

'
    return `ğŸ”¥ é€²å ´è¨Šè™Ÿ ${sym}  [${THR_LEVELS[thrIdx].label}]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’° é€²å ´åƒ¹  ï¼š${fmtPrice(p)}
ğŸ›‘ æ­¢æ    ï¼š${fmtPrice(s.stopPrice)}  (${stopPct})
   â”” ä¾æ“š  ï¼š${s.stopMethod}
ğŸ¯ æ­¢ç›ˆTP1ï¼š${tp1Str}
   â”” ä¾æ“š  ï¼š1må‰30æ ¹å£“åŠ›é ‚éƒ¨
ğŸ¯ æ­¢ç›ˆTP2ï¼š${tp2Str}
   â”” ä¾æ“š  ï¼š1m ATR Ã— ${ENGINE.tpAtrMult}
âš¡ å»ºè­°æ§“æ¡¿ï¼š${s.suggestLev}xï¼ˆé¢¨éšªå›ºå®š${ENGINE.riskPct}%ï¼‰${riskWarn}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š ç¸½åˆ†ï¼š${s.score}
çµæ§‹:${s.scoreDetails.structure} æ–œç‡:${s.scoreDetails.slope} çªç ´:${s.scoreDetails.breakout}
é‡15m:${s.scoreDetails.vol15} é‡1m:${s.scoreDetails.vol1m} ATR:${s.scoreDetails.atr}
OI:${s.scoreDetails.oi} è„«é‰¤:${s.scoreDetails.decouple} POC:${s.scoreDetails.poc}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ˆ 1hæ¼²å¹…ï¼š${s.sym1hRet.toFixed(2)}%  BTCï¼š${s.btc1hRet.toFixed(2)}%
ğŸ‹ é‡èƒ½å€æ•¸ï¼š${s.volRatio.toFixed(2)}x
ğŸ“‚ OIè®ŠåŒ–ï¼š${s.oiChange.toFixed(2)}%
ğŸ’¡ ç§»å‹•æ­¢æï¼šæµ®ç›ˆ${ENGINE.trail1Pct}%â†’æˆæœ¬  ${ENGINE.trail2Pct}%â†’+${ENGINE.trail2Loc}%  ${ENGINE.trail3Pct}%â†’+${ENGINE.trail3Loc}%`
}

function buildExitMsg(sym,s){
    return `âš ï¸ å‡ºå ´è¨Šè™Ÿ ${sym}
æ¢ä»¶ï¼š${s.exitReason}
ç•¶å‰åƒ¹ï¼š${fmtPrice(s.lastPrice)}
OIè®ŠåŒ–ï¼š${s.oiChange.toFixed(2)}%
é‡èƒ½å€æ•¸ï¼š${s.volRatio.toFixed(2)}x`
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Telegram â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendTG(msg){
    let token=document.getElementById('tgToken').value.trim()
    let chat=document.getElementById('tgChat').value.trim()
    if(!token||!chat) return
    try{
        await fetch(`https://api.telegram.org/bot${token}/sendMessage`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({chat_id:chat,text:msg})
        })
    }catch(e){}
}

function testPush(){
    sendTG(`âœ… V15.2 QUANT ENGINE æ¸¬è©¦\nç›£æ§å¹£ï¼š${CURRENT_UNIVERSE.length}\né€²å ´é–€æª»ï¼š${THR_LEVELS[thrIdx].label}`)
}

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStatusBar(){
    document.getElementById('lastUpd').textContent=new Date().toTimeString().slice(0,8)
    document.getElementById('reqR').textContent=reqCountMin+'/min'
}

function renderCards(){
    let container=document.getElementById('cards')
    container.innerHTML=''
    let sorted=[...CURRENT_UNIVERSE].sort((a,b)=>(SYMBOL_POOL[b]?.score||0)-(SYMBOL_POOL[a]?.score||0))
    let cnt={STRONG:0,BREAK:0,BUILD:0,RADAR:0,IDLE:0}

    sorted.forEach(symbol=>{
        let s=SYMBOL_POOL[symbol]; if(!s) return
        let st=s.state||'IDLE'; cnt[st]=(cnt[st]||0)+1
        let p=s.lastPrice
        let thrScore=THR_LEVELS[thrIdx].score

        // æ­¢æé¡¯ç¤ºï¼ˆæ¨™è¨˜æ˜¯å¦æœ‰æ•ˆï¼‰
        let slStr=s.stopValid
            ? `<span class="sl-val">${fmtPrice(s.stopPrice)} (-${s.stopDist.toFixed(2)}%)</span>`
            : `<span style="color:#f59e0b">âš  ${fmtPrice(s.stopPrice)} (æ­¢æä¸å¯ä¿¡)</span>`

        // TP é¡¯ç¤º
        let tp1Str=s.tp1>0
            ? `<span class="tp-val">${fmtPrice(s.tp1)} (+${((s.tp1/p-1)*100).toFixed(1)}%)</span>`
            : '<span style="color:#555">â€”</span>'
        let tp2Str=s.tp2>0
            ? `<span class="tp-val">${fmtPrice(s.tp2)} (+${((s.tp2/p-1)*100).toFixed(1)}%)</span>`
            : '<span style="color:#555">â€”</span>'

        // ATR æœ‰æ•ˆæ€§è­¦å‘Š
        let atrWarn=s.atr1m<=0?'<div class="warn-badge">âš  1m ATR=0ï¼ˆè³‡æ–™ä¸è¶³ï¼‰</div>':''

        // é–å®šç‹€æ…‹
        let now=Date.now()
        let cooldownRemain=Math.max(0,Math.ceil((ENGINE.pushCooldownMs-(now-s.pushLockTs))/60000))
        let lockHtml=s.pushLock
            ? `<div class="lock-badge">ğŸ”’ å·²æ¨æ’­ å†·å»å‰©é¤˜: ${cooldownRemain}åˆ†é˜</div>`
            : (s.score>=thrScore
                ? `<div class="lock-badge" style="color:#3b82f6">â³ å¾…æ¨æ’­ï¼ˆæ­¢æ${s.stopValid?'æœ‰æ•ˆ':'ç„¡æ•ˆ'}ï¼‰</div>`
                : '')

        let trailHtml=s.inPosition
            ? `<div class="trail-row">âš¡æŒå€‰ é€²å ´:${fmtPrice(s.entryPrice)} æ­¢æ:${fmtPrice(s.currentStop)} [éšæ®µ${s.trailStage}]</div>`
            : ''

        let div=document.createElement('div')
        div.className='card '+st
        div.innerHTML=`
<div class="card-header">
  <span class="card-symbol">${symbol}</span>
  <span class="card-state state-${st}">${st}</span>
</div>
<div class="card-score" style="color:${stClr(st)}">${s.score}<span style="font-size:12px;color:#444"> /120</span></div>
<div class="score-grid">
  <div class="score-item"><span>çµæ§‹</span><span class="sv">${s.scoreDetails.structure??'-'}</span></div>
  <div class="score-item"><span>æ–œç‡</span><span class="sv">${s.scoreDetails.slope??'-'}</span></div>
  <div class="score-item"><span>çªç ´</span><span class="sv">${s.scoreDetails.breakout??'-'}</span></div>
  <div class="score-item"><span>é‡15m</span><span class="sv">${s.scoreDetails.vol15??'-'}</span></div>
  <div class="score-item"><span>é‡1m</span><span class="sv">${s.scoreDetails.vol1m??'-'}</span></div>
  <div class="score-item"><span>ATR</span><span class="sv">${s.scoreDetails.atr??'-'}</span></div>
  <div class="score-item"><span>OI</span><span class="sv">${s.scoreDetails.oi??'-'}</span></div>
  <div class="score-item"><span>è„«é‰¤</span><span class="sv">${s.scoreDetails.decouple??'-'}</span></div>
  <div class="score-item"><span>POC</span><span class="sv">${s.scoreDetails.poc??'-'}</span></div>
</div>
<hr class="divider">
<div class="card-risk">
  <span class="rl">æ­¢æ</span><div>${slStr}<br><span style="font-size:10px;color:#555">${s.stopMethod||''}</span></div>
  <span class="rl">TP1å£“åŠ›</span><div>${tp1Str}</div>
  <span class="rl">TP2 ATR</span><div>${tp2Str}</div>
  <span class="rl">æ§“æ¡¿</span><span class="rv">${s.suggestLev}x</span>
  <span class="rl">é‡èƒ½</span><span class="rv">${s.volRatio.toFixed(2)}x</span>
  <span class="rl">OI</span><span class="rv">${s.oiChange.toFixed(2)}%</span>
</div>
${atrWarn}
${s.whaleExit?`<div class="alert-exit">âš  å‡ºå ´ï¼š${s.exitReason}</div>`:''}
${trailHtml}
${lockHtml}`
        container.appendChild(div)
    })

    document.getElementById('cS').textContent='STRONG:'+cnt.STRONG
    document.getElementById('cB').textContent='BREAK:'+(cnt.BREAK||0)
    document.getElementById('cBu').textContent='BUILD:'+(cnt.BUILD||0)
    document.getElementById('cR').textContent='RADAR:'+(cnt.RADAR||0)
    document.getElementById('cI').textContent='IDLE:'+(cnt.IDLE||0)
}

function stClr(st){
    return{STRONG:'#22c55e',BREAK:'#3b82f6',BUILD:'#f59e0b',RADAR:'#a855f7',IDLE:'#333'}[st]||'#333'
}
</script>
</body>
</html>
