<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>⚡ TRIDENT FINAL PRO</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#050505;color:#d4d4d8;font-family:monospace}
.card{background:#111;border:1px solid #222;border-radius:8px;padding:14px;transition:0.3s}
.card:hover{transform:translateY(-3px)}
.lowrisk{border:2px solid #22c55e}
.scorebar{height:6px;border-radius:4px;background:linear-gradient(90deg,#ef4444,#eab308,#22c55e)}
.refresh{height:3px;background:#3b82f6;width:0%}
</style>
</head>
<body class="p-6">

<div class="flex justify-between mb-4">
<h1 class="text-xl font-bold text-blue-400">TRIDENT FINAL PRO</h1>
<div class="flex gap-4 items-center">
<input id="searchInput" placeholder="搜尋幣種..." class="bg-black border border-zinc-700 px-3 py-1 text-sm"/>
<button onclick="toggleEngine()" id="engineBtn" class="bg-blue-600 px-4 py-1 text-sm">啟動</button>
</div>
</div>

<div class="w-full bg-zinc-800 mb-4"><div id="refreshBar" class="refresh"></div></div>

<div id="cards" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>

<script>
const EXCLUDE = ['BTCUSDT','ETHUSDT','BNBUSDT','SOLUSDT','XRPUSDT','ADAUSDT','DOGEUSDT','TRXUSDT','DOTUSDT'];
let running=false;
let interval;
let marketData={};
let btcData=[];

function toggleEngine(){
if(running){
clearInterval(interval);
running=false;
engineBtn.innerText="啟動";
return;
}
running=true;
engineBtn.innerText="停止";
loadAll();
interval=setInterval(loadAll,30000);
progressBar();
}

function progressBar(){
let width=0;
setInterval(()=>{
if(!running)return;
width+=0.33;
if(width>=100)width=0;
refreshBar.style.width=width+"%";
},100);
}

async function loadAll(){
const tickers=await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
const filtered=tickers
.filter(t=>t.symbol.endsWith('USDT'))
.filter(t=>!EXCLUDE.includes(t.symbol))
.sort((a,b)=>b.quoteVolume-a.quoteVolume)
.slice(0,120);

await loadBTC();

for(let t of filtered){
await loadSymbol(t.symbol);
}
render();
}

async function loadBTC(){
btcData=await fetch('https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=15m&limit=50').then(r=>r.json());
}

async function loadSymbol(sym){
try{
const k15=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=15m&limit=100`).then(r=>r.json());
const k4h=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=4h&limit=100`).then(r=>r.json());

let price=parseFloat(k15[k15.length-1][4]);
let poc4h=calcPOC(k4h);
let poc15=calcPOC(k15);

let ma7=MA(k15,7);
let ma20=MA(k15,20);
let ma25=MA(k15,25);
let ma99=MA(k15,99);

let volatility=(Math.max(...k4h.map(x=>parseFloat(x[2])))-
Math.min(...k4h.map(x=>parseFloat(x[3]))))/price*100;

let bottomBreak=breakAndReclaim(k4h);
let bigOrder=detectBigOrder(k15);
let btcCorr=correlation(k15,btcData);

let score=0;
if(price>poc4h)score+=25;
if(poc15>poc4h)score+=10;
if(ma7>ma20 && ma20>ma25 && ma25>ma99)score+=15;
if(bottomBreak)score+=15;
if(bigOrder)score+=10;
if(volatility>3)score+=10;
if(Math.abs(btcCorr)<0.6)score+=5;

marketData[sym]={price,poc4h,poc15,ma7,ma20,ma25,ma99,score,volatility,btcCorr};
}catch(e){}
}

function calcPOC(k){
let bins={};
let prices=k.map(x=>parseFloat(x[4]));
let min=Math.min(...prices),max=Math.max(...prices);
let step=(max-min)/20||0.00001;
k.forEach(c=>{
let p=parseFloat(c[4]);
let v=parseFloat(c[5]);
let b=Math.floor((p-min)/step)*step+min;
bins[b]=(bins[b]||0)+v;
});
let maxV=0,poc=min;
for(let b in bins){
if(bins[b]>maxV){maxV=bins[b];poc=parseFloat(b);}
}
return poc;
}

function MA(k,len){
let slice=k.slice(-len);
return slice.reduce((a,b)=>a+parseFloat(b[4]),0)/len;
}

function breakAndReclaim(k){
let lows=k.map(x=>parseFloat(x[3]));
let min=Math.min(...lows.slice(0,-5));
let last=parseFloat(k[k.length-1][4]);
return last>min*1.02;
}

function detectBigOrder(k){
let vols=k.map(x=>parseFloat(x[5]));
let avg=vols.reduce((a,b)=>a+b)/vols.length;
let last=vols[vols.length-1];
let sd=Math.sqrt(vols.map(v=>(v-avg)**2).reduce((a,b)=>a+b)/vols.length);
let z=(last-avg)/sd;
return z>2.5;
}

function correlation(a,b){
let arr1=a.map(x=>parseFloat(x[4]));
let arr2=b.map(x=>parseFloat(x[4]));
let avg1=arr1.reduce((x,y)=>x+y)/arr1.length;
let avg2=arr2.reduce((x,y)=>x+y)/arr2.length;
let num=0,d1=0,d2=0;
for(let i=0;i<arr1.length;i++){
num+=(arr1[i]-avg1)*(arr2[i]-avg2);
d1+=(arr1[i]-avg1)**2;
d2+=(arr2[i]-avg2)**2;
}
return num/Math.sqrt(d1*d2);
}

function render(){
cards.innerHTML="";
Object.keys(marketData)
.filter(s=>marketData[s].price>marketData[s].poc4h)
.filter(s=>marketData[s].score>=60)
.forEach(sym=>{
let d=marketData[sym];
let riskClass=d.score>=80?"lowrisk":"";
cards.innerHTML+=`
<div class="card ${riskClass}">
<div class="flex justify-between">
<span class="text-white font-bold">${sym.replace('USDT','')}</span>
<span class="text-green-400">${d.score}</span>
</div>
<div class="scorebar mt-2 mb-2"></div>
<div class="text-xs space-y-1">
<div>價格: ${d.price.toFixed(4)}</div>
<div>4H POC: ${d.poc4h.toFixed(4)}</div>
<div>MA排列: ${d.ma7>d.ma20?'多頭':'混合'}</div>
<div>波動: ${d.volatility.toFixed(2)}%</div>
<div>脫離BTC: ${Math.abs(d.btcCorr)<0.6?'是':'否'}</div>
</div>
</div>
`;
});
}
</script>
</body>
</html>
