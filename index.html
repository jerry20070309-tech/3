import streamlit as st
import pandas as pd
import time
from datetime import datetime
from binance.client import Client
from binance.exceptions import BinanceAPIException

# --- [1. é é¢é…ç½®] ---
st.set_page_config(page_title="Whale Tracker Pro", layout="wide")

# --- [2. å´é‚Šæ¬„ï¼šæœå°‹èˆ‡ API é…ç½®] ---
with st.sidebar:
    st.title("ğŸ‹ å·¨é¯¨ç›£æ§é¢æ¿")
    # æœå°‹æ¬„ï¼šå‹•æ…‹æ±ºå®šç›£æ§å¹£å° (P1)
    symbol = st.text_input("è¼¸å…¥ç›£æ§å¹£å° (ä¾‹å¦‚ BTCUSDT)", value="BTCUSDT").upper()
    whale_threshold = st.number_input("å·¨é¯¨é–€æª» (USDT)", value=50000)
    # API é…ç½®
    api_key = st.text_input("Binance API Key", type="password")
    api_secret = st.text_input("Binance API Secret", type="password")
    is_active = st.toggle("å•Ÿå‹•å³æ™‚ç›£æ§")

# --- [3. æ ¸å¿ƒæŠ“å–é‚è¼¯ï¼šæ¯ 3 ç§’ 3 å°åŒ…] ---
def get_whale_data(client, target_symbol):
    try:
        # å°åŒ… A: å¸‚å ´æˆäº¤é‡ (P2)
        trades = client.futures_recent_trades(symbol=target_symbol, limit=20)
        # å°åŒ… B: å¸‚å ´çˆ†å€‰é‡ (P3)
        liquidations = client.futures_get_all_liquidation_orders(symbol=target_symbol, limit=5)
        # å°åŒ… C: åˆç´„æŒå€‰åˆ†æ (B2)
        oi_data = client.futures_open_interest(symbol=target_symbol)
        
        return trades, liquidations, oi_data
    except BinanceAPIException as e:
        st.error(f"API è«‹æ±‚å¤±æ•—: {e.message}")
        return None, None, None

# --- [4. åŸ·è¡Œå¼•æ“] ---
if is_active and api_key and api_secret:
    client = Client(api_key, api_secret)
    placeholder = st.empty()
    prev_oi = 0.0 # ç”¨æ–¼å°æ¯”æŒå€‰è®Šå‹•

    while True:
        start_time = time.perf_counter()
        trades, liqs, oi = get_whale_data(client, symbol)

        if trades and oi:
            # æ•¸æ“šè§£æ
            df_trades = pd.DataFrame(trades)
            df_trades['price'] = df_trades['price'].astype(float)
            df_trades['qty'] = df_trades['qty'].astype(float)
            df_trades['total'] = df_trades['price'] * df_trades['qty']
            
            curr_oi = float(oi['openInterest'])
            oi_change = curr_oi - prev_oi if prev_oi != 0 else 0
            
            # æ™‚é–“åˆ¤å®šï¼šé€±å…­é‚è¼¯
            is_saturday = datetime.utcnow().weekday() == 5
            
            with placeholder.container():
                st.markdown(f"## ğŸ“Š {symbol} å¯¦æ™‚çœ‹æ¿ " + ("ğŸŸ¢ (é€±å…­æ¨¡å¼é–‹å•Ÿ)" if is_saturday else ""))
                
                # å„€è¡¨æ¿æ•¸æ“š
                c1, c2, c3 = st.columns(3)
                c1.metric("ç•¶å‰åƒ¹æ ¼", f"${df_trades['price'].iloc[-1]:,.4f}")
                c2.metric("æŒå€‰é‡ (B2)", f"{curr_oi:,.2f}", f"{oi_change:,.2f}")
                c3.metric("æœ€æ–°å¤§å–® (P2)", f"${df_trades['total'].iloc[-1]:,.0f}")

                # å·¨é¯¨è¡Œç‚ºåˆ¤å®šç´°ç¯€
                st.divider()
                st.subheader("ğŸ•µï¸ å·¨é¯¨å‡ºè²¨/é€²è²¨è‡ªå‹•åˆ¤å®š")
                
                # ç¯©é¸å¤§é¡æˆäº¤
                big_trades = df_trades[df_trades['total'] >= whale_threshold]
                if not big_trades.empty:
                    for _, row in big_trades.iterrows():
                        side = "ğŸ”´ è³£å‡º" if row['isBuyerMaker'] else "ğŸŸ¢ è²·å…¥"
                        # åº•å±¤é‚è¼¯ï¼šåƒ¹æ ¼æ¼² + OIè·Œ = å‡ºè²¨ï¼›åƒ¹æ ¼æ¼² + OIæ¼² = å»ºå€‰
                        if not row['isBuyerMaker'] and oi_change > 0:
                            msg, status = "å·¨é¯¨æ­£åœ¨ã€é€²è²¨å»ºå€‰ã€‘", "success"
                        elif row['isBuyerMaker'] and oi_change < 0:
                            msg, status = "å·¨é¯¨æ­£åœ¨ã€æ‹‰é«˜å‡ºè²¨ã€‘", "error"
                        else:
                            msg, status = "å¸‚å ´å¸¸è¦æ›æ‰‹", "info"
                        
                        st.toast(f"åµæ¸¬åˆ°å¤§å–®: {side} ${row['total']:,.0f}")
                        st.write(f"**æˆäº¤é¡:** ${row['total']:,.0f} | **åˆ¤å®š:** {msg}")
                
                if liqs:
                    st.warning(f"ğŸš¨ åµæ¸¬åˆ° P3 çˆ†å€‰äº‹ä»¶ï¼šæœ€è¿‘åƒ¹æ ¼ {liqs[0]['price']}")

            prev_oi = curr_oi

        # ç²¾ç¢º 3 ç§’å¾ªç’°
        wait = max(0, 3.0 - (time.perf_counter() - start_time))
        time.sleep(wait)
else:
    st.info("è«‹åœ¨å·¦å´è¼¸å…¥ API Key ä¸¦å•Ÿå‹•ç›£æ§ã€‚")
