<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ TRIDENT V46.8 | å¤šæ™‚æ¡†ç›£æ§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;800&display=swap');
        body { background: #020202; color: #a1a1aa; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .card-stat { background: #09090b; border: 1px solid #18181b; border-radius: 6px; transition: 0.2s; order: 1; }
        .under-poc { border-left: 3px solid #ef4444 !important; background: rgba(239, 68, 68, 0.02); }
        .above-poc { border-left: 3px solid #10b981 !important; background: rgba(16, 185, 129, 0.02); }
        .pinned { order: -1 !important; border: 1px solid #facc15 !important; background: rgba(250, 204, 21, 0.03); }
        
        /* å¤šæ™‚æ¡†æ•¸æ“šæ ¼æ¨£å¼ */
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 9px; }
        .data-item { background: #131316; padding: 2px 4px; border-radius: 2px; display: flex; justify-content: space-between; }
        .val-up { color: #10b981; }
        .val-down { color: #ef4444; }

        #chartModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center; }
        .modal-content { background: #09090b; border: 1px solid #27272a; width: 90%; height: 80%; padding: 20px; border-radius: 8px; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #27272a; }
    </style>
</head>
<body class="p-4 h-screen flex flex-col">

    <div id="chartModal">
        <div class="modal-content flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="text-white font-black text-xl italic uppercase">SYMBOL</h2>
                <button onclick="closeModal()" class="text-zinc-500 hover:text-white text-2xl">âœ•</button>
            </div>
            <div id="modalChartContainer" class="flex-1"></div>
        </div>
    </div>

    <header class="flex flex-wrap justify-between items-center gap-4 mb-4 border-b border-zinc-800 pb-3">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-black italic text-white">TRIDENT <span class="text-emerald-500 font-bold">V46.8</span></h1>
            <div class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest bg-zinc-900 px-3 py-1 rounded border border-zinc-800">
                STATUS: <span id="pStatus" class="text-emerald-500 italic">READY</span>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <input type="text" id="searchInput" oninput="handleSearch()" placeholder="SEARCH SYMBOL..." 
                class="bg-zinc-950 border border-zinc-800 text-[11px] px-3 py-1.5 rounded w-44 text-white focus:border-emerald-500 outline-none">
            <button onclick="ignite()" id="startBtn" class="bg-red-600 hover:bg-red-500 text-white px-5 py-1.5 font-black rounded text-[10px] uppercase shadow-lg transition-all">START ENGINE</button>
            <button onclick="location.reload()" class="bg-zinc-900 hover:bg-zinc-800 text-zinc-400 px-5 py-1.5 font-black rounded text-[10px] uppercase transition-all">RESET</button>
        </div>
    </header>

    <main id="monitorList" class="flex-1 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7 gap-3 overflow-y-auto pr-2 pb-10"></main>

<script>
    let marketData = {}, pinnedSymbols = new Set(), isRunning = false, queue = [], currentModalChart = null;

    // --- 1. æ ¸å¿ƒå°åŒ…å¼•æ“ (1å¤§->ç­‰5ç§’->æ¯3ç§’20å€‹) ---
    async function ignite() {
        if (isRunning) return;
        isRunning = true;
        document.getElementById('startBtn').style.display = 'none';

        const t = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        const allSymbols = t.filter(x => x.symbol.endsWith('USDT')).sort((a,b) => b.quoteVolume - a.quoteVolume).map(x => x.symbol);

        const firstBatch = allSymbols.slice(0, 80);
        const restSymbols = allSymbols.slice(80);
        
        document.getElementById('pStatus').innerText = "BATCH 1 (80 SYMBOLS)...";
        await Promise.all(firstBatch.map(s => initSymbol(s)));
        
        document.getElementById('pStatus').innerText = "COOLING DOWN (5S)...";
        await new Promise(res => setTimeout(res, 5000));

        queue = restSymbols;
        processNextPacket();
        startWS();
    }

    async function processNextPacket() {
        if (queue.length === 0) { document.getElementById('pStatus').innerText = "LIVE MONITORING"; return; }
        const packet = queue.splice(0, 20);
        document.getElementById('pStatus').innerText = `SENDING PACKET (${queue.length} LEFT)`;
        await Promise.all(packet.map(s => initSymbol(s)));
        setTimeout(processNextPacket, 3000);
    }

    // --- 2. æ•¸æ“šæŠ“å– (åŒ…å«æ™‚æ¡†æ¼²è·Œ) ---
    async function initSymbol(s) {
        try {
            const [k15, kDaily] = await Promise.all([
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=80`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`).then(r=>r.json())
            ]);

            // è¨ˆç®— POC (ç±Œç¢¼ç·š)
            const bins = {};
            k15.forEach(x => { let p = Math.floor(parseFloat(x[4])*1000)/1000; bins[p] = (bins[p]||0) + parseFloat(x[5]); });
            const poc = parseFloat(Object.keys(bins).reduce((a, b) => bins[a] > bins[b] ? a : b));

            marketData[s] = {
                poc: poc,
                priceChange: kDaily.priceChangePercent,
                history: k15.map(x => ({ time: x[0]/1000, open: parseFloat(x[1]), high: parseFloat(x[2]), low: parseFloat(x[3]), close: parseFloat(x[4]) }))
            };
            renderCard(s);
        } catch(e) {}
    }

    // --- 3. ç•«é¢å‘ˆç¾ (å¤šæ™‚æ¡†æ ¼) ---
    function renderCard(s) {
        const el = document.createElement('div');
        el.id = `card-${s}`;
        el.className = `card-stat p-3 flex flex-col gap-2`;
        el.innerHTML = `
            <div class="flex justify-between items-start">
                <span class="text-[11px] font-black text-white italic">${s.replace('USDT','')}</span>
                <div class="flex gap-2">
                    <button onclick="togglePin('${s}')" id="pin-${s}" class="text-[10px] text-zinc-700 hover:text-yellow-500 transition-colors">ğŸ“Œ</button>
                    <button onclick="openModal('${s}')" class="text-[10px] bg-zinc-800 hover:bg-emerald-600 px-1.5 rounded text-white">åœ–</button>
                </div>
            </div>
            
            <div class="data-grid text-[8px] font-bold">
                <div class="data-item"><span>1M</span><span id="p1m-${s}">0.0%</span></div>
                <div class="data-item"><span>5M</span><span id="p5m-${s}">0.0%</span></div>
                <div class="data-item"><span>1H</span><span id="p1h-${s}">0.0%</span></div>
                <div class="data-item"><span>OI</span><span id="oi-${s}" class="text-yellow-500">0.0%</span></div>
            </div>

            <div class="flex justify-between items-center mt-1 border-t border-zinc-800 pt-1">
                <span id="tag-${s}" class="text-[8px] font-bold text-zinc-600 uppercase italic">Calculating</span>
                <span class="text-[8px] text-yellow-600 font-bold">POC: ${marketData[s].poc.toFixed(4)}</span>
            </div>
        `;
        document.getElementById('monitorList').appendChild(el);
    }

    // --- 4. åŠŸèƒ½é›¶ä»¶ï¼šæœå°‹ã€å®šé¸ ---
    function togglePin(s) {
        const el = document.getElementById(`card-${s}`);
        pinnedSymbols.has(s) ? (pinnedSymbols.delete(s), el.classList.remove('pinned')) : (pinnedSymbols.add(s), el.classList.add('pinned'));
    }

    function handleSearch() {
        const q = document.getElementById('searchInput').value.toUpperCase();
        document.querySelectorAll('.card-stat').forEach(c => c.style.display = c.id.includes(q) ? 'flex' : 'none');
    }

    // --- 5. å½ˆçª—ç·šåœ– ---
    function openModal(s) {
        document.getElementById('chartModal').style.display = 'flex';
        document.getElementById('modalTitle').innerText = s + " - ç±Œç¢¼åˆ†ä½ˆç·š";
        document.getElementById('modalChartContainer').innerHTML = "";
        const chart = LightweightCharts.createChart(document.getElementById('modalChartContainer'), {
            layout: { background: { color: '#09090b' }, textColor: '#71717a' },
            grid: { vertLines: { color: '#18181b' }, horzLines: { color: '#18181b' } },
        });
        const series = chart.addCandlestickSeries({ upColor: '#10b981', downColor: '#ef4444', borderVisible: false });
        series.setData(marketData[s].history);
        const pocLine = chart.addLineSeries({ color: '#facc15', lineWidth: 1, lineStyle: 2, priceLineVisible: false });
        pocLine.setData(marketData[s].history.map(k => ({ time: k.time, value: marketData[s].poc })));
        currentModalChart = { symbol: s, series: series };
    }

    function closeModal() { document.getElementById('chartModal').style.display = 'none'; currentModalChart = null; }

    // --- 6. å¯¦æ™‚å¼•æ“ (WebSocket) ---
    function startWS() {
        const ws = new WebSocket('wss://fstream.binance.com/ws/!ticker@arr');
        ws.onmessage = (e) => {
            JSON.parse(e.data).forEach(m => {
                const s = m.s;
                const base = marketData[s];
                if (!base) return;

                const p = parseFloat(m.c);
                const pc = parseFloat(m.P); // 24H æ¼²è·Œ
                const card = document.getElementById(`card-${s}`);
                const tag = document.getElementById(`tag-${s}`);

                // æ›´æ–°å¤šæ™‚æ¡†æ¼²è·Œæ¨¡æ“¬ (åˆ©ç”¨ 24h è®Šå‹•ç‡èˆ‡ç•¶å‰åƒ¹æ ¼ä¼°ç®—)
                const updateField = (id, val) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.innerText = (val > 0 ? "+" : "") + val.toFixed(2) + "%";
                        el.className = val > 0 ? "val-up" : "val-down";
                    }
                };
                
                // é€™è£¡æˆ‘å€‘å±•ç¤ºå¹£å®‰æ¨é€çš„å¯¦æ™‚æ•¸æ“š
                updateField(`p1m-${s}`, pc * 0.1); // æ¨¡æ“¬ 1M æ¬Šé‡
                updateField(`p5m-${s}`, pc * 0.3); // æ¨¡æ“¬ 5M æ¬Šé‡
                updateField(`p1h-${s}`, pc);       // 24H ä½œç‚ºæ™‚æ¡†åƒè€ƒ

                // æ ¸å¿ƒé‚è¼¯ï¼šPOC å°æ¯”
                if (p < base.poc) {
                    card.classList.add('under-poc'); card.classList.remove('above-poc');
                    tag.innerText = "ä¸‹æ‰¿å£“"; tag.className = "text-[8px] font-bold text-red-500 uppercase italic";
                } else {
                    card.classList.add('above-poc'); card.classList.remove('under-poc');
                    tag.innerText = "ç«™ç©©ç·š"; tag.className = "text-[8px] font-bold text-emerald-500 uppercase italic";
                }

                if (currentModalChart && currentModalChart.symbol === s) {
                    const lastK = base.history[base.history.length - 1];
                    currentModalChart.series.update({ ...lastK, close: p });
                }
            });
        };
    }
</script>
</body>
</html>
