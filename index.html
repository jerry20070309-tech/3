<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>⚡ TRIDENT POC FINAL PRO</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background:#050505; color:#d4d4d8; font-family:monospace; overflow:hidden; }
.card { background:#111; border:1px solid #222; transition:.3s; }
.low-risk { border:2px solid #22c55e; box-shadow:0 0 15px #22c55e55; }
.mid-risk { border:2px solid #f59e0b; }
.prep { border:2px solid #3b82f6; }
.progress { height:3px; background:#3b82f6; width:0%; transition:width .1s linear;}
</style>
</head>
<body class="p-4 h-screen flex flex-col">

<header class="flex justify-between items-center mb-2">
<div class="flex gap-4 items-center">
<h1 class="text-xl font-bold">TRIDENT POC FINAL</h1>
<input id="searchInput" placeholder="搜尋幣兌..." class="bg-black border border-zinc-700 px-2 py-1 text-sm"/>
</div>
<div class="flex items-center gap-4">
<div class="w-40 bg-zinc-800 rounded">
<div id="countBar" class="progress"></div>
</div>
<button id="startBtn" class="bg-blue-600 px-4 py-1 text-sm">啟動</button>
</div>
</header>

<main class="flex flex-1 overflow-hidden gap-4">
<div id="coinList" class="flex-1 grid grid-cols-3 gap-3 overflow-y-auto"></div>
<div class="w-72 border border-zinc-800 bg-black/50 p-2 flex flex-col">
<h2 class="text-sm mb-2">低風險紀錄</h2>
<div id="recordBoard" class="flex-1 overflow-y-auto text-xs"></div>
</div>
</main>

<script>

// ====== 基本設定 ======

const EXCLUDE = [
'BTCUSDT','ETHUSDT','BNBUSDT','SOLUSDT','XRPUSDT','ADAUSDT',
'DOGEUSDT','TRXUSDT','DOTUSDT','MATICUSDT','LTCUSDT'
];

let marketData = {};
let running = false;
let alerted = new Set();
let pinned = new Set(JSON.parse(localStorage.getItem("pins"))||[]);
let refreshTimer;
let ws;

// ====== 啟動 / 停止 ======

document.getElementById("startBtn").onclick = () => {
if(!running){
start();
}else{
stop();
}
};

function start(){
running = true;
document.getElementById("startBtn").innerText="停止";
refreshAll();
startCountdown();
startWS();
}

function stop(){
running = false;
document.getElementById("startBtn").innerText="啟動";
clearInterval(refreshTimer);
if(ws) ws.close();
}

// ====== 倒數條 ======

function startCountdown(){
let elapsed=0;
refreshTimer=setInterval(()=>{
elapsed+=100;
let percent=(elapsed/30000)*100;
document.getElementById("countBar").style.width=percent+"%";
if(elapsed>=30000){
elapsed=0;
refreshAll();
}
},100);
}

// ====== 抓幣 ======

async function refreshAll(){
const tickers = await fetch("https://fapi.binance.com/fapi/v1/ticker/24hr").then(r=>r.json());

let symbols = tickers
.filter(t=>t.symbol.endsWith("USDT") && !EXCLUDE.includes(t.symbol))
.sort((a,b)=>b.quoteVolume-a.quoteVolume)
.slice(0,100)
.map(t=>t.symbol);

for(let s of symbols){
await initSymbol(s);
await new Promise(r=>setTimeout(r,80));
}
}

// ====== 初始化幣 ======

async function initSymbol(symbol){
try{
let k4h = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=4h&limit=80`).then(r=>r.json());
let k15 = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=120`).then(r=>r.json());

let poc4h = calculatePOC(k4h);
let poc15 = calculatePOC(k15);

let ma7 = calcMA(k15,7);
let ma20 = calcMA(k15,20);
let ma25 = calcMA(k15,25);
let ma99 = calcMA(k15,99);

marketData[symbol] = {
poc4h,
poc15,
ma7:ma7.at(-1),
ma20:ma20.at(-1),
ma25:ma25.at(-1),
ma99:ma99.at(-1),
lastPrice:parseFloat(k15.at(-1)[4]),
k4h,
k15,
bigOrders:[],
volumeWindow:[]
};

}catch(e){}
}

// ====== POC ======

function calculatePOC(klines){
let bins={};
let prices=klines.map(k=>parseFloat(k[4]));
let min=Math.min(...prices);
let max=Math.max(...prices);
let step=(max-min)/25||0.00001;
klines.forEach(k=>{
let p=parseFloat(k[4]);
let v=parseFloat(k[5]);
let key=Math.floor((p-min)/step)*step+min;
bins[key]=(bins[key]||0)+v;
});
return parseFloat(Object.entries(bins).sort((a,b)=>b[1]-a[1])[0][0]);
}

// ====== MA ======

function calcMA(data,period){
let result=[];
for(let i=0;i<data.length;i++){
if(i<period-1){result.push(null);continue;}
let sum=0;
for(let j=0;j<period;j++){
sum+=parseFloat(data[i-j][4]);
}
result.push(sum/period);
}
return result;
}

// ====== WebSocket ======

function startWS(){
ws = new WebSocket("wss://fstream.binance.com/ws/!ticker@arr");

ws.onmessage = (e)=>{
JSON.parse(e.data).forEach(t=>{
let base = marketData[t.s];
if(!base) return;

let price=parseFloat(t.c);
let vol=parseFloat(t.q);

detectOrderFlow(t.s,vol,price);

if(price>base.poc4h){
renderCoin(t.s,price);
}
});
};
}

// ====== 訂單流分析 ======

function detectOrderFlow(symbol,volume,price){

let data = marketData[symbol];
if(!data) return;

data.bigOrders.push(volume);
if(data.bigOrders.length>200) data.bigOrders.shift();

let mean = data.bigOrders.reduce((a,b)=>a+b,0)/data.bigOrders.length;
let std = Math.sqrt(data.bigOrders.reduce((a,b)=>a+(b-mean)**2,0)/data.bigOrders.length);

let z = (volume-mean)/std;

let big = z>3;

data.volumeWindow.push(volume);
if(data.volumeWindow.length>30) data.volumeWindow.shift();

let meanW = data.volumeWindow.reduce((a,b)=>a+b,0)/data.volumeWindow.length;
let stdW = Math.sqrt(data.volumeWindow.reduce((a,b)=>a+(b-meanW)**2,0)/data.volumeWindow.length);

let cluster = volume > meanW + 2.5*stdW;

data.bigSignal = big;
data.clusterSignal = cluster;
}

// ====== 渲染 ======

function renderCoin(symbol,price){

let data=marketData[symbol];
let container=document.getElementById("coinList");
let el=document.getElementById(symbol);

let risk="prep";

if(price<=data.poc4h && price>=data.ma99){
risk="mid-risk";
}
if(price<=data.poc4h && price<=data.ma99){
risk="low-risk";
if(!alerted.has(symbol)){
alerted.add(symbol);
addRecord(symbol,price);
}
}

if(!el){
el=document.createElement("div");
el.id=symbol;
container.appendChild(el);
}

el.className=`card p-3 text-xs ${risk}`;
el.innerHTML=`
<div class="flex justify-between">
<span class="font-bold">${symbol}</span>
<button onclick="togglePin('${symbol}')">${pinned.has(symbol)?"取消標記":"標記"}</button>
</div>
<div>現價: ${price.toFixed(4)}</div>
<div>4H POC: ${data.poc4h.toFixed(4)}</div>
<div>15M POC: ${data.poc15.toFixed(4)}</div>
<div>MA7:${data.ma7?.toFixed(3)} MA20:${data.ma20?.toFixed(3)}</div>
<div>MA25:${data.ma25?.toFixed(3)} MA99:${data.ma99?.toFixed(3)}</div>
<div>大單:${data.bigSignal?"是":"否"} 密集成交:${data.clusterSignal?"是":"否"}</div>
`;
}

// ====== 紀錄板 ======

function addRecord(symbol,price){
let board=document.getElementById("recordBoard");
let div=document.createElement("div");
div.innerHTML=`${symbol} 低風險進場 @ ${price}`;
board.prepend(div);
}

// ====== 標記 ======

function togglePin(symbol){
if(pinned.has(symbol)){
pinned.delete(symbol);
}else{
pinned.add(symbol);
}
localStorage.setItem("pins",JSON.stringify([...pinned]));
}

// ====== 搜尋 ======

document.getElementById("searchInput").addEventListener("keydown",async(e)=>{
if(e.key==="Enter"){
let s=e.target.value.toUpperCase();
if(!s.endsWith("USDT")) s+="USDT";
await initSymbol(s);
e.target.value="";
}
});

</script>
</body>
</html>
