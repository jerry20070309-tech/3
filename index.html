<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ SNIPER V17.1 | å·¨é¯¨æ ¸å¿ƒè£œå®Œç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { background: #050505; color: #FFD700; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .card { background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 8px; transition: 0.3s; }
        .tight-zone { border: 1px solid #3b82f6 !important; box-shadow: inset 0 0 15px #1e3a8a; }
        .monster-boost { animation: flash-red 0.5s infinite; border: 2px solid #ef4444 !important; }
        @keyframes flash-red { 0%, 100% { background: #0a0a0a; } 50% { background: #450a0a; } }
        .metric-box { background: rgba(20,20,20,0.8); border: 1px solid #333; padding: 4px; border-radius: 4px; }
        .flow-high { color: #22c55e; text-shadow: 0 0 5px #22c55e; }
        #logBox div { border-bottom: 1px solid #111; padding: 2px 0; }
    </style>
</head>
<body class="h-screen flex flex-col p-2 text-[10px]">

    <header class="p-3 border-b border-yellow-900 flex justify-between items-center bg-black">
        <div>
            <h1 class="text-xl font-black text-yellow-500 italic uppercase">âš¡ SNIPER V17.1</h1>
            <div id="strategyNotice" class="text-blue-400 font-bold uppercase tracking-tighter">ç­‰å¾…æ‰‹å‹•å•Ÿå‹•...</div>
        </div>
        <div class="flex gap-2">
            <button id="startBtn" onclick="toggleRadar(true)" class="bg-green-600 text-white px-6 py-1 rounded font-black hover:bg-green-500">START RADAR</button>
            <button id="stopBtn" onclick="toggleRadar(false)" class="bg-red-600 text-white px-6 py-1 rounded font-black hidden">STOP & COOL</button>
        </div>
        <div id="apiStatus" class="bg-zinc-800 px-4 py-1 rounded text-zinc-500 font-bold uppercase">OFFLINE</div>
    </header>

    <div class="bg-zinc-900/50 p-2 border-b border-yellow-900/30 grid grid-cols-5 gap-4 uppercase font-bold text-zinc-400">
        <div>ğŸŒ€ SQZ(æ©«ç›¤) <span id="v_sqz" class="text-yellow-500">1.2%</span><input type="range" id="i_sqz" min="5" max="50" value="12" class="w-full"></div>
        <div>ğŸ¯ POC(ä½ç½®) <span id="v_poc" class="text-green-400">1.1%</span><input type="range" id="i_poc" min="1" max="100" value="11" class="w-full"></div>
        <div>ğŸš¨ SLP(å™´ç™¼) <span id="v_slp" class="text-red-500">-15%</span><input type="range" id="i_slp" min="5" max="50" value="15" class="w-full"></div>
        <div>ğŸš€ DRV(çœŸç©º) <span id="v_drv" class="text-blue-400">90</span><input type="range" id="i_drv" min="10" max="150" value="90" class="w-full"></div>
        <div>âš¡ MOM(å‡ç·š) <span id="v_mom" class="text-orange-500">0.8%</span><input type="range" id="i_mom" min="1" max="50" value="8" class="w-full"></div>
    </div>

    <div class="flex flex-1 overflow-hidden gap-2 mt-2">
        <main class="flex-1 overflow-y-auto p-2 grid grid-cols-4 gap-3 content-start" id="dashboard"></main>
        <aside class="w-80 border-l border-yellow-900 bg-zinc-950 flex flex-col">
            <div class="p-2 border-b border-zinc-800 text-red-500 font-black uppercase flex justify-between">
                <span>ğŸ›¡ï¸ å·¨é¯¨èˆ‡æ¸…ç®—æ—¥èªŒ</span>
                <span id="flowAvg" class="text-zinc-500 text-[8px]">FLOW: 0.00</span>
            </div>
            <div id="logBox" class="flex-1 overflow-y-auto p-2 space-y-1 text-[9px]"></div>
        </aside>
    </div>

<script>
    let isRunning = false, stats = {}, activeWS = new Map();
    let FILTER = { SQZ: 0.012, POC: 0.011, SLP: -0.15, DRV: 90, MOM: 0.008 };
    let searchFilter = "";

    // [H] é€±å…­/é€±ä¸€ç­–ç•¥è‡ªå‹•åŒ–
    function applyDateStrategy() {
        const day = new Date().getDay(); 
        const notice = document.getElementById('strategyNotice');
        if (day === 6) { 
            notice.innerText = "ğŸ“… é€±å…­æ¨¡å¼ï¼šé«˜å‹ç‡ç·Šæ¹Šæ•¸æ“š";
            FILTER.SQZ = 0.008; document.getElementById('i_sqz').value = 8;
            document.getElementById('v_sqz').innerText = "0.8%";
        } else if (day === 1) {
            notice.innerText = "ğŸ“… é€±ä¸€æ¨¡å¼ï¼šé«˜å‹ç‡æ”¾é‡çªç ´";
            FILTER.POC = 0.015; document.getElementById('i_poc').value = 15;
            document.getElementById('v_poc').innerText = "1.5%";
        } else {
            notice.innerText = "ğŸ“… å¯¦æ™‚å…¨åŠŸèƒ½æƒæä¸­";
        }
    }

    function toggleRadar(state) {
        isRunning = state;
        document.getElementById('startBtn').classList.toggle('hidden', state);
        document.getElementById('stopBtn').classList.toggle('hidden', !state);
        if(state) { updateStatus("ONLINE", "text-green-400"); fetchPacketOne(); fetchPacketTwo(); }
        else { updateStatus("OFFLINE", "text-zinc-500"); }
    }

    // [A-1] å°åŒ…ä¸€ï¼šä¸‰ç§’ä¸€ç™¼ (åƒ¹æ ¼+è³‡è²»+åŸºç¤ç®—åˆ†)
    async function fetchPacketOne() {
        if (!isRunning) return;
        try {
            const [tRes, pRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'),
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
            ]);
            const tickers = await tRes.json();
            const premiums = await pRes.json();
            const pMap = Object.fromEntries(premiums.map(p => [p.symbol, p.lastFundingRate]));

            tickers.forEach(t => {
                const s = t.symbol; if (!s.endsWith('USDT')) return;
                const p = parseFloat(t.lastPrice), h = parseFloat(t.highPrice), l = parseFloat(t.lowPrice);
                
                let score = 0;
                const range = (h - l) / p;
                if (range <= FILTER.SQZ) score += 40;
                if (Math.abs(t.priceChangePercent) > 2) score += 20;
                
                if (!stats[s]) stats[s] = { s, score:0, price:p, funding:0, liq:0, buyVol:0, sellVol:0, wallP:0, wallV:0 };
                stats[s] = { ...stats[s], price:p, score, funding: pMap[s]||0, isVacuum: (h-p)/p < 0.01, vol: parseFloat(t.quoteVolume) };
            });
            renderUI();
            updateStatus("Packet 1: OK", "text-green-400");
        } catch(e){}
        setTimeout(fetchPacketOne, 3000);
    }

    // [A-2] å°åŒ…äºŒï¼šå¾Œå°é¸å®Œå¾Œæ‰“åŒ… (æ·±åº¦æ›å–®ç‰† + WebSocket å·¨é¯¨é€£ç·šç®¡ç†)
    async function fetchPacketTwo() {
        if (!isRunning) return;
        const sortedCoins = Object.values(stats).sort((a,b) => b.score - a.score);
        const topSymbols = sortedCoins.slice(0, 10);
        
        // 1. æ‰“åŒ…æ›´æ–°æ·±åº¦ (REST)
        for (const item of topSymbols) {
            if (!isRunning) break;
            try {
                const res = await fetch(`https://fapi.binance.com/fapi/v1/depth?symbol=${item.s}&limit=5`);
                const d = await res.json();
                const topWall = [...d.asks, ...d.bids].sort((a,b) => b[1]-a[1])[0];
                stats[item.s].wallP = topWall[0];
                stats[item.s].wallV = topWall[0] * topWall[1];
                ensureWS(item.s); // ç¢ºä¿é€™äº›å¹£æœ‰å·¨é¯¨ç›£æ§
            } catch(e){}
            await new Promise(r => setTimeout(r, 600)); 
        }

        // 2. è‡ªå‹•æ–·é–‹éæ½›åŠ›å¹£çš„é€£ç·š (ç¯€çœæ•ˆèƒ½)
        activeWS.forEach((ws, sym) => {
            if (!topSymbols.find(x => x.s === sym)) { ws.close(); activeWS.delete(sym); }
        });

        updateStatus("Packet 2: BATCH OK", "text-blue-400");
        setTimeout(fetchPacketTwo, 6000);
    }

    // [E] å·¨é¯¨æ ¸å¿ƒï¼šå¤šç¶­åº¦å¤§å–®èˆ‡çˆ†å€‰åˆ¤å®š
    function ensureWS(s) {
        if (activeWS.has(s)) return;
        const ws = new WebSocket(`wss://fstream.binance.com/ws/${s.toLowerCase()}@aggTrade/${s.toLowerCase()}@forceOrder`);
        ws.onmessage = (e) => {
            const d = JSON.parse(e.data);
            // è™•ç†çˆ†å€‰ (Liquidation)
            if (d.e === "forceOrder") {
                const val = parseFloat(d.o.q) * parseFloat(d.o.p);
                stats[s].liq += val;
                addLog(`ğŸ’€ [çˆ†å€‰] ${s} | $${(val/1000).toFixed(1)}K | ${d.o.S}`, "text-red-500 font-bold");
            }
            // è™•ç†å¤§å–® (Whale aggTrade)
            if (d.e === "aggTrade") {
                const amount = parseFloat(d.q) * parseFloat(d.p);
                if (amount > 50000) { // å·¨é¯¨é–€æª»: 5è¬ç¾é‡‘
                    const side = d.m ? "SELL" : "BUY";
                    if (side === "BUY") stats[s].buyVol += amount; else stats[s].sellVol += amount;
                    const color = side === "BUY" ? "text-green-400" : "text-orange-600";
                    addLog(`ğŸ‹ [å·¨é¯¨] ${s} | $${(amount/1000).toFixed(0)}K | ${side}`, color);
                }
            }
        };
        activeWS.set(s, ws);
    }

    function renderUI() {
        const dashboard = document.getElementById('dashboard');
        let list = Object.values(stats);
        if (searchFilter) list = list.filter(x => x.s.includes(searchFilter));
        const sorted = list.sort((a,b) => b.score - a.score).slice(0, 48);
        
        dashboard.innerHTML = sorted.map(x => {
            const flow = x.buyVol - x.sellVol;
            return `
            <div class="card p-3 ${x.score >= 50 ? 'tight-zone' : ''} ${x.vol > 8e8 ? 'monster-boost' : ''}">
                <div class="flex justify-between font-black">
                    <span class="text-white">${x.s.replace('USDT','')}</span>
                    <span class="text-yellow-500">â˜… ${x.score}</span>
                </div>
                <div class="text-2xl font-black text-white my-1">$${x.price}</div>
                <div class="flex justify-between text-[8px] mb-2 font-bold uppercase">
                    <span class="${x.funding < 0 ? 'text-red-500' : 'text-green-500'}">è³‡è²»: ${(x.funding*100).toFixed(4)}%</span>
                    ${x.isVacuum ? '<span class="bg-blue-600 text-white px-1">VACUUM</span>' : ''}
                    <span class="${flow > 0 ? 'text-green-400' : 'text-red-400'}">FLOW: ${(flow/1000).toFixed(0)}K</span>
                </div>
                <div class="grid grid-cols-2 gap-1">
                    <div class="metric-box text-zinc-600">WALL PRICE<br><span class="text-blue-400 font-bold">$${parseFloat(x.wallP).toFixed(4)}</span></div>
                    <div class="metric-box text-zinc-600">LIQUIDATION<br><span class="text-red-500 font-bold">$${(x.liq/1000).toFixed(1)}K</span></div>
                </div>
            </div>`;
        }).join('');
    }

    const sliders = ['i_sqz', 'i_poc', 'i_slp', 'i_drv', 'i_mom'];
    sliders.forEach(id => {
        document.getElementById(id).oninput = (e) => {
            const key = id.split('_')[1].toUpperCase();
            const val = parseFloat(e.target.value);
            FILTER[key] = (key === 'SLP' ? -(val/100) : val / 1000);
            document.getElementById('v_'+id.split('_')[1]).innerText = (val/10).toFixed(1) + (key==='DRV'?'':'%');
            renderUI();
        };
    });
    document.getElementById('searchInput').oninput = (e) => { searchFilter = e.target.value.toUpperCase(); renderUI(); };

    function addLog(m, c) {
        const b = document.getElementById('logBox');
        const d = document.createElement('div');
        d.className = `${c}`;
        d.innerHTML = `[${new Date().toLocaleTimeString()}] ${m}`;
        b.prepend(d);
        if(b.childNodes.length > 50) b.removeChild(b.lastChild);
    }

    function updateStatus(m, c) { const s = document.getElementById('apiStatus'); s.innerText = m; s.className = `bg-zinc-800 px-4 py-1 rounded font-bold uppercase ${c}`; }

    applyDateStrategy();
</script>
</body>
</html>
