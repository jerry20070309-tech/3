import streamlit as st
import pandas as pd
import time
from datetime import datetime
from binance.client import Client

# é é¢é¢¨æ ¼è¨­å®š
st.set_page_config(page_title="SNIPER WHALE V1.0", layout="wide")
st.markdown("<style>.stMetric { background-color: #0a0a0a; border: 1px solid #333; padding: 10px; border-radius: 5px; }</style>", unsafe_allow_html=True)

# å´é‚Šæ¬„èˆ‡æœå°‹åŠŸèƒ½
with st.sidebar:
    st.title("âš¡ SNIPER RADAR")
    symbol = st.text_input("ğŸ” æœå°‹å¹£å° (å¦‚ BTCUSDT)", value="BTCUSDT").upper()
    whale_threshold = st.number_input("ğŸ’° å·¨é¯¨é–€æª» (USDT)", value=50000)
    api_key = st.text_input("ğŸ”‘ API Key", type="password")
    api_secret = st.text_input("ğŸ”‘ API Secret", type="password")
    is_active = st.toggle("ğŸš€ START MONITORING")

# æ ¸å¿ƒæ•¸æ“šåŒ…æŠ“å–
def fetch_data(client, target):
    try:
        trades = client.futures_recent_trades(symbol=target, limit=20)
        oi = client.futures_open_interest(symbol=target)
        liq = client.futures_get_all_liquidation_orders(symbol=target, limit=1)
        return trades, oi, liq
    except Exception as e:
        return None, None, None

# åŸ·è¡Œé‚è¼¯
if is_active and api_key and api_secret:
    client = Client(api_key, api_secret)
    placeholder = st.empty()
    last_oi = 0.0

    while True:
        start_time = time.perf_counter()
        trades, oi, liq = fetch_data(client, symbol)

        if trades and oi:
            price = float(trades[-1]['price'])
            curr_oi = float(oi['openInterest'])
            oi_diff = curr_oi - last_oi if last_oi > 0 else 0
            trade_val = price * float(trades[-1]['qty'])
            
            # é€±å…­åˆ¤å®š
            is_sat = datetime.utcnow().weekday() == 5
            
            with placeholder.container():
                st.header(f"ğŸ“Š {symbol} çœ‹æ¿ " + ("(ğŸ“… é€±å…­æ¨¡å¼)" if is_sat else ""))
                c1, c2, c3 = st.columns(3)
                c1.metric("åƒ¹æ ¼", f"${price:,.2f}")
                c2.metric("æŒå€‰è®Šå‹• (B2)", f"{curr_oi:,.2f}", f"{oi_diff:,.2f}")
                c3.metric("æœ€æ–°æˆäº¤ (P2)", f"${trade_val:,.0f}")

                # åˆ¤å®šé‚è¼¯
                if trade_val >= whale_threshold:
                    if not trades[-1]['isBuyerMaker'] and oi_diff > 0:
                        st.success(f"ğŸ’ åµæ¸¬åˆ°å·¨é¯¨é€²è²¨: ${trade_val:,.0f}")
                    elif trades[-1]['isBuyerMaker'] and oi_diff < 0:
                        st.error(f"âš ï¸ åµæ¸¬åˆ°å·¨é¯¨å‡ºè²¨: ${trade_val:,.0f}")

                if liq:
                    st.warning(f"ğŸ”¥ åµæ¸¬åˆ° P3 çˆ†å€‰äº‹ä»¶")

            last_oi = curr_oi
            
        # åš´æ ¼ 3 ç§’å¾ªç’°
        wait = max(0, 3.0 - (time.perf_counter() - start_time))
        time.sleep(wait)
else:
    st.info("è«‹é…ç½®å´é‚Šæ¬„ä¸¦é»æ“Šå•Ÿå‹•ã€‚")
