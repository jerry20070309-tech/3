<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>TRIDENT ULTIMATE FINAL</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#050505;color:#d4d4d8;font-family:monospace}
.card{background:#111;border:1px solid #222;border-radius:10px;padding:14px;transition:.3s}
.card:hover{transform:translateY(-4px)}
.low{border:2px solid #22c55e}
.mid{border:2px solid #eab308}
.pre{border:2px solid #3b82f6}
.refresh{height:4px;background:#3b82f6;width:0%}
.logbox{background:#0a0a0a;border:1px solid #222}
.pin{color:#facc15}
</style>
</head>
<body class="p-6">

<div class="flex justify-between mb-4">
<h1 class="text-xl font-bold text-blue-400">TRIDENT ULTIMATE</h1>
<div class="flex gap-4">
<input id="searchInput" placeholder="搜尋幣種..." class="bg-black border border-zinc-700 px-3 py-1 text-sm"/>
<button onclick="toggleEngine()" id="engineBtn" class="bg-blue-600 px-4 py-1 text-sm">啟動</button>
</div>
</div>

<div class="w-full bg-zinc-800 mb-4"><div id="refreshBar" class="refresh"></div></div>

<div class="flex gap-6">
<div id="cards" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 flex-1"></div>

<div class="w-80 logbox rounded p-3">
<div class="text-green-400 font-bold mb-2">低風險紀錄</div>
<div id="logArea" class="text-xs space-y-2 max-h-[600px] overflow-y-auto"></div>
</div>
</div>

<script>
// ====== 硬排除清單 ======
const EXCLUDE = [
'BTCUSDT','ETHUSDT','BNBUSDT','SOLUSDT','XRPUSDT','ADAUSDT',
'DOGEUSDT','TRXUSDT','DOTUSDT','XAUUSDT','XAGUSDT'
];

let running=false;
let mainTimer=null;
let progressTimer=null;
let loggedSet=new Set();
let pinned=new Set(JSON.parse(localStorage.getItem("pins")||"[]"));
let marketData={};
let btcData=[];

// ====== 啟動/停止 ======
function toggleEngine(){
if(running){
clearInterval(mainTimer);
clearInterval(progressTimer);
running=false;
engineBtn.innerText="啟動";
return;
}
running=true;
engineBtn.innerText="停止";
cycle();
mainTimer=setInterval(cycle,30000);
progress();
}

function progress(){
let w=0;
progressTimer=setInterval(()=>{
if(!running)return;
w+=100/300;
if(w>=100)w=0;
refreshBar.style.width=w+"%";
},100);
}

// ====== 主輪詢 ======
async function cycle(){
marketData={};
await loadBTC();

let tickers=await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());

let filtered=tickers
.filter(t=>t.symbol.endsWith('USDT'))
.filter(t=>!EXCLUDE.includes(t.symbol))
.sort((a,b)=>b.quoteVolume-a.quoteVolume)
.slice(0,150);

for(let t of filtered){
await loadSymbol(t.symbol);
}

render();
}

// ====== BTC ======
async function loadBTC(){
btcData=await fetch('https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=15m&limit=100').then(r=>r.json());
}

// ====== 單幣 ======
async function loadSymbol(sym){
try{
let k15=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=15m&limit=100`).then(r=>r.json());
let k4h=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=4h&limit=100`).then(r=>r.json());

let price=parseFloat(k15[k15.length-1][4]);

let poc4=calcPOC(k4h);
if(price<=poc4)return; // 必須突破4H POC

let ma7=MA(k15,7);
let ma20=MA(k15,20);
let ma25=MA(k15,25);
let ma99=MA(k15,99);

let bottom=breakReclaim(k4h);
let bigOrder=detectBigOrder(k15);
let dense=detectDense(k15);
let btcCorr=correlation(k15,btcData);

let score=0;
if(price>poc4)score+=30;
if(ma7>ma20 && ma20>ma25 && ma25>ma99)score+=20;
if(bottom)score+=15;
if(bigOrder)score+=10;
if(dense)score+=5;
if(Math.abs(btcCorr)<0.6)score+=10;

if(score<85)return;

let type="pre";
if(price<=ma99 || price<=poc4)type="mid";
if(price<=ma99 && price<=poc4)type="low";

marketData[sym]={price,poc4,score,type};

if(type==="low" && !loggedSet.has(sym)){
addLog(sym,price,score);
loggedSet.add(sym);
}

}catch(e){}
}

// ====== 工具 ======
function calcPOC(k){
let bins={};
let prices=k.map(x=>parseFloat(x[4]));
let min=Math.min(...prices),max=Math.max(...prices);
let step=(max-min)/20||0.00001;
k.forEach(c=>{
let p=parseFloat(c[4]);
let v=parseFloat(c[5]);
let b=Math.floor((p-min)/step)*step+min;
bins[b]=(bins[b]||0)+v;
});
let maxV=0,poc=min;
for(let b in bins){
if(bins[b]>maxV){maxV=bins[b];poc=parseFloat(b);}
}
return poc;
}

function MA(k,len){
return k.slice(-len).reduce((a,b)=>a+parseFloat(b[4]),0)/len;
}

function breakReclaim(k){
let lows=k.map(x=>parseFloat(x[3]));
let min=Math.min(...lows.slice(0,-5));
let last=parseFloat(k[k.length-1][4]);
return last>min*1.02;
}

function detectBigOrder(k){
let vols=k.map(x=>parseFloat(x[5]));
let avg=vols.reduce((a,b)=>a+b)/vols.length;
let sd=Math.sqrt(vols.map(v=>(v-avg)**2).reduce((a,b)=>a+b)/vols.length);
return (vols[vols.length-1]-avg)/sd>2.5;
}

function detectDense(k){
let vols=k.map(x=>parseFloat(x[5]));
let avg=vols.reduce((a,b)=>a+b)/vols.length;
return vols.slice(-5).every(v=>v>avg*1.5);
}

function correlation(a,b){
let arr1=a.map(x=>parseFloat(x[4]));
let arr2=b.map(x=>parseFloat(x[4]));
let avg1=arr1.reduce((x,y)=>x+y)/arr1.length;
let avg2=arr2.reduce((x,y)=>x+y)/arr2.length;
let num=0,d1=0,d2=0;
for(let i=0;i<arr1.length;i++){
num+=(arr1[i]-avg1)*(arr2[i]-avg2);
d1+=(arr1[i]-avg1)**2;
d2+=(arr2[i]-avg2)**2;
}
return num/Math.sqrt(d1*d2);
}

// ====== UI ======
function render(){
cards.innerHTML="";
Object.keys(marketData).forEach(sym=>{
let d=marketData[sym];
cards.innerHTML+=`
<div class="card ${d.type}">
<div class="flex justify-between">
<span class="font-bold">${sym.replace('USDT','')}</span>
<span>${d.score}</span>
</div>
<div class="text-xs mt-2">
價格 ${d.price.toFixed(4)}<br>
4H POC ${d.poc4.toFixed(4)}
</div>
<button onclick="togglePin('${sym}')" class="mt-2 text-xs ${pinned.has(sym)?'pin':''}">
${pinned.has(sym)?'取消標記':'標記'}
</button>
</div>`;
});
}

function togglePin(sym){
if(pinned.has(sym))pinned.delete(sym);
else pinned.add(sym);
localStorage.setItem("pins",JSON.stringify([...pinned]));
render();
}

function addLog(sym,price,score){
logArea.innerHTML=
`<div class="bg-green-900/30 border-l-4 border-green-500 p-2">
${sym.replace('USDT','')} 低風險進場<br>
價格 ${price.toFixed(4)}<br>
評分 ${score}
</div>`+logArea.innerHTML;
}
</script>
</body>
</html>
