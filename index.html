<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>V10 ä¸»å‡æ®µ + OI è·ŸèŠæ¨¡å‹</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#050505;color:#d4d4d8;font-family:monospace;overflow:hidden}
.card{background:#0f0f11;border:1px solid #222;padding:12px;border-radius:8px;transition:.3s}
.card:hover{transform:scale(1.02)}
.progress{height:3px;background:#3b82f6;width:0%}
.exit{border:2px solid #ef4444}
.hold{border:2px solid #22c55e}
</style>
</head>
<body class="p-6 h-screen flex flex-col">

<header class="flex justify-between items-center mb-4">
<h1 class="text-2xl font-bold">ğŸ”¥ V10 ä¸»å‡æ®µ + OI è·ŸèŠæ¨¡å‹</h1>

<div class="flex items-center gap-4">
<input id="tgToken" placeholder="TG BOT TOKEN" class="px-2 py-1 bg-zinc-800 rounded">
<input id="tgChat" placeholder="CHAT ID" class="px-2 py-1 bg-zinc-800 rounded">
<div class="w-48 bg-zinc-800 rounded-full overflow-hidden">
<div id="bar" class="progress"></div>
</div>
<button onclick="testPush()" class="bg-green-600 px-4 py-2 rounded">æ¸¬è©¦æ¨æ’­</button>
<button id="toggle" onclick="toggleSystem()" class="bg-blue-600 px-4 py-2 rounded">é–‹å§‹æƒæ</button>
</div>
</header>

<div class="flex flex-1 gap-4 overflow-hidden">
<div id="main" class="flex-1 grid grid-cols-3 gap-3 overflow-y-auto"></div>
<div class="w-80 border border-zinc-800 rounded p-2 overflow-y-auto">
<h2 class="text-sm mb-2">é«˜æº–ç¢ºç‡ç´€éŒ„æ¿</h2>
<div id="record"></div>
</div>
</div>

<script>

let running=false
let positions={}

async function sendTG(text){
let token=document.getElementById("tgToken").value.trim()
let chat=document.getElementById("tgChat").value.trim()
if(!token||!chat) return
await fetch(`https://api.telegram.org/bot${token}/sendMessage`,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({chat_id:chat,text:text})
})
}

function testPush(){
sendTG("V10 OI æ¨¡å‹æ¸¬è©¦æˆåŠŸ")
}

function ma(data,n){
if(data.length<n) return 0
let sum=0
for(let i=data.length-n;i<data.length;i++){
sum+=parseFloat(data[i][4])
}
return sum/n
}

function calcPOC(k){
let bins={}
k.forEach(c=>{
let p=parseFloat(c[4])
let v=parseFloat(c[5])
let key=Math.round(p*100)/100
bins[key]=(bins[key]||0)+v
})
let max=0,res=0
for(let b in bins){
if(bins[b]>max){max=bins[b];res=parseFloat(b)}
}
return res
}

async function getOI(symbol){
let res=await fetch(`https://fapi.binance.com/futures/data/openInterestHist?symbol=${symbol}&period=15m&limit=10`)
let data=await res.json()
return data.map(x=>parseFloat(x.sumOpenInterest))
}

async function refreshAll(){
if(!running) return
let tickers=await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json())
let list=tickers.filter(t=>t.symbol.endsWith('USDT'))
.sort((a,b)=>b.quoteVolume-a.quoteVolume)
.slice(35,135)

for(let t of list){
await loadSymbol(t.symbol)
await new Promise(r=>setTimeout(r,150))
}
}

async function loadSymbol(s){

let k15=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=120`).then(r=>r.json())
let k4=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=4h&limit=120`).then(r=>r.json())
let oiData=await getOI(s)

if(!k15||!k4||oiData.length<5) return

let price=parseFloat(k15[k15.length-1][4])

// ===== 4H è¶¨å‹¢ =====
let ma20_4h=ma(k4,20)
let ma50_4h=ma(k4,50)
if(!(ma20_4h>ma50_4h && price>ma20_4h)) return

// ===== å»ºå€‰æ”¶æ–‚ =====
let recent=k15.slice(-80)
let high=Math.max(...recent.map(c=>parseFloat(c[2])))
let low=Math.min(...recent.map(c=>parseFloat(c[3])))
let range=(high-low)/low
if(range>0.08) return

// ===== POC çªç ´ =====
let poc=calcPOC(recent)
if(price<=poc) return

// ===== OI ç¢ºèª =====
let oiAvg=oiData.slice(0,-1).reduce((a,b)=>a+b,0)/(oiData.length-1)
let oiNow=oiData[oiData.length-1]

let oiUp=oiData[7]<oiData[8] && oiData[8]<oiData[9]

if(!(oiNow>oiAvg && oiUp)) return

// ===== é€²å ´ =====
if(!positions[s]){
positions[s]={entry:price,max:price}
sendTG(`ğŸ“ˆ é€²å ´ ${s}\nåƒ¹æ ¼:${price}\nOI ä¸Šå‡ç¢ºèª`)
}

let exitSignal=""
let ma20_15=ma(k15,20)

let oiDown=oiData[7]>oiData[8] && oiData[8]>oiData[9]

if(price<ma20_15 && oiDown){
exitSignal="OI ä¸‹é™ + çµæ§‹ç ´å£"
}

if(exitSignal){
sendTG(`âš  å‡ºå ´ ${s}\nåŸå› :${exitSignal}`)
delete positions[s]
}

renderCard(s,price,poc,oiNow,oiAvg,exitSignal)

}

function renderCard(s,p,poc,oiNow,oiAvg,exitSignal){
let el=document.getElementById('card-'+s)
if(!el){
el=document.createElement('div')
el.id='card-'+s
document.getElementById('main').appendChild(el)
}
el.className="card "+(exitSignal?"exit":"hold")
el.innerHTML=`
<div>${s}</div>
<div>ç¾åƒ¹ ${p}</div>
<div>POC ${poc}</div>
<div>OI ç¾åœ¨ ${oiNow}</div>
<div>OI å¹³å‡ ${oiAvg.toFixed(2)}</div>
${exitSignal?`<div style="color:red">${exitSignal}</div>`:""}
`
}

function toggleSystem(){
running=!running
document.getElementById('toggle').innerText=running?'åœæ­¢':'é–‹å§‹æƒæ'
if(running) refreshAll()
}

function countdown(){
let t=0
setInterval(()=>{
if(!running) return
t+=100
let percent=(t/30000)*100
document.getElementById('bar').style.width=percent+'%'
if(t>=30000){
t=0
refreshAll()
}
},100)
}

countdown()

</script>
</body>
</html>
