<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ SNIPER V16.9 | æ‰“åŒ…æµæ§ç©©å®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { background: #050505; color: #FFD700; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .card { background: #0a0a0a; border: 1px solid #1a1a1a; transition: 0.2s; border-radius: 8px; }
        .tight-zone { border: 1px solid #3b82f6 !important; box-shadow: inset 0 0 15px #1e3a8a; }
        .monster-boost { animation: flash-red 0.5s infinite; border: 2px solid #ef4444 !important; }
        @keyframes flash-red { 0%, 100% { background: #0a0a0a; } 50% { background: #450a0a; } }
        .metric-box { background: rgba(20,20,20,0.8); border: 1px solid #333; padding: 4px; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col p-2 text-[10px]">

    <header class="p-3 border-b border-yellow-900 flex justify-between items-center bg-black">
        <div>
            <h1 class="text-xl font-black text-yellow-500 italic uppercase">âš¡ SNIPER V16.9</h1>
            <div id="dateNotice" class="text-blue-400 font-bold">ç³»çµ±è¼‰å…¥ä¸­...</div>
        </div>
        <div class="flex-1 max-w-md px-10">
            <input type="text" id="searchInput" placeholder="æœå°‹å¹£å (ä¾‹: BTC)..." class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-1 text-white uppercase outline-none focus:border-yellow-500">
        </div>
        <div id="apiStatus" class="bg-zinc-800 px-4 py-1 rounded text-green-400 font-bold uppercase">é›™å°åŒ…æ‰“åŒ…æ¨¡å¼å•Ÿå‹•</div>
    </header>

    <div class="bg-zinc-900/50 p-2 border-b border-yellow-900/30 grid grid-cols-5 gap-4 uppercase font-bold text-zinc-400">
        <div>ğŸŒ€ SQZ <span id="v_sqz" class="text-yellow-500">1.2%</span><input type="range" id="i_sqz" min="5" max="50" value="12" class="w-full"></div>
        <div>ğŸ¯ POC <span id="v_poc" class="text-green-400">1.1%</span><input type="range" id="i_poc" min="1" max="100" value="11" class="w-full"></div>
        <div>ğŸš¨ SLP <span id="v_slp" class="text-red-500">-15%</span><input type="range" id="i_slp" min="5" max="50" value="15" class="w-full"></div>
        <div>ğŸš€ DRV <span id="v_drv" class="text-blue-400">90</span><input type="range" id="i_drv" min="10" max="150" value="90" class="w-full"></div>
        <div>âš¡ MOM <span id="v_mom" class="text-orange-500">0.8%</span><input type="range" id="i_mom" min="1" max="50" value="8" class="w-full"></div>
    </div>

    <div class="flex flex-1 overflow-hidden gap-2 mt-2">
        <main class="flex-1 overflow-y-auto p-2 grid grid-cols-4 gap-3 content-start" id="dashboard"></main>
        <aside class="w-72 border-l border-yellow-900 bg-zinc-950 flex flex-col">
            <div class="p-2 border-b border-zinc-800 text-red-500 font-bold uppercase tracking-tighter">ğŸ›¡ï¸ å·¨é¯¨èˆ‡æ¸…ç®—å³æ™‚æµ</div>
            <div id="logBox" class="flex-1 overflow-y-auto p-2 space-y-1 text-[9px]"></div>
        </aside>
    </div>

<script>
    let stats = {}, activeWS = new Map();
    let FILTER = { SQZ: 0.012, POC: 0.011, SLP: -0.15, DRV: 90, MOM: 0.008 };
    let searchFilter = "";
    let isFetching = false;

    // [H] é€±å…­/é€±ä¸€ç­–ç•¥è‡ªå‹•åŒ–
    function applyDateStrategy() {
        const day = new Date().getDay(); // 0:é€±æ—¥, 1:é€±ä¸€, 6:é€±å…­
        const notice = document.getElementById('dateNotice');
        if (day === 6) {
            notice.innerText = "ğŸ“… é€±å…­æ¨¡å¼ï¼šå¼·åŒ– Tight åŸ‹ä¼";
            FILTER.SQZ = 0.008; document.getElementById('i_sqz').value = 8;
            document.getElementById('v_sqz').innerText = "0.8%";
        } else if (day === 1) {
            notice.innerText = "ğŸ“… é€±ä¸€æ¨¡å¼ï¼šå¼·åŒ–çœŸç©ºçªç ´";
            FILTER.POC = 0.015; document.getElementById('i_poc').value = 15;
            document.getElementById('v_poc').innerText = "1.5%";
        } else {
            notice.innerText = "ğŸ“… å¸¸è¦ç›£æ§æ¨¡å¼";
        }
    }

    // [A-1] ç¬¬ä¸€å°åŒ…ï¼šå…¨å ´åˆç¯©
    async function fetchTickerPacket() {
        if (isFetching) return;
        isFetching = true;
        try {
            const [tRes, pRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'),
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
            ]);
            if (tRes.status === 418) throw "418";

            const tickers = await tRes.json();
            const premiums = await pRes.json();
            const pMap = Object.fromEntries(premiums.map(p => [p.symbol, p.lastFundingRate]));

            tickers.forEach(t => {
                const s = t.symbol;
                if (!s.endsWith('USDT')) return;
                const p = parseFloat(t.lastPrice);
                const h = parseFloat(t.highPrice);
                const l = parseFloat(t.lowPrice);
                
                // [C] ç€è¦½å™¨å¾Œå°ç®—åˆ† (ä¸æ¶ˆè€—è«‹æ±‚)
                let score = 0;
                const sqzVal = (h - l) / p;
                if (sqzVal <= FILTER.SQZ) score += 40;
                if (Math.abs(t.priceChangePercent) > 1.5) score += 20;
                
                if (!stats[s]) stats[s] = { s, score: 0, price: p, liq: 0, wallP: 0, wallV: 0, funding: 0 };
                stats[s] = { ...stats[s], price: p, score: score, funding: pMap[s] || 0, isVacuum: (h - p)/p < 0.01 };
            });
            renderUI();
            updateStatus("Packet 1: OK", "text-green-400");
        } catch (e) { updateStatus("API Overload (418)", "text-red-500"); }
        isFetching = false;
        setTimeout(fetchTickerPacket, 3000);
    }

    // [A-2] ç¬¬äºŒå°åŒ…ï¼šå¾Œå°é¸å®Œå¾Œæ‰“åŒ…æ›´æ–° (æ·±åº¦æ•¸æ“š)
    async function fetchBatchDepth() {
        // å¾Œå°é¸å‡ºå‰ 10 å
        const topSymbols = Object.values(stats).sort((a,b) => b.score - a.score).slice(0, 10);
        
        // æ‰“åŒ…é€™ 10 å€‹å¹£ï¼Œä¾åºç²å– (é€é await ç¢ºä¿ä¸€ç§’åªæœ‰å…©å€‹)
        for (const item of topSymbols) {
            try {
                const res = await fetch(`https://fapi.binance.com/fapi/v1/depth?symbol=${item.s}&limit=5`);
                const d = await res.json();
                const topWall = [...d.asks, ...d.bids].sort((a,b) => b[1]-a[1])[0];
                stats[item.s].wallP = topWall[0];
                stats[item.s].wallV = topWall[0] * topWall[1];
                
                // é–‹å•Ÿè©²å¹£çš„ WebSocket (å¦‚æœå°šæœªé–‹å•Ÿ)
                ensureWS(item.s);
                await new Promise(r => setTimeout(r, 500)); // æ¯å€‹å¹£ä¹‹é–“å–˜æ¯ 500ms
            } catch(e){}
        }
        updateStatus("Packet 2: Batch OK", "text-blue-400");
        setTimeout(fetchBatchDepth, 6000); // æ·±åº¦æ•¸æ“šä¸éœ€å¤ªé »ç¹
    }

    function ensureWS(s) {
        if (activeWS.has(s)) return;
        const ws = new WebSocket(`wss://fstream.binance.com/ws/${s.toLowerCase()}@aggTrade/${s.toLowerCase()}@forceOrder`);
        ws.onmessage = (e) => {
            const d = JSON.parse(e.data);
            if (d.e === "forceOrder") {
                const val = parseFloat(d.o.q) * parseFloat(d.o.p);
                stats[s].liq += val;
                addLog(`ğŸ’€ [æ¸…ç®—] ${s} $${(val/1000).toFixed(1)}K`, "text-red-500 font-bold");
            }
        };
        activeWS.set(s, ws);
    }

    function renderUI() {
        const dashboard = document.getElementById('dashboard');
        let list = Object.values(stats);
        if (searchFilter) list = list.filter(x => x.s.includes(searchFilter));
        const sorted = list.sort((a,b) => b.score - a.score).slice(0, 40);
        
        dashboard.innerHTML = sorted.map(x => `
            <div class="card p-3 ${x.score >= 50 ? 'tight-zone' : ''}">
                <div class="flex justify-between items-start font-black">
                    <span class="text-base text-white">${x.s.replace('USDT','')}</span>
                    <span class="text-yellow-500">â˜… ${x.score}</span>
                </div>
                <div class="text-2xl font-black text-white mt-1 mb-2">$${x.price.toLocaleString()}</div>
                <div class="flex justify-between text-[8px] mb-2 font-bold">
                    <span class="${x.funding < 0 ? 'text-red-500' : 'text-green-500'}">è³‡è²»: ${(x.funding*100).toFixed(4)}%</span>
                    ${x.isVacuum ? '<span class="text-blue-400 italic">VACUUM</span>' : ''}
                </div>
                <div class="grid grid-cols-2 gap-1">
                    <div class="metric-box"><span class="block text-zinc-600">WALL PRICE</span><span class="text-blue-400 font-bold">$${parseFloat(x.wallP).toFixed(4)}</span></div>
                    <div class="metric-box"><span class="block text-zinc-600">WALL VALUE</span><span class="text-blue-200 font-bold">${x.wallV >= 1e6 ? (x.wallV/1e6).toFixed(1)+'M' : (x.wallV/1e3).toFixed(0)+'K'}</span></div>
                    <div class="metric-box"><span class="block text-zinc-600">LIQUIDATION</span><span class="text-red-500 font-bold">$${(x.liq/1e3).toFixed(1)}K</span></div>
                </div>
            </div>
        `).join('');
    }

    // [G] åƒæ•¸éˆ•åˆå§‹åŒ–
    function init() {
        const sliders = ['i_sqz', 'i_poc', 'i_slp', 'i_drv', 'i_mom'];
        sliders.forEach(id => {
            document.getElementById(id).oninput = (e) => {
                const key = id.split('_')[1].toUpperCase();
                const val = parseFloat(e.target.value);
                FILTER[key] = (key === 'SLP' ? -(val/100) : val / 1000);
                document.getElementById('v_'+id.split('_')[1]).innerText = (val/10).toFixed(1) + (key==='DRV'?'':'%');
                renderUI();
            };
        });
        document.getElementById('searchInput').oninput = (e) => { searchFilter = e.target.value.toUpperCase(); renderUI(); };
        applyDateStrategy();
        fetchTickerPacket();
        fetchBatchDepth();
    }

    function addLog(m, c) {
        const b = document.getElementById('logBox');
        const d = document.createElement('div');
        d.className = `p-1 border-b border-zinc-900 ${c}`;
        d.innerHTML = `[${new Date().toLocaleTimeString()}] ${m}`;
        b.prepend(d);
        if(b.childNodes.length > 30) b.removeChild(b.lastChild);
    }

    function updateStatus(m, c) { const s = document.getElementById('apiStatus'); s.innerText = m; s.className = `bg-zinc-800 px-4 py-1 rounded font-bold uppercase ${c}`; }

    init();
</script>
</body>
</html>
