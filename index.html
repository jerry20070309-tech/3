<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TRIDENT V56 PRO</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#000;color:#fff;font-family:monospace}
.card{background:#111;border:1px solid #222;padding:12px;margin-bottom:12px}
.bar{height:6px;background:#222;margin-top:6px}
.fill{height:6px;background:#00ff88}
.log{background:#111;border:1px solid #333;height:240px;overflow:auto;padding:10px}
.small{font-size:12px;color:#aaa}
input{background:#111;border:1px solid #333;padding:4px;color:#fff;width:100%}
</style>
</head>
<body class="p-6">

<h1 class="text-xl mb-4">TRIDENT V56 – PRO RISK ENGINE</h1>

<div class="flex gap-4 mb-4">

<div>
<div class="small">帳戶資金</div>
<input type="number" id="accountInput" value="10000">
</div>

<div>
<div class="small">風險 %</div>
<input type="number" id="riskInput" value="1" step="0.1">
</div>

<div>
<div class="small">槓桿</div>
<input type="number" id="leverageInput" value="5">
</div>

<button onclick="ignite()" class="bg-green-600 px-4 py-2 mt-5">
啟動
</button>

</div>

<div class="bar mb-4">
<div id="progressFill" class="fill" style="width:0%"></div>
</div>

<div class="flex gap-6">
<div class="flex-1" id="list"></div>
<div class="w-80">
<div class="log" id="log"></div>
</div>
</div>

<script>

const REFRESH_INTERVAL=30000
const DISPLAY_LIMIT=8

let universe=[]
let active=[]
let market={}
let alerted=new Set()
let elapsed=0

// ===== 啟動 =====

async function ignite(){
await loadUniverse()
await initActive()
startWS()
startTimer()
}

// ===== 幣池 =====

async function loadUniverse(){
const tickers=await fetch("https://fapi.binance.com/fapi/v1/ticker/24hr")
.then(r=>r.json())

universe=tickers
.filter(t=>t.symbol.endsWith("USDT"))
.sort((a,b)=>b.quoteVolume-a.quoteVolume)
.slice(30,200)
.map(t=>t.symbol)
}

async function initActive(){
active=universe.slice(0,100)
for(const s of active){
await loadSymbol(s)
}
render()
}

// ===== 讀數據 =====

async function loadSymbol(s){

const k=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=50`)
.then(r=>r.json())

const closes=k.map(x=>parseFloat(x[4]))
const lows=k.map(x=>parseFloat(x[3]))
const price=closes.at(-1)

market[s]={
price,
high:Math.max(...closes),
structureLow:Math.min(...lows.slice(-10)),
score:80
}
}

// ===== 計算交易 =====

function computeTrade(d){

const account=parseFloat(accountInput.value)
const riskPercent=parseFloat(riskInput.value)
const leverage=parseFloat(leverageInput.value)

const entry=d.price
const stop=d.structureLow
const risk=entry-stop
if(risk<=0) return null

const tp=entry+risk*2
const rr=2

const riskCapital=account*(riskPercent/100)
const rawPosition=riskCapital/risk
const positionSize=rawPosition*leverage
const marginUsed=(positionSize*entry)/leverage

// ===== 動態移動止損 =====

let trailingStop=stop

if(d.price>=entry+risk){
trailingStop=entry
}
if(d.price>=entry+risk*2){
trailingStop=entry+risk
}

return {
entry,stop,trailingStop,tp,
rr,positionSize,marginUsed
}
}

// ===== WebSocket =====

function startWS(){
const ws=new WebSocket("wss://fstream.binance.com/ws/!ticker@arr")

ws.onmessage=e=>{
const arr=JSON.parse(e.data)
arr.forEach(t=>{
if(market[t.s]){
market[t.s].price=parseFloat(t.c)
}
})
}
}

// ===== 固定進度條 =====

function startTimer(){

setInterval(()=>{

elapsed+=100

if(elapsed>=REFRESH_INTERVAL){
elapsed=0
}

progressFill.style.width=
(elapsed/REFRESH_INTERVAL*100)+"%"

render()

},100)

}

// ===== UI =====

function render(){

list.innerHTML=""

active.slice(0,DISPLAY_LIMIT).forEach(s=>{

const d=market[s]
if(!d) return

const trade=computeTrade(d)
if(!trade) return

const card=document.createElement("div")
card.className="card"

card.innerHTML=`
<div>${s}</div>
<div class="small">
Entry: ${trade.entry.toFixed(4)}<br>
Stop: ${trade.stop.toFixed(4)}<br>
Trailing SL: ${trade.trailingStop.toFixed(4)}<br>
TP: ${trade.tp.toFixed(4)}<br>
槓桿後倉位: ${trade.positionSize.toFixed(2)}<br>
保證金: ${trade.marginUsed.toFixed(2)}
</div>
`

list.appendChild(card)

})

}

</script>
</body>
</html>
