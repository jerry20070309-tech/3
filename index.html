<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>CITY LONG FULL</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#050505;color:#d4d4d8;font-family:monospace}
.card{background:#0f0f11;border:1px solid #1f1f23}
.progress{height:4px;background:#22c55e;transition:width 1s linear}
</style>
</head>
<body class="p-6">

<div class="flex justify-between items-center mb-4">
<div>
<h1 class="text-2xl font-bold text-white">CITY LONG FULL</h1>
<div class="text-xs text-zinc-400">Structure SL + Risk Based Size</div>
</div>

<div class="flex gap-3">
<input id="marginInput" type="number" placeholder="保證金"
class="bg-black border border-zinc-700 px-3 py-1 text-sm w-24">

<input id="lossInput" type="number" placeholder="本單願虧U"
class="bg-black border border-zinc-700 px-3 py-1 text-sm w-28">

<button onclick="ignite()"
class="bg-blue-700 hover:bg-blue-600 px-5 py-2 text-xs font-bold">
啟動
</button>
</div>
</div>

<div class="w-full bg-zinc-800 mb-6">
<div id="timerBar" class="progress w-0"></div>
</div>

<div id="list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

<script>

const BLACKLIST=[
'BTCUSDT','ETHUSDT','BNBUSDT','XRPUSDT','SOLUSDT','ADAUSDT',
'DOGEUSDT','TRXUSDT','AVAXUSDT','DOTUSDT','LINKUSDT','MATICUSDT',
'LTCUSDT','BCHUSDT','XLMUSDT','ATOMUSDT','ETCUSDT','APTUSDT',
'FILUSDT','ICPUSDT','ARBUSDT','OPUSDT','NEARUSDT','HBARUSDT',
'VETUSDT','INJUSDT','IMXUSDT','GRTUSDT','AAVEUSDT','RNDRUSDT',
'SUIUSDT','FTMUSDT','THETAUSDT','EGLDUSDT','KASUSDT'
];

let started=false;
let alerted=new Set();
let marketData={};

function ignite(){
if(started) return;
started=true;
scan(true);
setInterval(()=>scan(false),30000);
startTimer();
}

async function scan(first){

const limit=first?400:100;

const tickers=await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr')
.then(r=>r.json());

const symbols=tickers
.filter(t=>t.symbol.endsWith('USDT') && !BLACKLIST.includes(t.symbol))
.sort((a,b)=>b.quoteVolume-a.quoteVolume)
.slice(0,limit)
.map(t=>t.symbol);

marketData={};

for(let s of symbols){
await calculateSymbol(s);
}

render();
}

async function calculateSymbol(s){

try{

const k=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=120`)
.then(r=>r.json());

const closes=k.map(x=>parseFloat(x[4]));
const highs=k.map(x=>parseFloat(x[2]));
const lows=k.map(x=>parseFloat(x[3]));

const price=closes.at(-1);

const ma25=avg(closes.slice(-25));
const ma99=avg(closes.slice(-99));
const slope=ma25-avg(closes.slice(-26,-1));

const atr=avg(highs.map((h,i)=>h-lows[i]).slice(-14));
const atrLong=avg(highs.map((h,i)=>h-lows[i]).slice(-50));
const storm=atr/atrLong;

const poc=calculatePOC(k);

const oi15=await getOI(s,'15m');
const oi1h=await getOI(s,'1h');

const funding=await fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${s}`)
.then(r=>r.json()).then(d=>parseFloat(d.lastFundingRate));

/* ===== 結構止損 ===== */
const stop=Math.min(...lows.slice(-10));
const risk=price-stop;
if(risk<=0) return;

const riskPercent=risk/price;

/* ===== 止損品質篩選 ===== */
if(riskPercent>0.03) return;   // 超過3%淘汰

/* ===== 評分系統 ===== */

let score=0;
let tags=[];

if(ma25>ma99){score+=20;tags.push('多排')}
if(price>ma25){score+=15;tags.push('站25')}
if(price>poc){score+=15;tags.push('站POC')}
if(oi15>0 && oi1h>0){score+=15;tags.push('OI+')}
if(storm>1.3){score+=15;tags.push('風暴')}
if(slope>0){score+=10;tags.push('斜率+')}
if(funding<0.02){score+=10;tags.push('F正常')}

/* 止損漂亮加分 */
if(riskPercent<0.015){score+=10;tags.push('止損優')}

if(score>=80){
marketData[s]={
price,stop,atr,score,tags,risk
};
}

}catch(e){}
}

function render(){

const container=document.getElementById('list');
container.innerHTML='';

const margin=parseFloat(document.getElementById('marginInput').value)||0;
const maxLoss=parseFloat(document.getElementById('lossInput').value)||0;

Object.entries(marketData)
.sort((a,b)=>b[1].score-a[1].score)
.forEach(([s,v])=>{

if(maxLoss<=0 || margin<=0) return;

const qty=maxLoss/v.risk;
const positionValue=qty*v.price;
const leverage=positionValue/margin;

const tp=v.price+v.atr*2.5;
const profit=(tp-v.price)*qty;
const roi=profit/margin*100;

if(v.score>=90 && !alerted.has(s)){
alert(s+' 強信號');
alerted.add(s);
}

container.innerHTML+=`
<div class="card p-4 rounded">
<div class="text-white font-bold">${s}</div>
<div class="text-sm text-green-400">Score ${v.score}</div>
<div class="text-xs text-zinc-400">${v.tags.join(' | ')}</div>
<div class="mt-2 text-xs">
Entry: ${v.price.toFixed(4)}<br>
SL: ${v.stop.toFixed(4)}<br>
TP: ${tp.toFixed(4)}<br>
槓桿: ${leverage.toFixed(2)}x<br>
倉位: ${qty.toFixed(2)}<br>
預期收益率: ${roi.toFixed(2)}%
</div>
</div>
`;
});
}

function calculatePOC(k){
let bins={};
k.forEach(c=>{
let p=parseFloat(c[4]);
let v=parseFloat(c[5]);
bins[p]=(bins[p]||0)+v;
});
return parseFloat(Object.entries(bins).sort((a,b)=>b[1]-a[1])[0][0]);
}

async function getOI(s,period){
try{
const r=await fetch(
`https://fapi.binance.com/futures/data/openInterestHist?symbol=${s}&period=${period}&limit=2`)
.then(r=>r.json());
if(r.length>1){
return r[1].sumOpenInterest-r[0].sumOpenInterest;
}
}catch(e){}
return 0;
}

function avg(arr){
return arr.reduce((a,b)=>a+b,0)/arr.length;
}

function startTimer(){
let t=0;
setInterval(()=>{
t=(t+1)%30;
document.getElementById('timerBar').style.width=(t/30*100)+'%';
},1000);
}

</script>
</body>
</html>
