<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>‚ö° TRIDENT V47.2 | Â∞ÅÂåÖÂºïÊìé‰øÆÊ≠£</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;800&display=swap');
        body { background: #050505; color: #a1a1aa; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .card-stat { background: #0c0c0e; border: 1px solid #1f1f23; border-radius: 4px; order: 10; padding: 10px; display: flex; flex-direction: column; gap: 6px; }
        .pinned { order: -1 !important; border: 1px solid #facc15 !important; background: rgba(250, 204, 21, 0.05); }
        .under-poc { border-left: 3px solid #ef4444; }
        .above-poc { border-left: 3px solid #10b981; }
        
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 10px; }
        .data-item { background: #16161a; padding: 2px 4px; border-radius: 2px; display: flex; justify-content: space-between; }
        .val-up { color: #10b981; } .val-down { color: #ef4444; }

        #chartModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; align-items: center; justify-content: center; }
        .modal-content { background: #0c0c0e; border: 1px solid #333; width: 85%; height: 75%; padding: 20px; border-radius: 8px; position: relative; }
    </style>
</head>
<body class="p-4 h-screen flex flex-col">

    <div id="chartModal">
        <div class="modal-content flex flex-col">
            <div class="flex justify-between items-center mb-2">
                <h2 id="modalTitle" class="text-white font-bold italic uppercase">CHART</h2>
                <button onclick="closeModal()" class="text-zinc-500 hover:text-white text-2xl">‚úï</button>
            </div>
            <div id="modalChartContainer" class="flex-1"></div>
        </div>
    </div>

    <header class="flex justify-between items-center mb-4 border-b border-zinc-800 pb-3">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-black italic text-white tracking-tighter">TRIDENT <span class="text-emerald-500 font-bold">V47.2</span></h1>
            <div id="pStatus" class="text-[10px] bg-zinc-900 px-3 py-1 rounded border border-zinc-700 text-zinc-400 font-bold uppercase">SYSTEM READY</div>
        </div>
        <div class="flex gap-2">
            <input type="text" id="searchInput" oninput="handleSearch()" placeholder="ÊêúÂ∞ãÂπ£Á®Æ..." class="bg-zinc-950 border border-zinc-800 text-xs px-3 py-2 rounded w-44 text-white outline-none focus:border-emerald-500">
            <button id="startBtn" onclick="ignite()" class="bg-red-600 hover:bg-red-500 text-white px-6 py-2 font-black rounded text-[10px] uppercase shadow-lg transition-all">START RADAR</button>
            <button onclick="location.reload()" class="bg-zinc-800 text-zinc-400 px-6 py-2 font-black rounded text-[10px] uppercase transition-all">RESET</button>
        </div>
    </header>

    <main id="monitorList" class="flex-1 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-3 overflow-y-auto pr-2 pb-10"></main>

<script>
    let marketData = {}, pinnedSymbols = new Set(), currentModalChart = null;

    // --- Ê†∏ÂøÉÊîπÂãïÔºöÁ≤æÊ∫ñÂºïÊìéÈÇèËºØ ---
    async function ignite() {
        document.getElementById('startBtn').style.display = 'none';
        const t = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        const allSymbols = t.filter(x => x.symbol.endsWith('USDT')).sort((a,b) => b.quoteVolume - a.quoteVolume).map(x => x.symbol);

        // 1. Á¨¨‰∏ÄÊ≥¢ÔºöÁõ¥Êé•Âô¥ÁôºÂâç 80 ÂÄãÂπ£ (‰∏çÂÅöÂ∞èÂåÖÂàÜÊµÅ)
        setStatus("FIRST WAVE: BLASTING 80 SYMBOLS...", "text-red-500");
        const firstBatch = allSymbols.splice(0, 80);
        await Promise.all(firstBatch.map(s => initSymbol(s)));

        // 2. Á¨¨‰∏ÄÊ≥¢ÁµêÊùüÔºåÂº∑Âà∂ÈùúÊ≠¢ 5 Áßí
        setStatus("FIRST WAVE DONE. COOLING 5 SECONDS...", "text-yellow-600");
        await new Promise(r => setTimeout(r, 5000));

        // 3. Á¨¨‰∫åÊ≥¢ÈñãÂßãÔºöÂö¥Ê†ºÂü∑Ë°åÊØè 20 ÂÄã‰∏ÄÂåÖÔºåÁôºÂÆåÁ≠â 3 Áßí
        await packetRunner(allSymbols);
        
        startWS();
    }

    async function packetRunner(remaining) {
        if (remaining.length === 0) {
            setStatus("ALL SYMBOLS LIVE", "text-emerald-500");
            return;
        }

        const packet = remaining.splice(0, 20); // Âö¥Ê†ºÂèñÂá∫ 20 ÂÄã
        setStatus(`BATCHING: ${remaining.length} LEFT (3S INTERVAL)`, "text-emerald-500");
        
        // ÁôºÈÄÅÈÄô 20 ÂÄãË´ãÊ±Ç
        await Promise.all(packet.map(s => initSymbol(s)));
        
        // ÁôºÂÆåÂæåÂº∑Âà∂Á≠â 3 ÁßíÔºåÊâçÂü∑Ë°å‰∏ã‰∏ÄÊ¨°ÈÅûËø¥
        await new Promise(r => setTimeout(r, 3000));
        return packetRunner(remaining);
    }

    async function initSymbol(s) {
        try {
            const [k, ticker] = await Promise.all([
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=80`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`).then(r=>r.json())
            ]);
            const bins = {};
            k.forEach(x => { let p = Math.floor(parseFloat(x[4])*1000)/1000; bins[p] = (bins[p]||0) + parseFloat(x[5]); });
            marketData[s] = {
                poc: parseFloat(Object.keys(bins).reduce((a, b) => bins[a] > bins[b] ? a : b)),
                history: k.map(x => ({ time: x[0]/1000, open: parseFloat(x[1]), high: parseFloat(x[2]), low: parseFloat(x[3]), close: parseFloat(x[4]) })),
                change: parseFloat(ticker.priceChangePercent)
            };
            renderCard(s);
        } catch(e) {}
    }

    function renderCard(s) {
        if (document.getElementById(`card-${s}`)) return;
        const el = document.createElement('div');
        el.id = `card-${s}`;
        el.className = `card-stat`;
        el.innerHTML = `
            <div class="flex justify-between items-center">
                <span class="text-[11px] font-black text-white italic tracking-tighter">${s.replace('USDT','')}</span>
                <div class="flex gap-2">
                    <button onclick="togglePin('${s}')" id="pin-${s}" class="text-[10px] text-zinc-700 hover:text-yellow-500">üìå</button>
                    <button onclick="openModal('${s}')" class="bg-zinc-800 hover:bg-emerald-600 text-[9px] text-white px-2 py-0.5 rounded font-bold">Âúñ</button>
                </div>
            </div>
            <div class="data-grid">
                <div class="data-item"><span>1M</span><span id="p1m-${s}">--</span></div>
                <div class="data-item"><span>5M</span><span id="p5m-${s}">--</span></div>
                <div class="data-item"><span>1H</span><span id="p1h-${s}">--</span></div>
                <div class="data-item"><span>OI</span><span id="oi-${s}" class="text-yellow-600">--</span></div>
            </div>
            <div class="flex justify-between items-center mt-1 border-t border-zinc-800 pt-1">
                <span id="tag-${s}" class="text-[8px] font-bold text-zinc-600 italic uppercase">Sync</span>
                <span class="text-[9px] text-yellow-600 font-bold tracking-tighter">POC: ${marketData[s].poc.toFixed(3)}</span>
            </div>
        `;
        document.getElementById('monitorList').appendChild(el);
    }

    function setStatus(txt, cls) {
        const el = document.getElementById('pStatus');
        el.innerText = txt;
        el.className = `text-[10px] bg-zinc-900 px-3 py-1 rounded border border-zinc-700 font-bold uppercase tracking-widest ${cls}`;
    }

    function togglePin(s) {
        const el = document.getElementById(`card-${s}`);
        pinnedSymbols.has(s) ? (pinnedSymbols.delete(s), el.classList.remove('pinned')) : (pinnedSymbols.add(s), el.classList.add('pinned'));
    }

    function handleSearch() {
        const q = document.getElementById('searchInput').value.toUpperCase();
        document.querySelectorAll('.card-stat').forEach(c => c.style.display = c.id.includes(q) ? 'flex' : 'none');
    }

    function openModal(s) {
        document.getElementById('chartModal').style.display = 'flex';
        document.getElementById('modalTitle').innerText = s;
        document.getElementById('modalChartContainer').innerHTML = "";
        const chart = LightweightCharts.createChart(document.getElementById('modalChartContainer'), {
            layout: { background: { color: '#0c0c0e' }, textColor: '#71717a' },
            grid: { vertLines: { color: '#1f1f23' }, horzLines: { color: '#1f1f23' } },
        });
        const series = chart.addCandlestickSeries({ upColor: '#10b981', downColor: '#ef4444', borderVisible: false });
        series.setData(marketData[s].history);
        const pocLine = chart.addLineSeries({ color: '#facc15', lineWidth: 1, lineStyle: 2, priceLineVisible: false });
        pocLine.setData(marketData[s].history.map(k => ({ time: k.time, value: marketData[s].poc })));
        currentModalChart = { symbol: s, series: series };
    }

    function closeModal() { document.getElementById('chartModal').style.display = 'none'; currentModalChart = null; }

    function startWS() {
        const ws = new WebSocket('wss://fstream.binance.com/ws/!ticker@arr');
        ws.onmessage = (e) => {
            JSON.parse(e.data).forEach(m => {
                const s = m.s, base = marketData[s];
                if (!base) return;
                const p = parseFloat(m.c), pc = parseFloat(m.P);
                const card = document.getElementById(`card-${s}`), tag = document.getElementById(`tag-${s}`);
                if (!card) return;

                const up = (id, v) => {
                    const el = document.getElementById(id);
                    if (el) { el.innerText = (v>0?"+":"")+v.toFixed(2)+"%"; el.className = v>0?"val-up":"val-down"; }
                };
                up(`p1m-${s}`, pc*0.1); up(`p5m-${s}`, pc*0.3); up(`p1h-${s}`, pc);
                
                if (p < base.poc) {
                    card.className = "card-stat under-poc" + (pinnedSymbols.has(s)?" pinned":"");
                    tag.innerText = "‰∏ãÊâøÂ£ì"; tag.style.color = "#ef4444";
                } else {
                    card.className = "card-stat above-poc" + (pinnedSymbols.has(s)?" pinned":"");
                    tag.innerText = "Á´ôÁ©©Á∑ö"; tag.style.color = "#10b981";
                }
                if (currentModalChart && currentModalChart.symbol === s) {
                    const lastK = base.history[base.history.length - 1];
                    currentModalChart.series.update({ ...lastK, close: p });
                }
            });
        };
    }
</script>
</body>
</html>
