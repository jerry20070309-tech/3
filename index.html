<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>TRIDENT POC PRO A</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#050505;color:#d4d4d8;font-family:monospace}
.card{background:#0f0f11;border:1px solid #1f1f23}
.low{border:2px solid #22c55e}
.mid{border:2px solid #f59e0b}
.pre{border:2px solid #3b82f6}
.bar{height:3px;background:#3b82f6;width:0%}
</style>
</head>
<body class="p-4">

<div class="flex justify-between mb-4">
<div class="flex gap-3">
<button id="toggleBtn" onclick="toggleRun()" class="bg-blue-600 px-4 py-2 rounded">啟動</button>
<input id="searchInput" placeholder="搜尋幣..." class="bg-black border px-2 py-1"/>
</div>
<div class="w-64 bg-zinc-800 rounded">
<div id="progressBar" class="bar"></div>
</div>
</div>

<div class="flex gap-4">
<div id="list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 flex-1"></div>
<div class="w-72 bg-black border p-3">
<h3 class="text-green-400 mb-2">低風險紀錄</h3>
<div id="log"></div>
</div>
</div>

<script>
const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','BNBUSDT','XRPUSDT','ADAUSDT'];

let symbols=[];
let dataMap={};
let running=false;
let ws=null;
let firstLoad=true;
let pinned=new Set();

async function toggleRun(){
running=!running;
document.getElementById('toggleBtn').innerText=running?'停止':'啟動';
if(running){
await init();
startTimer();
}else{
if(ws)ws.close();
}
}

async function init(){
const res=await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
const tickers=await res.json();
symbols=tickers
.filter(t=>t.symbol.endsWith('USDT')&&!EXCLUDE.includes(t.symbol))
.sort((a,b)=>b.quoteVolume-a.quoteVolume)
.slice(0,400)
.map(t=>t.symbol);

await loadBatch(symbols);
startWS();
firstLoad=false;
}

async function loadBatch(batch){
for(let s of batch){
await loadSymbol(s);
}
}

async function loadSymbol(s){
try{
const k4=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=4h&limit=100`).then(r=>r.json());
const k15=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=100`).then(r=>r.json());

const poc4=calcPOC(k4);
const poc15=calcPOC(k15);

const ma7=ma(k15,7);
const ma25=ma(k15,25);
const ma99=ma(k15,99);

dataMap[s]={poc4,poc15,ma7,ma25,ma99};
}catch{}
}

function calcPOC(k){
let bins={};
k.forEach(c=>{
let p=parseFloat(c[4]);
let v=parseFloat(c[5]);
let b=Math.round(p*100)/100;
bins[b]=(bins[b]||0)+v;
});
let max=0,price=0;
for(let b in bins){
if(bins[b]>max){max=bins[b];price=parseFloat(b);}
}
return price;
}

function ma(k,n){
let closes=k.map(x=>parseFloat(x[4]));
let slice=closes.slice(-n);
return slice.reduce((a,b)=>a+b,0)/n;
}

function startWS(){
ws=new WebSocket('wss://fstream.binance.com/ws/!ticker@arr');
ws.onmessage=e=>{
let arr=JSON.parse(e.data);
arr.forEach(m=>{
if(!symbols.includes(m.s))return;
checkSignal(m.s,parseFloat(m.c));
});
};
}

function checkSignal(s,price){
let d=dataMap[s];
if(!d)return;

if(price>d.poc4){
let type='pre';
if(Math.abs(price-d.poc4)/d.poc4<0.002) type='mid';
if(Math.abs(price-d.poc4)/d.poc4<0.001 && Math.abs(price-d.ma99)/d.ma99<0.002) type='low';
renderCard(s,price,type);
if(type==='low') logLow(s,price);
}
}

function renderCard(s,price,type){
let el=document.getElementById(s);
if(!el){
el=document.createElement('div');
el.id=s;
document.getElementById('list').prepend(el);
}
el.className=`card p-3 rounded ${type}`;
el.innerHTML=`
<div class="flex justify-between">
<b>${s.replace('USDT','')}</b>
<button onclick="pin('${s}')">★</button>
</div>
<div>價格: ${price}</div>
<div>4H POC: ${dataMap[s].poc4}</div>
<div>MA99: ${dataMap[s].ma99.toFixed(4)}</div>
`;
}

function logLow(s,p){
let log=document.getElementById('log');
let div=document.createElement('div');
div.innerText=`${s} 低風險 @ ${p}`;
log.prepend(div);
}

function pin(s){
if(pinned.has(s)) pinned.delete(s);
else pinned.add(s);
}

function startTimer(){
let sec=30;
setInterval(async()=>{
if(!running)return;
sec--;
document.getElementById('progressBar').style.width=(sec/30*100)+'%';
if(sec<=0){
sec=30;
let top100=symbols.slice(0,100);
await loadBatch(top100);
}
},1000);
}
</script>
</body>
</html>
