<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>⚡ TRIDENT V44 PRO</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#050505;color:#d4d4d8;font-family:monospace}
.card{background:#111;border:1px solid #222;border-radius:8px;padding:12px}
.long{border:2px solid #16a34a;background:#06210f}
</style>
</head>
<body class="p-6">

<h1 class="text-2xl font-bold text-white mb-4">
TRIDENT V44 – PRO LONG SCANNER
</h1>

<button onclick="ignite()" class="bg-green-600 px-4 py-2 rounded text-white font-bold">
啟動掃描
</button>

<div id="list" class="grid grid-cols-4 gap-4 mt-6"></div>

<script>

const EXCLUDE=['BTCUSDT','ETHUSDT','BNBUSDT','SOLUSDT'];
let marketData={}
let btcReturn=0
let running=false

async function ignite(){
if(running)return
running=true
await loadBTC()
await refreshUniverse()
startWS()
}

async function loadBTC(){
const k=await fetch('https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=1m&limit=2').then(r=>r.json())
btcReturn=(k[1][4]-k[0][1])/k[0][1]
}

async function refreshUniverse(){
const tickers=await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json())
const top=tickers
.filter(t=>t.symbol.endsWith('USDT')&&!EXCLUDE.includes(t.symbol))
.sort((a,b)=>b.quoteVolume-a.quoteVolume)
.slice(0,40)

for(let t of top){
await initSymbol(t.symbol)
await new Promise(r=>setTimeout(r,80))
}
}

async function initSymbol(s){
const k=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=100`).then(r=>r.json())
const oi15=await getOI(s,'15m')
const oi1h=await getOI(s,'1h')
const funding=await getFunding(s)

marketData[s]={
klines:k,
poc:calcPOC(k),
vwap:calcVWAP(k),
emaSlope:calcSlope(k),
oi15,
oi1h,
funding,
avgVol:k.reduce((a,b)=>a+parseFloat(b[5]),0)/k.length,
lastPrice:parseFloat(k[k.length-1][4])
}
}

function calcVWAP(k){
let pv=0,v=0
k.forEach(c=>{
pv+=parseFloat(c[4])*parseFloat(c[5])
v+=parseFloat(c[5])
})
return pv/v
}

function calcPOC(k){
let bins={}
let prices=k.map(c=>parseFloat(c[4]))
let min=Math.min(...prices)
let max=Math.max(...prices)
let step=(max-min)/20||0.00001
k.forEach(c=>{
let p=parseFloat(c[4])
let vol=parseFloat(c[5])
let bin=Math.floor((p-min)/step)*step+min
bins[bin]=(bins[bin]||0)+vol
})
return parseFloat(Object.keys(bins).reduce((a,b)=>bins[a]>bins[b]?a:b))
}

function calcSlope(k){
let closes=k.map(c=>parseFloat(c[4]))
let ema=[]
let multiplier=2/(20+1)
closes.forEach((c,i)=>{
if(i==0) ema.push(c)
else ema.push((c-ema[i-1])*multiplier+ema[i-1])
})
return ema[ema.length-1]-ema[ema.length-5]
}

async function getOI(s,p){
const d=await fetch(`https://fapi.binance.com/futures/data/openInterestHist?symbol=${s}&period=${p}&limit=2`).then(r=>r.json())
if(!d||d.length<2)return 0
return ((d[1].sumOpenInterest-d[0].sumOpenInterest)/d[0].sumOpenInterest)*100
}

async function getFunding(s){
const d=await fetch(`https://fapi.binance.com/fapi/v1/fundingRate?symbol=${s}&limit=1`).then(r=>r.json())
return d.length?parseFloat(d[0].fundingRate):0
}

function startWS(){
const ws=new WebSocket('wss://fstream.binance.com/ws/!ticker@arr')
ws.onmessage=e=>{
let signals=[]
JSON.parse(e.data).forEach(m=>{
let base=marketData[m.s]
if(!base)return

let price=parseFloat(m.c)
let volRatio=(parseFloat(m.q)/1440*15)/base.avgVol
let rel=((price-base.lastPrice)/base.lastPrice)-btcReturn

let nearPOC=Math.abs(price-base.poc)/base.poc<0.002
let breakout=price>Math.max(...base.klines.slice(-20).map(c=>parseFloat(c[2])))

let fundingOK=Math.abs(base.funding)<0.01

let pullbackSignal=
price>base.poc&&
price>base.vwap&&
base.oi15>0&&
base.oi1h>0&&
base.emaSlope>0&&
fundingOK&&
nearPOC&&
rel>0

let breakoutSignal=
breakout&&
volRatio>2&&
base.oi15>0&&
base.emaSlope>0&&
rel>0&&
fundingOK

if(pullbackSignal||breakoutSignal){
let score=base.oi15+base.oi1h+(base.emaSlope*100)+volRatio*10
signals.push({symbol:m.s,price,score,type:pullbackSignal?'PULLBACK':'BREAKOUT',base})
}
})

signals.sort((a,b)=>b.score-a.score)
renderSignals(signals.slice(0,8))
}
}

function renderSignals(list){
document.getElementById('list').innerHTML=''
list.forEach(item=>{
let s=item.symbol
let price=item.price
let base=item.base
let sl=base.poc*0.996
let tp=price+(price-sl)*2.5

let div=document.createElement('div')
div.className='card long'
div.innerHTML=`
<div class="font-bold text-white">${s}</div>
<div>Mode: ${item.type}</div>
<div>Price: ${price.toFixed(4)}</div>
<div>Score: ${item.score.toFixed(2)}</div>
<div class="text-green-400">SL: ${sl.toFixed(4)}</div>
<div class="text-green-400">TP: ${tp.toFixed(4)}</div>
`
document.getElementById('list').appendChild(div)
})
}

</script>
</body>
</html>
