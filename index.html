import streamlit as st
import pandas as pd
import time
from datetime import datetime
from binance.client import Client

# --- 1. ä»‹é¢è¦–è¦ºå„ªåŒ– (Sniper å°ˆæ¥­é¢¨æ ¼) ---
st.set_page_config(page_title="SNIPER WHALE V1.1", layout="wide")
st.markdown("""
    <style>
    .main { background-color: #050505; color: #FFD700; }
    .stMetric { background-color: #0a0a0a; border: 1px solid #FFD700; padding: 15px; border-radius: 10px; }
    </style>
    """, unsafe_allow_html=True)

# --- 2. å´é‚Šæ¬„æ§åˆ¶èˆ‡æœå°‹åŠŸèƒ½ ---
with st.sidebar:
    st.title("âš¡ SNIPER SYSTEM")
    # P1 åŠŸèƒ½ï¼šæœå°‹æ¬„ä½ï¼Œæ›´æ”¹å¾Œç«‹å³åˆ‡æ›ç›£æ§ç›®æ¨™
    symbol = st.text_input("ğŸ” æœå°‹ç›£æ§å¹£å°", value="BTCUSDT").upper()
    whale_threshold = st.number_input("ğŸ’° å·¨é¯¨é–€æª» (USDT)", value=50000)
    
    st.divider()
    api_key = st.text_input("ğŸ”‘ API Key", type="password")
    api_secret = st.text_input("ğŸ”‘ API Secret", type="password")
    run_radar = st.toggle("ğŸ›°ï¸ å•Ÿå‹•é›·é”ç›£æ§")

# --- 3. æ ¸å¿ƒæ•¸æ“šå¼•æ“ (æ¯ 3 ç§’ 3 å°åŒ…åŒæ­¥) ---
def get_whale_packets(client, target):
    try:
        # åŒæ­¥è«‹æ±‚ä¸‰å€‹å°åŒ…ï¼šP2(æˆäº¤)ã€B2(æŒå€‰)ã€P3(çˆ†å€‰)
        trades = client.futures_recent_trades(symbol=target, limit=20)
        oi_data = client.futures_open_interest(symbol=target)
        liqs = client.futures_get_all_liquidation_orders(symbol=target, limit=1)
        return trades, oi_data, liqs
    except Exception as e:
        return None, None, None

# --- 4. ä¸»å¾ªç’°é‹ç®— ---
if run_radar and api_key and api_secret:
    client = Client(api_key, api_secret)
    ui_container = st.empty()
    
    # åˆå§‹åŒ– OI ç·©å­˜ï¼Œç”¨æ–¼è¨ˆç®—è®ŠåŒ– (B2)
    if 'prev_oi' not in st.session_state:
        st.session_state.prev_oi = 0.0

    while True:
        cycle_start = time.perf_counter()
        
        # åŸ·è¡Œæ•¸æ“šæŠ“å–
        trades, oi, liqs = get_whale_packets(client, symbol)

        if trades and oi:
            # æ•¸æ“šè§£æ
            price = float(trades[-1]['price'])
            curr_oi = float(oi['openInterest'])
            # è¨ˆç®—æŒå€‰è®ŠåŒ– (åˆ¤æ–·èŠå®¶å‹•å‘)
            oi_change = curr_oi - st.session_state.prev_oi if st.session_state.prev_oi > 0 else 0
            
            # ã€é€±å…­é‚è¼¯åˆ¤å®šã€‘
            is_saturday = datetime.utcnow().weekday() == 5
            
            with ui_container.container():
                st.header(f"ğŸ¯ {symbol} å³æ™‚æˆ°æƒ…å®¤ " + ("ğŸŸ¢ (é€±å…­æ¨¡å¼)" if is_saturday else ""))
                
                # æŒ‡æ¨™å€åŸŸ
                c1, c2, c3 = st.columns(3)
                c1.metric("ç•¶å‰å¸‚åƒ¹", f"${price:,.2f}")
                c2.metric("æŒå€‰é‡ (B2)", f"{curr_oi:,.2f}", f"{oi_change:,.2f}")
                
                # æœ€æ–°ä¸€ç­†å¤§å–®åƒ¹å€¼ (P2)
                last_vol = price * float(trades[-1]['qty'])
                c3.metric("æœ€æ–°æˆäº¤é¡ (P2)", f"${last_vol:,.0f}")

                # ğŸ•µï¸ å·¨é¯¨åˆ¤å®šé‚è¼¯
                st.divider()
                if last_vol >= whale_threshold:
                    # é‚è¼¯ï¼šå¤§é¡è³£å–® + æŒå€‰æ¸›å°‘ = å·¨é¯¨æ’¤é€€/å‡ºè²¨
                    is_sell_order = trades[-1]['isBuyerMaker']
                    if is_sell_order and oi_change < 0:
                        st.error(f"ğŸš¨ è­¦å‘Šï¼šåµæ¸¬åˆ°å·¨é¯¨å‡ºè²¨ï¼é‡‘é¡: ${last_vol:,.0f}")
                    elif not is_sell_order and oi_change > 0:
                        st.success(f"ğŸ’ é©šå–œï¼šåµæ¸¬åˆ°å·¨é¯¨é€²è²¨ï¼é‡‘é¡: ${last_vol:,.0f}")
                
                # çˆ†å€‰é¡¯ç¤º (P3)
                if liqs:
                    st.warning(f"ğŸ”¥ P3 åµæ¸¬ï¼šå¸‚å ´å‡ºç¾çˆ†å€‰ï¼Œåƒ¹æ ¼ {liqs[0]['price']}")

            st.session_state.prev_oi = curr_oi

        # ç²¾ç¢ºæ§åˆ¶ 3 ç§’å¾ªç’°
        sleep_time = max(0, 3.0 - (time.perf_counter() - cycle_start))
        time.sleep(sleep_time)
else:
    st.info("ğŸ’¡ è«‹é…ç½®å·¦å´ API Key ä¸¦é–‹å•Ÿé–‹é—œã€‚éƒ¨ç½²è‡³ Streamlit Cloud å¯è§£æ±º GitHub æ’éšŠå ±éŒ¯å•é¡Œã€‚")
