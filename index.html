<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>POC 4H Scanner PRO</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#050505;color:#e5e7eb;font-family:monospace}
.card{background:#111;border:1px solid #222}
.low{border:2px solid #22c55e}
.mid{border:2px solid #eab308}
.pre{border:2px solid #3b82f6}
.bar{height:4px;background:#22c55e;width:0%}
</style>
</head>
<body class="p-4">

<div class="flex justify-between items-center mb-3">
<button id="toggleBtn" onclick="toggleRun()" class="bg-green-600 px-4 py-2">開始</button>
<input id="searchInput" placeholder="搜尋幣兌..." class="bg-black border border-gray-700 px-3 py-1">
<div class="w-64 bg-gray-800"><div id="progressBar" class="bar"></div></div>
</div>

<div class="flex gap-4">
<div id="list" class="grid grid-cols-4 gap-3 flex-1 overflow-auto h-[80vh]"></div>
<div class="w-80 border border-gray-700 p-2">
<h2 class="text-green-400 mb-2">低風險紀錄</h2>
<div id="log"></div>
</div>
</div>

<script>
const EXCLUDE_TOP35_COUNT = 35
let running=false
let interval
let symbols=[]
let market={}
let pinned=new Set()

function toggleRun(){
running=!running
document.getElementById('toggleBtn').innerText=running?'停止':'開始'
if(running){start()}else{clearInterval(interval)}
}

async function start(){
await loadSymbols()
await refresh()
let t=0
interval=setInterval(async()=>{
t+=100
document.getElementById('progressBar').style.width=(t/30000*100)+'%'
if(t>=30000){
t=0
await refresh()
}
},100)
}

async function loadSymbols(){
const res=await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr')
const data=await res.json()

symbols=data
.filter(x=>x.symbol.endsWith('USDT'))
.sort((a,b)=>b.quoteVolume-a.quoteVolume)
.slice(EXCLUDE_TOP35_COUNT,200) // 排除前35
.map(x=>x.symbol)
}

async function refresh(){
for(let s of symbols){
await processSymbol(s)
await new Promise(r=>setTimeout(r,50))
}
render()
}

async function processSymbol(s){
try{
const [k15,k4]=await Promise.all([
fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=120`).then(r=>r.json()),
fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=4h&limit=120`).then(r=>r.json())
])

let poc4h=calcPOC(k4)
let poc15=calcPOC(k15)
let last=parseFloat(k15[k15.length-1][4])
let vol=parseFloat(k15[k15.length-1][5])
let avgVol=k15.slice(-20).reduce((a,b)=>a+parseFloat(b[5]),0)/20

let ma7=ma(k15,7)
let ma25=ma(k15,25)
let ma99=ma(k15,99)

let breakout = last>poc15 && vol>avgVol*1.5

let risk='none'
if(breakout) risk='pre'
if(breakout && near(last,poc15)) risk='mid'
if(breakout && near(last,poc15) && near(last,ma99)) risk='low'

market[s]={last,poc4h,poc15,ma7,ma25,ma99,risk}

}catch(e){}
}

function calcPOC(k){
let bins={}
let prices=k.map(x=>parseFloat(x[4]))
let min=Math.min(...prices)
let max=Math.max(...prices)
let step=(max-min)/20||0.00001
k.forEach(c=>{
let p=parseFloat(c[4])
let v=parseFloat(c[5])
let b=Math.floor((p-min)/step)
bins[b]=(bins[b]||0)+v
})
let maxV=0,index=0
for(let i in bins){
if(bins[i]>maxV){maxV=bins[i];index=i}
}
return min+index*step
}

function ma(k,n){
let arr=k.slice(-n).map(x=>parseFloat(x[4]))
return arr.reduce((a,b)=>a+b,0)/arr.length
}

function near(a,b){
return Math.abs(a-b)/b<0.005
}

function render(){
let container=document.getElementById('list')
container.innerHTML=''
Object.keys(market).forEach(s=>{
let d=market[s]
if(!d) return
let div=document.createElement('div')
div.className='card p-2 '+(d.risk==='low'?'low':d.risk==='mid'?'mid':d.risk==='pre'?'pre':'')
div.innerHTML=`
<div class="flex justify-between">
<span>${s.replace('USDT','')}</span>
<button onclick="pin('${s}')">${pinned.has(s)?'取消':'標記'}</button>
</div>
<div>價: ${d.last.toFixed(4)}</div>
<div>4H POC: ${d.poc4h.toFixed(4)}</div>
<div>15M POC: ${d.poc15.toFixed(4)}</div>
<div>MA7:${d.ma7.toFixed(4)}</div>
<div>MA25:${d.ma25.toFixed(4)}</div>
<div>MA99:${d.ma99.toFixed(4)}</div>
<div class="mt-1">${label(d.risk)}</div>
`
container.appendChild(div)

if(d.risk==='low'){
let log=document.getElementById('log')
let item=document.createElement('div')
item.innerText=`${s} 低風險進場`
log.prepend(item)
}
})
}

function label(r){
if(r==='low') return '低風險進場'
if(r==='mid') return '中風險進場'
if(r==='pre') return '預備進場'
return ''
}

function pin(s){
if(pinned.has(s)) pinned.delete(s)
else pinned.add(s)
render()
}

document.getElementById('searchInput').addEventListener('keydown',e=>{
if(e.key==='Enter'){
let s=e.target.value.toUpperCase()
if(!s.endsWith('USDT')) s+='USDT'
symbols.unshift(s)
e.target.value=''
}
})
</script>

</body>
</html>
