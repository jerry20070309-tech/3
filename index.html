<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>⚡ TRIDENT V30 - 穩定修復版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #000; color: #d4d4d8; font-family: monospace; }
        .card { background: #0a0a0a; border: 1px solid #222; transition: 0.3s; opacity: 0; }
        .card-show { opacity: 1; }
        .win-gradient { background: linear-gradient(90deg, #ef4444 0%, #18181b 50%, #22c55e 100%); height: 8px; border-radius: 4px; position: relative; }
        .pointer { width: 3px; height: 16px; background: #fff; position: absolute; top: -4px; box-shadow: 0 0 8px #fff; }
        .liq-alert { border: 2px solid #ef4444 !important; background: #200 !important; animation: pulse 0.8s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body class="p-6">

    <div class="flex justify-between items-center border-b border-zinc-800 pb-4 mb-6">
        <h1 class="text-xl font-black italic text-red-600">TRIDENT V30 <span class="text-white text-xs">穩定版</span></h1>
        <div id="status" class="text-[10px] text-zinc-500 font-bold uppercase">系統待命</div>
        <button id="startBtn" onclick="ignite()" class="bg-red-700 text-white px-6 py-1.5 rounded font-black text-sm">啟動雷達</button>
    </div>

    <div id="monitorList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>

<script>
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','BNBUSDT'];
    let marketData = {};

    // 修正後的 API 路徑函數
    async function getOI(s) {
        try {
            // 注意：路徑改為 /futures/data/ 而非 /fapi/v1/
            const res = await fetch(`https://fapi.binance.com/futures/data/openInterestHist?symbol=${s.toUpperCase()}&period=1h&limit=5`);
            if (!res.ok) return { h1: "0.00", h4: "0.00" };
            const d = await res.json();
            if (d.length >= 4) {
                const now = parseFloat(d[d.length-1].sumOpenInterest);
                const h1 = parseFloat(d[d.length-2].sumOpenInterest);
                const h4 = parseFloat(d[0].sumOpenInterest);
                return {
                    h1: ((now - h1) / h1 * 100).toFixed(2),
                    h4: ((now - h4) / h4 * 100).toFixed(2)
                };
            }
        } catch(e) { return { h1: "0.00", h4: "0.00" }; }
        return { h1: "0.00", h4: "0.00" };
    }

    async function ignite() {
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('status').innerText = "數據初始化中...";

        const tickers = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        const targets = tickers.filter(t => t.symbol.endsWith('USDT') && !EXCLUDE.includes(t.symbol))
                               .sort((a,b) => b.quoteVolume - a.quoteVolume).slice(0, 40);

        for (let t of targets) {
            try {
                const k = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${t.symbol}&interval=15m&limit=50`).then(r=>r.json());
                const lows = k.map(x => parseFloat(x[3]));
                const oi = await getOI(t.symbol);
                
                marketData[t.symbol] = {
                    support: Math.min(...lows),
                    avgVol: k.reduce((a,b)=>a+parseFloat(b[5]), 0) / k.length,
                    oi: oi,
                    winRate: 50,
                    delta: 0
                };
            } catch(e) { console.error(`跳過 ${t.symbol}`); }
            document.getElementById('status').innerText = `已加載: ${Object.keys(marketData).length}`;
        }
        startWS();
    }

    function startWS() {
        const ws = new WebSocket('wss://fstream.binance.com/ws/!ticker@arr');
        ws.onmessage = (e) => {
            JSON.parse(e.data).forEach(m => {
                const base = marketData[m.s];
                if (!base) return;

                const price = parseFloat(m.c);
                const vol15m = (parseFloat(m.q) / 1440) * 15;
                const ratio = vol15m / base.avgVol;

                // 簡單勝率動能邏輯
                const change = (price - parseFloat(m.o)) / parseFloat(m.o);
                base.winRate = 50 + (change * 1000); 
                base.winRate = Math.max(10, Math.min(90, base.winRate));

                const isLiq = (price < base.support) && (ratio > 2.0);

                if (ratio > 1.2 || isLiq) {
                    updateUI(m.s, price, ratio, isLiq, base);
                } else {
                    const card = document.getElementById(`card-${m.s}`);
                    if(card) card.remove();
                }
            });
        };
    }

    function updateUI(s, p, r, alert, data) {
        let el = document.getElementById(`card-${s}`);
        if (!el) {
            el = document.createElement('div');
            el.id = `card-${s}`;
            document.getElementById('monitorList').prepend(el);
        }
        el.className = `card p-4 rounded card-show ${alert ? 'liq-alert' : ''}`;
        el.innerHTML = `
            <div class="flex justify-between mb-2">
                <span class="font-bold text-white">${s.replace('USDT','')}</span>
                <span class="text-[10px] text-zinc-500">${r.toFixed(1)}x 量能</span>
            </div>
            <div class="win-gradient mb-4">
                <div class="pointer" style="left: ${data.winRate}%"></div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-[10px] font-bold">
                <div class="text-zinc-500">現價: ${p}</div>
                <div class="text-zinc-500 text-right">前低: ${data.support.toFixed(4)}</div>
                <div class="${data.oi.h1 < 0 ? 'text-red-500' : 'text-green-500'}">1H持倉: ${data.oi.h1}%</div>
                <div class="${data.oi.h4 < 0 ? 'text-red-500' : 'text-green-500'} text-right">4H持倉: ${data.oi.h4}%</div>
            </div>
        `;
    }
</script>
</body>
</html>
