<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ğŸ™ CITY V1.0 LONG ONLY</title>
<style>
body{background:#000;color:#00ff88;font-family:monospace}
.card{border:1px solid #00ff88;padding:12px;margin:8px;width:430px}
.score{color:#00ffff;font-weight:bold}
.strategy{color:#ffaa00;font-size:12px;margin-top:6px}
input{background:#111;color:#00ff88;border:1px solid #00ff88;padding:4px;margin-right:10px}
button{background:#00aa55;color:#fff;border:none;padding:6px 12px;cursor:pointer}
h2{color:#00ffff}
</style>
</head>
<body>

<h2>ğŸ™ CITY V1.0 LONG ONLY</h2>

æœ€å¤§è™§æ(USDT):
<input id="risk" type="number" value="5">

<button onclick="start()">é–‹å§‹æƒæ</button>

<div id="result">å°šæœªæƒæ</div>

<script>

const BASE="https://fapi.binance.com";
let firstLoad=true;

async function getTopSymbols(limit){
  const r=await fetch(BASE+"/fapi/v1/ticker/24hr");
  const d=await r.json();
  return d.filter(s=>s.symbol.endsWith("USDT"))
  .sort((a,b)=>parseFloat(b.quoteVolume)-parseFloat(a.quoteVolume))
  .slice(35,35+limit)
  .map(s=>s.symbol);
}

async function klines(symbol,interval,limit=200){
  const r=await fetch(`${BASE}/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`);
  return await r.json();
}

async function getOI(symbol){
  const r=await fetch(`${BASE}/fapi/v1/openInterest?symbol=${symbol}`);
  const d=await r.json();
  return parseFloat(d.openInterest);
}

async function getFunding(symbol){
  const r=await fetch(`${BASE}/fapi/v1/premiumIndex?symbol=${symbol}`);
  const d=await r.json();
  return parseFloat(d.lastFundingRate);
}

function SMA(data,p){
  let sum=0;
  for(let i=data.length-p;i<data.length;i++) sum+=parseFloat(data[i][4]);
  return sum/p;
}

function slope(data,p=10){
  let a=parseFloat(data[data.length-p][4]);
  let b=parseFloat(data[data.length-1][4]);
  return (b-a)/a;
}

function swingLow(data){
  return Math.min(...data.slice(-20).map(x=>parseFloat(x[3])));
}

function ATR(data,p){
  let trs=[];
  for(let i=data.length-p;i<data.length;i++){
    trs.push(parseFloat(data[i][2])-parseFloat(data[i][3]));
  }
  return trs.reduce((a,b)=>a+b)/p;
}

function POC(data){
  let map={};
  data.forEach(c=>{
    let price=Math.round(parseFloat(c[4])*100)/100;
    let vol=parseFloat(c[5]);
    map[price]=(map[price]||0)+vol;
  });
  let max=0,poc=0;
  for(let p in map){
    if(map[p]>max){max=map[p];poc=parseFloat(p);}
  }
  return poc;
}

function positionSize(entry,stop,risk){
  return risk/(entry-stop);
}

function TP(entry,atr){
  return entry+atr*2;
}

async function scan(symbol){

  try{

  const m15=await klines(symbol,"15m");
  const h4=await klines(symbol,"4h");

  let price=parseFloat(m15[m15.length-1][4]);
  let ma25=SMA(m15,25);
  let ma99=SMA(m15,99);
  let ma25_4h=SMA(h4,25);
  let ma99_4h=SMA(h4,99);

  let sl=swingLow(m15);
  let poc=POC(h4);
  let atr14=ATR(m15,14);
  let atr50=ATR(m15,50);

  let storm=atr14/atr50;
  let sSlope=slope(m15);

  let oi=await getOI(symbol);
  let funding=await getFunding(symbol);

  let score=0;
  let tags=[];

  if(price>ma25 && ma25>ma99 && ma25_4h>ma99_4h){
    score+=20; tags.push("è¶¨å‹¢å¤š");
  }

  if(price>sl){
    score+=15; tags.push("HLçµæ§‹");
  }

  if(price>poc){
    score+=15; tags.push("ç«™ä¸ŠPOC");
  }

  if(sSlope>0.01){
    score+=15; tags.push("æ–œç‡æ­£");
  }

  if(oi>0 && funding<0.01){
    score+=15; tags.push("å¥åº·è³‡é‡‘");
  }

  if(storm>1.3){
    score+=20; tags.push("å¤§é¢¨æš´");
  }

  if(score<80) return null;

  let stop=Math.min(sl,poc*0.997);
  if(stop>=price) return null;

  let entry=price;
  let tp=TP(entry,atr14);

  let risk=parseFloat(document.getElementById("risk").value);
  let pos=positionSize(entry,stop,risk);

  let rr=((tp-entry)/(entry-stop)).toFixed(2);

  return {symbol,score,entry,stop,tp,pos,rr,tags};

  }catch(e){
    return null;
  }
}

async function start(){
  document.getElementById("result").innerHTML="æƒæä¸­...";
  let limit=firstLoad?400:100;
  let symbols=await getTopSymbols(limit);
  firstLoad=false;

  let results=[];

  for(let s of symbols){
    let r=await scan(s);
    if(r) results.push(r);
  }

  results.sort((a,b)=>b.score-a.score);

  let html="";
  results.forEach(r=>{
    html+=`
    <div class="card">
    <b>${r.symbol}</b> <span class="score">${r.score}</span><br>
    Entry: ${r.entry.toFixed(4)}<br>
    Stop: ${r.stop.toFixed(4)}<br>
    TP: ${r.tp.toFixed(4)}<br>
    RR: ${r.rr}<br>
    å€‰ä½: ${r.pos.toFixed(2)}<br>
    <div class="strategy">${r.tags.join(" | ")}</div>
    </div>`;
  });

  document.getElementById("result").innerHTML=html||"ç„¡é”æ¨™å¹£";

  setTimeout(start,30000);
}

</script>

</body>
</html>
