<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>⚡ TRIDENT V29 - 動能清算雷達</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background: #050505; color: #d4d4d8; font-family: 'JetBrains Mono', 'Microsoft JhengHei', monospace; overflow-x: hidden; }
        
        /* 動態勝率漸變條 */
        .win-gradient { background: linear-gradient(90deg, #ef4444 0%, #18181b 50%, #22c55e 100%); position: relative; height: 12px; border-radius: 4px; border: 1px solid #1f1f23; }
        
        /* 指針樣式 */
        .win-pointer { width: 3px; height: 20px; background: #fff; position: absolute; top: -4px; transition: all 0.2s; box-shadow: 0 0 10px #fff; z-index: 40; }
        .h1-pointer { width: 2px; height: 20px; background: #f59e0b; position: absolute; top: -4px; border-left: 1px dashed #f59e0b; z-index: 20; }
        .h4-pointer { width: 2px; height: 20px; background: #3b82f6; position: absolute; top: -4px; z-index: 10; }
        
        .card-stat { background: #0f0f11; border: 1px solid #1f1f23; transition: all 0.4s ease; opacity: 0; transform: scale(0.95); }
        .card-show { opacity: 1; transform: scale(1); }
        .liq-alert { border: 2px solid #ef4444 !important; background: #210808 !important; animation: blink 0.6s infinite; }
        
        @keyframes blink { 0%, 100% { box-shadow: 0 0 10px #ef4444; } 50% { box-shadow: 0 0 20px #ef4444; } }
        .oi-up { color: #22c55e; } 
        .oi-down { color: #ef4444; }
    </style>
</head>
<body class="p-6 h-screen flex flex-col">

    <header class="flex justify-between items-center border-b border-zinc-800 pb-5 mb-6">
        <div>
            <h1 class="text-2xl font-black italic text-white tracking-tighter uppercase">TRIDENT <span class="text-red-600 font-black">V29</span></h1>
            <p id="statusMsg" class="text-[10px] text-zinc-500 font-bold uppercase mt-1">底層採集：V6.4 FULL DATA RADAR 引擎</p>
        </div>
        <div class="flex gap-4 items-center">
            <div id="loadingInfo" class="text-right text-[10px] text-zinc-600 font-mono font-bold">系統待命</div>
            <button id="startBtn" onclick="ignite()" class="bg-red-700 text-white px-8 py-2 font-black rounded hover:bg-red-600 transition-all shadow-lg">啟動全市場掃描</button>
        </div>
    </header>

    <div id="monitorList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 overflow-y-auto pr-2 flex-1"></div>

<script>
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','BNBUSDT','BNXUSDT'];
    let marketData = {}; 
    const VOL_TRIGGER = 1.3; // 超過 1.3 倍量即顯示
    const LIQ_TRIGGER = 2.5; // 超過 2.5 倍量 + 跌破前低點 = 清算警告

    // 1. 採集 4H/1H 的 OI 持倉歷史 (V26 邏輯補全)
    async function getOIStats(s) {
        try {
            const res = await fetch(`https://fapi.binance.com/fapi/v1/openInterestHist?symbol=${s}&period=1h&limit=5`);
            const hist = await res.json();
            if (hist && hist.length >= 4) {
                const now = parseFloat(hist[hist.length-1].sumOpenInterest);
                return {
                    chg1h: ((now - parseFloat(hist[hist.length-2].sumOpenInterest)) / parseFloat(hist[hist.length-2].sumOpenInterest) * 100).toFixed(2),
                    chg4h: ((now - parseFloat(hist[0].sumOpenInterest)) / parseFloat(hist[0].sumOpenInterest) * 100).toFixed(2)
                };
            }
        } catch(e) { return { chg1h: "0.00", chg4h: "0.00" }; }
    }

    // 2. 初始化 V6.4 數據庫 (預載 240 分鐘 K 線)
    async function ignite() {
        const btn = document.getElementById('startBtn');
        const status = document.getElementById('statusMsg');
        const info = document.getElementById('loadingInfo');
        
        btn.disabled = true;
        status.innerText = "正在執行 V6.4 多時區 Delta 運算...";

        const tickerRes = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
        const tickers = await tickerRes.json();
        const targets = tickers.filter(s => s.symbol.endsWith('USDT') && !EXCLUDE.includes(s.symbol))
                               .sort((a,b) => b.quoteVolume - a.quoteVolume).slice(0, 60);

        for(let i=0; i<targets.length; i+=4) {
            const batch = targets.slice(i, i+4);
            await Promise.all(batch.map(async (t) => {
                try {
                    const [k, oi] = await Promise.all([
                        fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${t.symbol}&interval=1m&limit=240`).then(r=>r.json()),
                        getOIStats(t.symbol)
                    ]);

                    let d4=0, d1=0, lows=[];
                    k.forEach((v, idx) => {
                        let delta = parseFloat(v[10]) - (parseFloat(v[7]) - parseFloat(v[10]));
                        d4 += delta; if(idx >= 180) d1 += delta;
                        lows.push(parseFloat(v[3]));
                    });

                    marketData[t.symbol] = {
                        symbol: t.symbol,
                        support: Math.min(...lows), // 50K 前低點
                        avgVol: k.reduce((a,b)=>a+parseFloat(b[5]), 0) / k.length,
                        winRate: 50,
                        avgWinRate1h: 50 + (d1/5000000*50),
                        avgWinRate4h: 50 + (d4/20000000*50),
                        delta: d4,
                        maxDelta: 20000,
                        oi: oi,
                        isReady: true
                    };
                } catch(e) {}
            }));
            info.innerText = `加載進度: ${i + batch.length} / ${targets.length}`;
            await new Promise(r => setTimeout(r, 300));
        }

        btn.style.display = 'none';
        status.innerText = "雷達就緒：實時監控清算動能中";
        startWS();
    }

    // 3. 實時 WebSocket (V6.4 運算引擎)
    function startWS() {
        const ws = new WebSocket(`wss://fstream.binance.com/ws/!ticker@arr`);
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            data.forEach(msg => {
                const s = msg.s;
                const base = marketData[s];
                if(!base) return;

                const price = parseFloat(msg.c);
                const curVol = parseFloat(msg.q) / 1440; 
                const volRatio = (curVol * 15) / base.avgVol;

                // V6.4 Delta 模擬計算 (基於價格變動)
                const priceChange = price - parseFloat(msg.o);
                base.delta = (base.delta * 0.9995) + (priceChange * curVol);
                base.maxDelta = Math.max(base.maxDelta * 0.9999, Math.abs(base.delta), 20000);
                let targetWin = 50 + (Math.tanh((base.delta/base.maxDelta) * 1.8) * 50);
                base.winRate = (base.winRate * 0.8) + (targetWin * 0.2);

                const isAlert = (price < base.support) && (volRatio > LIQ_TRIGGER);
                const shouldShow = (volRatio > VOL_TRIGGER);

                if (shouldShow || isAlert) {
                    updateUI(s, price, volRatio, isAlert, base);
                } else {
                    const el = document.getElementById(`card-${s}`);
                    if(el) { el.classList.remove('card-show'); setTimeout(()=>el.remove(), 400); }
                }
            });
        };
    }

    // 4. 全中文介面與指針渲染
    function updateUI(s, price, ratio, isAlert, data) {
        let el = document.getElementById(`card-${s}`);
        if (!el) {
            el = document.createElement('div');
            el.id = `card-${s}`;
            el.className = "card-stat p-4 rounded-lg";
            document.getElementById('monitorList').prepend(el);
            setTimeout(() => el.classList.add('card-show'), 10);
        }

        el.className = `card-stat p-4 rounded-lg card-show ${isAlert ? 'liq-alert' : ''}`;
        el.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div>
                    <span class="text-xl font-black italic text-white">${s.replace('USDT','')}</span>
                    <div class="text-[10px] text-zinc-500 mt-1 font-bold">$${price}</div>
                </div>
                <div class="text-right">
                    <div class="text-xs font-bold ${data.winRate > 50 ? 'text-emerald-500' : 'text-red-500'}">
                        動能勝率: ${data.winRate.toFixed(1)}%
                    </div>
                    <div class="text-[9px] text-zinc-600 mt-1">1/96 量能: ${ratio.toFixed(2)}x</div>
                </div>
            </div>

            <div class="win-gradient mb-6">
                <div class="h4-pointer" style="left: ${data.avgWinRate4h}%"></div>
                <div class="h1-pointer" style="left: ${data.avgWinRate1h}%"></div>
                <div class="win-pointer" style="left: ${data.winRate}%"></div>
            </div>

            <div class="grid grid-cols-2 gap-2 mb-4 text-[11px] font-bold">
                <div class="bg-black/40 p-2 rounded">
                    <div class="text-zinc-600 mb-1 uppercase">50K前低支撐</div>
                    <div class="text-white">${data.support.toFixed(4)}</div>
                </div>
                <div class="bg-black/40 p-2 rounded">
                    <div class="text-zinc-600 mb-1 uppercase">清算狀態</div>
                    <div class="${isAlert ? 'text-red-500 animate-pulse' : 'text-zinc-500'}">${isAlert ? '⚠️ 偵測到下殺' : '趨勢穩定'}</div>
                </div>
            </div>

            <div class="bg-zinc-900/50 p-2 rounded flex justify-around text-[10px] font-mono">
                <div class="flex flex-col items-center">
                    <span class="text-zinc-500">1H 持倉</span>
                    <span class="${data.oi.chg1h > 0 ? 'oi-up' : 'oi-down'}">${data.oi.chg1h}%</span>
                </div>
                <div class="flex flex-col items-center border-l border-zinc-800 pl-4">
                    <span class="text-zinc-500">4H 持倉</span>
                    <span class="${data.oi.chg4h > 0 ? 'oi-up' : 'oi-down'}">${data.oi.chg4h}%</span>
                </div>
            </div>
        `;
    }
</script>
</body>
</html>
