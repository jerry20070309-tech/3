<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>⚡ TRIDENT V21 - STABLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #000; color: #fbbf24; font-family: 'JetBrains Mono', monospace; }
        .card { border: 1px solid #1a1a1a; background: #050505; border-radius: 8px; }
        .liq-glow { border: 2px solid #ff4444; box-shadow: 0 0 15px #900; background: #1a0000 !important; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse { animation: pulse-red 1s infinite; }
    </style>
</head>
<body class="p-6">

    <header class="flex justify-between items-center border-b border-zinc-800 pb-5 mb-6">
        <div>
            <h1 class="text-2xl font-black italic text-yellow-500 tracking-tighter">TRIDENT V21</h1>
            <p id="systemStatus" class="text-[10px] text-zinc-500 uppercase mt-1">系統待命 - 準備向 BINANCE 請求數據</p>
        </div>
        <button id="startBtn" onclick="initMonitor()" class="bg-yellow-600 text-black px-10 py-2 font-black rounded hover:bg-yellow-400 transition-all">啟動監控</button>
    </header>

    <div id="dashboard" class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-6"></div>

<script>
    const SYMBOLS = ["PIPPINUSDT", "BNBUSDT", "ADAUSDT", "LTCUSDT", "NEOUSDT", "QTUMUSDT"];
    const LOOKBACK_PERIOD = 50; 
    const VOL_SPIKE_RATIO = 2.5;
    
    let store = {};
    let ws = null;

    async function initMonitor() {
        const btn = document.getElementById('startBtn');
        const statusText = document.getElementById('systemStatus');
        
        btn.disabled = true;
        btn.innerText = "連線中...";
        statusText.innerText = "正在建立初始基線 (SEQUENCE FETCH)...";

        for (const s of SYMBOLS) {
            try {
                // 強制延遲 500ms 避免觸發幣安 IP 保護
                await new Promise(r => setTimeout(r, 500));
                
                // 向幣安請求 15m K線數據
                const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${s}&interval=15m&limit=${LOOKBACK_PERIOD}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const klines = await res.json();
                
                // 還原 Java calculateBaseLine 邏輯
                let minLow = Infinity;
                let totalVol = 0;
                klines.forEach(k => {
                    const low = parseFloat(k[3]);
                    const vol = parseFloat(k[5]);
                    if (low < minLow) minLow = low;
                    totalVol += vol;
                });

                store[s] = {
                    support: minLow,
                    avgVol: totalVol / klines.length,
                    price: 0,
                    currentVol: 0,
                    isAlert: false
                };
                
                renderCard(s);
                statusText.innerText = `成功獲取 ${s} 基線...`;
            } catch (e) {
                console.error(e);
                statusText.innerText = `錯誤: ${s} 請求失敗，請重試`;
                btn.disabled = false;
                btn.innerText = "重試啟動";
                return; // 發生錯誤就停止，讓使用者重試
            }
        }
        
        btn.innerText = "監控中 (WS)";
        statusText.innerText = "初始化完成，切換至 WebSocket 持續數據流";
        startWebSocket();
    }

    function startWebSocket() {
        // 使用 WebSocket 避免重複 fetch
        const streams = SYMBOLS.map(s => `${s.toLowerCase()}@ticker`).join('/');
        ws = new WebSocket(`wss://stream.binance.com:9443/ws/${streams}`);

        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            const s = data.s;
            const d = store[s];
            if (!d) return;

            // 還原 Java detectLiquidation 邏輯
            d.price = parseFloat(data.c);
            d.currentVol = parseFloat(data.v) / 96; // 1/96 換算

            const priceDropped = d.price < d.support;
            const volumeExploded = d.currentVol > (d.avgVol * VOL_SPIKE_RATIO);
            d.isAlert = priceDropped && volumeExploded;

            updateUI(s);
        };

        ws.onclose = () => {
            document.getElementById('systemStatus').innerText = "WS 連線斷開，請重新整理";
        };
    }

    function renderCard(s) {
        const dash = document.getElementById('dashboard');
        if (document.getElementById(`card-${s}`)) return;
        const div = document.createElement('div');
        div.id = `card-${s}`;
        div.className = "card p-5";
        dash.appendChild(div);
    }

    function updateUI(s) {
        const el = document.getElementById(`card-${s}`);
        const d = store[s];
        el.className = `card p-5 ${d.isAlert ? 'liq-glow' : ''}`;
        el.innerHTML = `
            <div class="flex justify-between mb-4">
                <span class="text-xl font-bold text-white">${s.replace('USDT','')}</span>
                <span class="text-[10px] ${d.isAlert ? 'text-red-500 pulse font-bold' : 'text-zinc-600'}">
                    ${d.isAlert ? '⚠ 清算觸發' : '掃描中'}
                </span>
            </div>
            <div class="space-y-2 text-xs font-mono">
                <div class="flex justify-between"><span>最新價</span><span class="text-white">${d.price}</span></div>
                <div class="flex justify-between"><span>支撐位</span><span class="text-zinc-400">${d.support.toFixed(4)}</span></div>
                <div class="pt-2 border-t border-zinc-900 mt-2">
                    <div class="flex justify-between">
                        <span class="text-zinc-500 text-[10px]">即時量 (1/96)</span>
                        <span class="${d.isAlert ? 'text-red-500' : 'text-blue-500'} font-bold">${d.currentVol.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        `;
    }
</script>
</body>
</html>
