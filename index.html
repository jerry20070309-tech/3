<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>POC BREAKOUT MONITOR</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{
    background:#050505;
    font-family: 'JetBrains Mono', monospace;
    overflow:hidden;
}
.card{
    background:rgba(20,20,25,0.7);
    backdrop-filter: blur(12px);
    border:1px solid #1f1f23;
    transition: all .3s ease;
}
.card:hover{
    transform:translateY(-4px);
    box-shadow:0 0 25px rgba(59,130,246,.3);
}
.breakout{
    box-shadow:0 0 25px rgba(34,197,94,.7);
    border:1px solid #22c55e;
}
.lowrisk{
    border:1px solid gold !important;
    box-shadow:0 0 30px rgba(255,215,0,.6);
}
.midrisk{
    border:1px solid orange !important;
}
.pulse{
    animation:pulseGlow 1.2s infinite;
}
@keyframes pulseGlow{
    0%{box-shadow:0 0 8px #22c55e;}
    50%{box-shadow:0 0 25px #22c55e;}
    100%{box-shadow:0 0 8px #22c55e;}
}
.refresh-bar{
    height:4px;
    background:#3b82f6;
    width:0%;
}
</style>
</head>
<body class="p-4 h-screen flex flex-col text-gray-200">

<header class="flex justify-between items-center mb-3">
<div class="flex gap-4 items-center">
<button id="toggleBtn" onclick="toggleRun()" 
class="bg-green-600 px-4 py-2 rounded font-bold">開啟</button>

<input id="searchInput" 
placeholder="搜尋幣對..." 
class="bg-black border border-zinc-700 px-3 py-1 rounded text-sm"
onkeydown="handleSearch(event)">
</div>

<div class="w-64 bg-zinc-800 rounded overflow-hidden">
<div id="refreshBar" class="refresh-bar"></div>
</div>
</header>

<main class="flex flex-1 overflow-hidden gap-4">
<div id="cards" 
class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto flex-1 pr-2">
</div>

<div class="w-72 border border-zinc-800 rounded p-3 bg-black/40 flex flex-col">
<h2 class="text-green-400 font-bold mb-2">低風險紀錄</h2>
<div id="lowRiskLog" class="overflow-y-auto text-sm flex-1"></div>
</div>
</main>

<script>
let running=false;
let refreshTimer=null;
let progress=0;
let marketData={};
let lowRiskLogged=new Set();
let pinned=new Set(JSON.parse(localStorage.getItem("pinned")||"[]"));

const EXCLUDE_TOP35=[
'BTCUSDT','ETHUSDT','BNBUSDT','SOLUSDT','XRPUSDT','ADAUSDT',
'DOGEUSDT','TRXUSDT','AVAXUSDT','DOTUSDT','MATICUSDT',
'LINKUSDT','TONUSDT','SHIBUSDT','BCHUSDT','LTCUSDT',
'NEARUSDT','ICPUSDT','APTUSDT','FILUSDT','ATOMUSDT',
'ETCUSDT','OPUSDT','ARBUSDT','IMXUSDT','INJUSDT',
'XLMUSDT','HBARUSDT','STXUSDT','SUIUSDT','TIAUSDT',
'PEPEUSDT','KASUSDT','RNDRUSDT','MKRUSDT'
];

function toggleRun(){
running=!running;
document.getElementById("toggleBtn").innerText=running?"停止":"開啟";
document.getElementById("toggleBtn").className=
running?"bg-red-600 px-4 py-2 rounded font-bold":
"bg-green-600 px-4 py-2 rounded font-bold";

if(running){
refreshAll();
refreshTimer=setInterval(refreshAll,30000);
setInterval(updateBar,100);
}else{
clearInterval(refreshTimer);
}
}

function updateBar(){
if(!running) return;
progress+=100;
if(progress>=30000) progress=0;
document.getElementById("refreshBar").style.width=
(progress/30000*100)+"%";
}

async function refreshAll(){
progress=0;
const tickers=await fetch("https://fapi.binance.com/fapi/v1/ticker/24hr")
.then(r=>r.json());

const targets=tickers
.filter(t=>t.symbol.endsWith("USDT")
&&!EXCLUDE_TOP35.includes(t.symbol))
.sort((a,b)=>b.quoteVolume-a.quoteVolume)
.slice(0,400);

for(let t of targets){
await analyzeSymbol(t.symbol);
await new Promise(r=>setTimeout(r,80));
}
}

async function analyzeSymbol(s){
try{
const k15=await fetch(
`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=120`)
.then(r=>r.json());

const k4h=await fetch(
`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=4h&limit=120`)
.then(r=>r.json());

const poc4h=calcPOC(k4h);
const ma7=ma(k15,7);
const ma25=ma(k15,25);
const ma99=ma(k15,99);

const last=k15[k15.length-1];
const price=parseFloat(last[4]);
const vol=parseFloat(last[5]);
const avgVol=k15.reduce((a,b)=>a+parseFloat(b[5]),0)/k15.length;

const breakout=price>poc4h && vol>avgVol*1.8;

if(!breakout) return;

let risk="";
if(Math.abs(price-poc4h)/price<0.002 
&& Math.abs(price-ma99)/price<0.002){
risk="low";
}else if(Math.abs(price-poc4h)/price<0.002
|| Math.abs(price-ma99)/price<0.002){
risk="mid";
}

renderCard(s,price,poc4h,ma7,ma25,ma99,risk);

}catch(e){}
}

function calcPOC(k){
let bins={};
let min=Math.min(...k.map(x=>parseFloat(x[3])));
let max=Math.max(...k.map(x=>parseFloat(x[2])));
let step=(max-min)/30||0.00001;

k.forEach(x=>{
let p=parseFloat(x[4]);
let v=parseFloat(x[5]);
let bin=Math.floor((p-min)/step)*step+min;
bins[bin]=(bins[bin]||0)+v;
});
return parseFloat(
Object.keys(bins).reduce((a,b)=>
bins[a]>bins[b]?a:b)
);
}

function ma(k,len){
let slice=k.slice(-len);
return slice.reduce((a,b)=>a+parseFloat(b[4]),0)/len;
}

function renderCard(s,p,poc,ma7,ma25,ma99,risk){
let el=document.getElementById("card-"+s);
if(!el){
el=document.createElement("div");
el.id="card-"+s;
document.getElementById("cards").appendChild(el);
}

el.className="card p-4 breakout pulse";

if(risk==="low"){
el.classList.add("lowrisk");
if(!lowRiskLogged.has(s)){
lowRiskLogged.add(s);
let log=document.createElement("div");
log.innerText=s+" 低風險";
document.getElementById("lowRiskLog").prepend(log);
}
}else if(risk==="mid"){
el.classList.add("midrisk");
}

el.innerHTML=`
<div class="flex justify-between">
<span class="font-bold text-lg">${s.replace("USDT","")}</span>
<button onclick="togglePin('${s}')" class="text-xs text-blue-400">標記</button>
</div>
<div class="text-sm mt-2">
現價: ${p.toFixed(4)}<br>
4H POC: ${poc.toFixed(4)}<br>
MA7: ${ma7.toFixed(4)}<br>
MA25: ${ma25.toFixed(4)}<br>
MA99: ${ma99.toFixed(4)}
</div>
`;
}

function togglePin(s){
if(pinned.has(s)) pinned.delete(s);
else pinned.add(s);
localStorage.setItem("pinned",JSON.stringify([...pinned]));
}

function handleSearch(e){
if(e.key==="Enter"){
let val=e.target.value.toUpperCase();
if(!val.endsWith("USDT")) val+="USDT";
analyzeSymbol(val);
e.target.value="";
}
}
</script>
</body>
</html>
