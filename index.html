<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TRIDENT V58 - ATR ENGINE</title>
<style>
body{
    background:#000;
    color:#00ff9d;
    font-family:monospace;
}
.container{width:1200px;margin:auto;}
input{
    background:#111;
    border:1px solid #00ff9d;
    color:#00ff9d;
    padding:5px;
    width:100px;
}
button{
    background:#00ff9d;
    color:#000;
    padding:6px 12px;
    border:none;
    cursor:pointer;
}
.card{
    border:1px solid #00ff9d;
    padding:10px;
    margin:10px 0;
}
.bar{
    height:6px;
    background:#222;
    margin:5px 0;
}
.barfill{
    height:6px;
    background:#00ff9d;
}
.progress{
    height:5px;
    background:#00ff9d;
    transition:width 1s linear;
}
</style>
</head>
<body>

<div class="container">

<h2>TRIDENT V58 - FIXED ATR x2</h2>

保證金:
<input id="margin" value="100">
槓桿:
<input id="leverage" value="10">
<button onclick="start()">開始掃描</button>

<div class="bar">
    <div id="timebar" class="progress" style="width:0%"></div>
</div>

<div id="results"></div>

</div>

<script>

let symbols = []
let dataStore = {}
let timer

async function start(){

    document.getElementById("results").innerHTML=""

    const tickers = await fetch("https://fapi.binance.com/fapi/v1/ticker/24hr")
        .then(r=>r.json())

    // 只取成交量前100
    symbols = tickers
        .filter(t=>t.symbol.endsWith("USDT"))
        .sort((a,b)=>b.quoteVolume-a.quoteVolume)
        .slice(0,100)
        .map(t=>t.symbol)

    scan()

    if(timer) clearInterval(timer)
    timer = setInterval(()=>{
        scan()
    },30000)

    progressBar()
}

function progressBar(){
    let bar = document.getElementById("timebar")
    let percent = 0
    bar.style.width="0%"
    let interval = setInterval(()=>{
        percent+=3.33
        bar.style.width=percent+"%"
        if(percent>=100){
            clearInterval(interval)
            progressBar()
        }
    },1000)
}

async function scan(){

    const margin = parseFloat(document.getElementById("margin").value)
    const leverage = parseFloat(document.getElementById("leverage").value)
    const capital = margin*leverage

    let results=[]

    for(let s of symbols){

        const k = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=50`)
            .then(r=>r.json())

        if(!k || k.length<30) continue

        const closes = k.map(x=>parseFloat(x[4]))
        const highs = k.map(x=>parseFloat(x[2]))
        const lows = k.map(x=>parseFloat(x[3]))

        const entry = closes[closes.length-1]

        // 結構止損 = 最近10根最低
        const stop = Math.min(...lows.slice(-10))

        const risk = entry-stop
        if(risk<=0) continue

        // ATR(20)
        let ranges=[]
        for(let i=1;i<k.length;i++){
            ranges.push(highs[i]-lows[i])
        }
        const atr = ranges.slice(-20).reduce((a,b)=>a+b)/20

        // 固定 ATR x2
        const tp = entry + atr*2

        const qty = capital/entry
        const maxProfit = (tp-entry)*qty
        const profitRate = (maxProfit/margin)*100

        const stormRatio = (tp-entry)/risk

        // 評分系統
        let score=0
        if(stormRatio>2) score+=25
        if(profitRate>20) score+=25
        if(atr/entry>0.01) score+=25
        if(entry>stop) score+=25

        results.push({
            symbol:s,
            entry,
            stop,
            tp,
            stormRatio,
            profitRate,
            score
        })
    }

    results.sort((a,b)=>b.score-a.score)
    render(results.slice(0,15))
}

function render(list){

    const box=document.getElementById("results")
    box.innerHTML=""

    for(let d of list){

        box.innerHTML+=`
        <div class="card">
            <b>${d.symbol}</b> | Score: ${d.score}
            <div>Entry: ${d.entry.toFixed(4)}</div>
            <div>Stop: ${d.stop.toFixed(4)}</div>
            <div>TP (2xATR): ${d.tp.toFixed(4)}</div>
            <div>Storm比: ${d.stormRatio.toFixed(2)}</div>
            <div>最大收益率: ${d.profitRate.toFixed(2)}%</div>
        </div>
        `
    }
}

</script>
</body>
</html>
