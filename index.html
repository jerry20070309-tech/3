<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>⚡ TRIDENT V25 - LIQUIDATION FOCUS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #000; color: #e4e4e7; font-family: 'JetBrains Mono', monospace; }
        .card { background: #09090b; border: 1px solid #18181b; transition: all 0.5s ease; opacity: 0; transform: translateY(20px); }
        .card-show { opacity: 1; transform: translateY(0); } /* 只有量大的幣會浮現 */
        .liq-alert { border: 2px solid #ef4444 !important; background: #450a0a !important; animation: flash 0.5s infinite; }
        @keyframes flash { 0%, 100% { border-color: #ef4444; } 50% { border-color: #fff; } }
    </style>
</head>
<body class="p-6">

    <header class="flex justify-between items-center border-b border-zinc-800 pb-5 mb-6">
        <div>
            <h1 class="text-2xl font-black italic text-white tracking-tighter text-red-600">LIQUIDATOR V25</h1>
            <p class="text-[10px] text-zinc-500 uppercase mt-1">策略：縮量橫盤 ➔ 放量跌破前低 (清算多單)</p>
        </div>
        <button id="startBtn" onclick="ignite()" class="bg-zinc-900 text-white px-8 py-2 font-black rounded border border-zinc-700 hover:bg-red-700">掃描全市場</button>
    </header>

    <div id="monitorList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>

<script>
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','BNBUSDT']; 
    let baselineData = {}; 
    const VOL_TRIGGER = 1.2; // 量能開始比平均大 20% 就顯示在畫面上
    const LIQ_TRIGGER = 2.5; // 量能超過 2.5 倍且破低則觸發警告

    async function ignite() {
        document.getElementById('startBtn').innerText = "數據庫建立中...";
        const res = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
        const targets = (await res.json())
            .filter(s => s.symbol.endsWith('USDT') && !EXCLUDE.includes(s.symbol))
            .sort((a,b) => b.quoteVolume - a.quoteVolume).slice(0, 100);

        for(let i=0; i<targets.length; i+=5) {
            await Promise.all(targets.slice(i, i+5).map(async (t) => {
                const kRes = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${t.symbol}&interval=15m&limit=50`);
                const klines = await kRes.json();
                const lows = klines.map(k => parseFloat(k[3]));
                const volumes = klines.map(k => parseFloat(k[5]));
                baselineData[t.symbol] = {
                    support: Math.min(...lows), // 前低點
                    avgVol: volumes.reduce((a, b) => a + b, 0) / volumes.length
                };
            }));
            await new Promise(r => setTimeout(r, 300));
        }
        document.getElementById('startBtn').style.display = 'none';
        startStream();
    }

    function startStream() {
        const ws = new WebSocket(`wss://fstream.binance.com/ws/!ticker@arr`);
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            data.forEach(msg => {
                const s = msg.s;
                const base = baselineData[s];
                if(!base) return;

                const price = parseFloat(msg.c);
                const currentVol = parseFloat(msg.q) / 1440; // 24h量轉為每分鐘預估量 (更敏感)
                const volRatio = currentVol / (base.avgVol / 15); // 與 15m 均量做比較

                // 策略過濾：只有成交量開始變大的幣對才顯示 (二次過濾)
                const shouldShow = volRatio > VOL_TRIGGER;
                const isLiq = (price < base.support) && (volRatio > LIQ_TRIGGER);

                updateUI(s, price, volRatio, isLiq, shouldShow, base.support);
            });
        };
    }

    function updateUI(s, price, ratio, isLiq, shouldShow, support) {
        let el = document.getElementById(`card-${s}`);
        
        if (!shouldShow && !el) return; // 量不大且沒建立過卡片就不理它

        if (!el) {
            el = document.createElement('div');
            el.id = `card-${s}`;
            document.getElementById('monitorList').appendChild(el);
        }

        // 如果成交量縮小回去了，就隱藏它
        if (!shouldShow && !isLiq) {
            el.classList.remove('card-show');
            setTimeout(() => el.remove(), 500);
            return;
        }

        el.className = `card p-5 rounded-lg card-show ${isLiq ? 'liq-alert' : ''}`;
        el.innerHTML = `
            <div class="flex justify-between items-center mb-3">
                <span class="text-xl font-bold italic text-white">${s.replace('USDT','')}</span>
                <span class="text-[10px] bg-zinc-800 px-2 py-0.5 rounded text-zinc-400">VOL INCREASING</span>
            </div>
            <div class="space-y-2 text-[12px] font-mono">
                <div class="flex justify-between">
                    <span class="text-zinc-500">PRICE</span>
                    <span class="${price < support ? 'text-red-500 font-bold' : 'text-white'}">${price}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-zinc-500">PREV LOW</span>
                    <span class="text-zinc-400">${support.toFixed(4)}</span>
                </div>
                <div class="pt-3 border-t border-zinc-900 mt-2 flex justify-between items-end">
                    <div class="text-[10px] text-zinc-500">VOL MOMENTUM</div>
                    <div class="text-lg font-black ${ratio > LIQ_TRIGGER ? 'text-red-500' : 'text-blue-500'}">
                        ${ratio.toFixed(2)}x
                    </div>
                </div>
            </div>
        `;
    }
</script>
</body>
</html>
