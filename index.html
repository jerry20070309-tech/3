<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ SNIPER V16.5 | é›™å°åŒ…ç©©å®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { background: #050505; color: #FFD700; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .card { background: #0a0a0a; border: 1px solid #1a1a1a; transition: 0.3s; border-radius: 8px; min-height: 190px; }
        .tight-zone { border: 1px solid #3b82f6 !important; box-shadow: inset 0 0 15px #1e3a8a; }
        .monster-boost { animation: flash-red 0.5s infinite; border: 2px solid #ef4444 !important; }
        @keyframes flash-red { 0%, 100% { background: #0a0a0a; } 50% { background: #450a0a; } }
        .metric-box { background: rgba(15,15,15,0.9); border: 1px solid #222; padding: 4px; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col p-2 text-[10px]">

    <header class="p-3 border-b border-yellow-900 flex justify-between items-center bg-black">
        <h1 class="text-xl font-black text-yellow-500 italic uppercase">âš¡ SNIPER V16.5</h1>
        <div class="flex-1 max-w-md px-10">
            <input type="text" id="searchInput" placeholder="æœå°‹å¹£å..." class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-1 text-white uppercase">
        </div>
        <div id="apiStatus" class="text-green-500 font-bold uppercase tracking-widest">ç³»çµ±ç›£æ§ä¸­ | 418 é˜²è­·å·²é–‹å•Ÿ</div>
    </header>

    <div class="bg-zinc-900/50 p-2 border-b border-yellow-900/30 grid grid-cols-5 gap-4 uppercase font-bold text-zinc-400">
        <div>ğŸŒ€ SQZ(è“„å‹¢) <span id="v_sqz" class="text-yellow-500">1.2%</span><input type="range" id="i_sqz" min="5" max="50" value="12" class="w-full"></div>
        <div>ğŸ¯ POC(çªç ´) <span id="v_poc" class="text-green-400">1.1%</span><input type="range" id="i_poc" min="1" max="100" value="11" class="w-full"></div>
        <div>ğŸš¨ SLP(çªè®Š) <span id="v_slp" class="text-red-500">-15%</span><input type="range" id="i_slp" min="5" max="50" value="15" class="w-full"></div>
        <div>ğŸš€ DRV(çœŸç©º) <span id="v_drv" class="text-blue-400">90</span><input type="range" id="i_drv" min="10" max="150" value="90" class="w-full"></div>
        <div>âš¡ MOM(å‹•é‡) <span id="v_mom" class="text-orange-500">0.8%</span><input type="range" id="i_mom" min="1" max="50" value="8" class="w-full"></div>
    </div>

    <div class="flex flex-1 overflow-hidden gap-2 mt-2">
        <main class="flex-1 overflow-y-auto p-2" id="dashboard"></main>
        <aside class="w-80 border-l border-yellow-900 bg-zinc-950 flex flex-col">
            <div class="p-2 border-b border-zinc-800 text-red-500 font-bold uppercase">ğŸ›¡ï¸ å·¨é¯¨/æ¸…ç®—å¯¦æ™‚æµ</div>
            <div id="logBox" class="flex-1 overflow-y-auto p-2 space-y-1 text-[9px]"></div>
        </aside>
    </div>

<script>
    let isRunning = true, stats = {}, activeWS = new Map(), depthQueue = [];
    let FILTER = { SQZ: 0.012, POC: 0.011, SLP: -0.15, DRV: 90, MOM: 0.008 };
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(e => {
            const s = e.target.getAttribute('data-symbol');
            e.isIntersecting ? startWS(s) : stopWS(s);
        });
    }, { threshold: 0.1 });

    // [A-1] åˆä½µè«‹æ±‚ï¼Œé˜²æ­¢ 418
    async function fetchData() {
        try {
            const [tRes, pRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'),
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
            ]);
            if (tRes.status === 418) { document.getElementById('apiStatus').innerText="IP BLOCKED (418)"; return; }
            
            const tickers = await tRes.json();
            const premiums = await pRes.json();
            const pMap = Object.fromEntries(premiums.map(p => [p.symbol, p.lastFundingRate]));

            tickers.forEach(t => {
                if (!t.symbol.endsWith('USDT')) return;
                const s = t.symbol, p = parseFloat(t.lastPrice);
                
                // [C] äº”å¤§ç¶­åº¦ç®—åˆ†æ ¸å¿ƒ
                let score = 0;
                const sqz = (parseFloat(t.highPrice) - parseFloat(t.lowPrice)) / p;
                if (sqz <= FILTER.SQZ) score += 35;
                if (Math.abs(t.priceChangePercent) > 2) score += 25;
                
                if (!stats[s]) stats[s] = { s, score: 0, price: p, liq: 0, wall: 0, wallP: 0, funding: 0 };
                stats[s].price = p;
                stats[s].score = score;
                stats[s].funding = pMap[s] || 0;
                stats[s].isVacuum = (parseFloat(t.highPrice) - p) / p < 0.01;
            });
            render();
        } catch (e) {}
        setTimeout(fetchData, 3000);
    }

    // [A-2] å‹•æ…‹ WebSocket
    function startWS(s) {
        if (activeWS.has(s)) return;
        const ws = new WebSocket(`wss://fstream.binance.com/ws/${s.toLowerCase()}@aggTrade/${s.toLowerCase()}@forceOrder`);
        ws.onmessage = (e) => {
            const d = JSON.parse(e.data);
            if (d.e === "forceOrder") {
                const val = parseFloat(d.o.q) * parseFloat(d.o.p);
                stats[s].liq += val;
                addLog(`ğŸ’€ [æ¸…ç®—] ${s} $${(val/1000).toFixed(1)}K`, "text-red-500");
            }
        };
        activeWS.set(s, ws);
        // [A-3] åŠ å…¥æ›å–®ç‰†æ’éšŠ
        depthQueue.push(s);
    }

    function stopWS(s) {
        if (activeWS.has(s)) { activeWS.get(s).close(); activeWS.delete(s); }
    }

    // [A-3] æ›å–®ç‰†æ’éšŠè™•ç†å™¨ (æ¯ 500ms ä¸€å€‹ï¼Œçµ•å°ä¸å´©æ½°)
    setInterval(async () => {
        if (depthQueue.length === 0) return;
        const s = depthQueue.shift();
        try {
            const res = await fetch(`https://fapi.binance.com/fapi/v1/depth?symbol=${s}&limit=5`);
            const d = await res.json();
            const top = [...d.asks, ...d.bids].sort((a,b) => b[1]-a[1])[0];
            stats[s].wallP = top[0];
            stats[s].wall = top[0] * top[1];
        } catch(e){}
    }, 500);

    function render() {
        const container = document.getElementById('dashboard');
        const sorted = Object.values(stats).sort((a,b) => b.score - a.score).slice(0, 40);
        container.innerHTML = sorted.map(x => `
            <div class="card p-3 mb-2 inline-block w-[24%] m-[0.5%] ${x.score > 50 ? 'tight-zone' : ''}" data-symbol="${x.s}">
                <div class="flex justify-between font-black">
                    <span class="text-base text-white">${x.s}</span>
                    <span class="text-yellow-500">â˜… ${x.score}</span>
                </div>
                <div class="text-2xl font-black text-white my-1">$${x.price}</div>
                <div class="text-[8px] ${x.funding < 0 ? 'text-red-500' : 'text-green-500'} mb-2">FUNDING: ${(x.funding*100).toFixed(4)}%</div>
                <div class="grid grid-cols-2 gap-1">
                    <div class="metric-box"><span class="block text-zinc-600">WALL</span><span class="text-blue-400 font-bold">$${parseFloat(x.wallP).toFixed(2)}</span></div>
                    <div class="metric-box"><span class="block text-zinc-600">LIQ</span><span class="text-red-500 font-bold">$${(x.liq/1000).toFixed(1)}K</span></div>
                </div>
                ${x.isVacuum ? '<div class="mt-2 text-center bg-blue-900 text-white font-bold py-1 rounded">VACUUM ZONE</div>' : ''}
            </div>
        `).join('');
        document.querySelectorAll('.card').forEach(c => observer.observe(c));
    }

    function addLog(m, c) {
        const b = document.getElementById('logBox');
        const d = document.createElement('div');
        d.className = `p-1 border-b border-zinc-900 ${c}`;
        d.innerHTML = `[${new Date().toLocaleTimeString()}] ${m}`;
        b.prepend(d);
        if(b.childNodes.length > 30) b.removeChild(b.lastChild);
    }

    fetchData();
</script>
</body>
</html>
